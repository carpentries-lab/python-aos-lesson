<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Python for Atmosphere and Ocean Scientists: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md top-nav carpentries"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="cp-logo" alt="The Carpentries" src="assets/images/carpentries-logo.svg">
</div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
<li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul>
</li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav carpentries" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="The Carpentries" src="assets/images/carpentries-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Python for Atmosphere and Ocean Scientists
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Python for Atmosphere and Ocean Scientists
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<li><a class="dropdown-item" href="reference.html">Glossary</a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Python for Atmosphere and Ocean Scientists
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress carpentries">
    <div class="progress-bar carpentries" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text">
<li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul>
</li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-conda.html">1. Package management</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-visualisation.html">2. Data processing and visualisation</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-functions.html">3. Functions</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-cmdline.html">4. Command line programs</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-git.html">5. Version control</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-github.html">6. GitHub</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="07-vectorisation.html">7. Vectorisation</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="08-defensive.html">8. Defensive programming</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="09-provenance.html">9. Data provenance</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="10-large-data.html">10. Large data</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Glossary</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-conda"><p>Content from <a href="01-conda.html">Package management</a></p>
<hr>
<p>Last updated on 2024-07-25 |

        <a href="https://github.com/fishtree-attempt/python-aos-lesson/edit/main/episodes/01-conda.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What are the main Python libraries used in atmosphere and ocean
science?</li>
<li>How do I install and manage all the Python libraries that I want to
use?</li>
<li>How do I interact with Python?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Identify the main Python libraries used in atmosphere and ocean
science and the relationships between them.</li>
<li>Explain the advantages of Anaconda over other Python
distributions.</li>
<li>Extend the number of packages available via conda using
conda-forge.</li>
<li>Create a conda environment with the libraries needed for these
lessons.</li>
<li>Open a Jupyter Notebook ready for use in these lessons</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="the-pyaos-stack">The PyAOS stack<a class="anchor" aria-label="anchor" href="#the-pyaos-stack"></a>
<a class="anchor" aria-label="anchor" href="#the-pyaos-stack"></a>
</h2>
<hr class="half-width">
<p>Before we jump in and start analysing our netCDF precipitation data
files, we need to consider what Python libraries are best suited to the
task.</p>
<p>For reading, writing and analysing data stored in the netCDF file
format, atmosphere and ocean scientists will typically do most of their
work with either the <a href="https://xarray.pydata.org/en/stable/" class="external-link">xarray</a> or <a href="https://scitools.org.uk/iris/" class="external-link">iris</a> libraries. These libraries
are built on top of more generic data science libraries like numpy and
matplotlib, to make the types of analysis we do faster and more
efficient. To learn more about the PyAOS “stack” shown in the diagram
below (i.e. the collection of libraries that are typically used for data
analysis and visualisation in the atmosphere and ocean sciences), check
out the <a href="https://pyaos.github.io/stack/" class="external-link">overview of the PyAOS
stack</a> at the PyAOS community site.</p>
<figure><img src="fig/01-pyaos-stack.svg" alt="PyAOS stack" class="figure mx-auto d-block"></figure></section><section><h2 class="section-heading" id="python-distributions-for-data-science">Python distributions for data science<a class="anchor" aria-label="anchor" href="#python-distributions-for-data-science"></a>
<a class="anchor" aria-label="anchor" href="#python-distributions-for-data-science"></a>
</h2>
<hr class="half-width">
<p>Now that we’ve identified the Python libraries we might want to use,
how do we go about installing them?</p>
<p>Our first impulse might be to use the Python package installer (pip),
but it really only works for libraries written in pure Python. This is a
major limitation for the data science community, because many scientific
Python libraries have C and/or Fortran dependencies. To spare people the
pain of installing these dependencies, a number of scientific Python
“distributions” have been released over the years. These come with the
most popular data science libraries and their dependencies
pre-installed, and some also come with a package manager to assist with
installing additional libraries that weren’t pre-installed. Today the
most popular distribution for data science is <a href="https://www.anaconda.com/distribution/" class="external-link">Anaconda</a>, which comes
with a package (and environment) manager called <a href="https://conda.io/docs/" class="external-link">conda</a>.</p>
</section><section><h2 class="section-heading" id="introducing-conda">Introducing conda<a class="anchor" aria-label="anchor" href="#introducing-conda"></a>
<a class="anchor" aria-label="anchor" href="#introducing-conda"></a>
</h2>
<hr class="half-width">
<p>According to the <a href="https://docs.anaconda.com/anaconda/#anaconda-navigator-or-conda" class="external-link">latest
documentation</a>, Anaconda comes with over 250 of the most widely used
data science libraries (and their dependencies) pre-installed. In
addition, there are several thousand more libraries available via the
<code>conda install</code> command, which can be executed using the Bash
Shell or Anaconda Prompt (Windows only). It is also possible to install
packages using the Anaconda Navigator graphical user interface.</p>
<div id="conda-in-the-shell-on-windows" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="conda-in-the-shell-on-windows" class="callout-inner">
<h3 class="callout-title">conda in the shell on windows<a class="anchor" aria-label="anchor" href="#conda-in-the-shell-on-windows"></a>
</h3>
<div class="callout-content">
<p>If you’re on a Windows machine and the <code>conda</code> command
isn’t available at the Bash Shell, you’ll need to open the Anaconda
Prompt program (via the Windows start menu) and run the command
<code>conda init bash</code> (this only needs to be done once). After
that, your Bash Shell will be configured to use <code>conda</code> going
forward.</p>
</div>
</div>
</div>
<p>For instance, the popular <code>xarray</code> library could be
installed using the following command,</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">$</span> conda install xarray</span></code></pre>
</div>
<p>(Use <code>conda search -f {package_name}</code> to find out if a
package you want is available.)</p>
<p>OR using Anaconda Navigator:</p>
<figure><img src="fig/01-navigator-xarray.png" alt="Anaconda Navigator xarray search" class="figure mx-auto d-block"></figure><div id="miniconda" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="miniconda" class="callout-inner">
<h3 class="callout-title">Miniconda<a class="anchor" aria-label="anchor" href="#miniconda"></a>
</h3>
<div class="callout-content">
<p>If you don’t want to install the entire Anaconda distribution, you
can install <a href="https://conda.pydata.org/miniconda.html" class="external-link">Miniconda</a> instead. It
essentially comes with conda and nothing else.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="advanced-conda">Advanced conda<a class="anchor" aria-label="anchor" href="#advanced-conda"></a>
<a class="anchor" aria-label="anchor" href="#advanced-conda"></a>
</h2>
<hr class="half-width">
<p>For a relatively small/niche field of research like atmosphere and
ocean science, one of the most important features that Anaconda provides
is the <a href="https://anaconda.org" class="external-link">Anaconda Cloud</a> website, where
the community can contribute conda installation packages. This is
critical because many of our libraries have a small user base, which
means they’ll never make it into the top few thousand data science
libraries supported by Anaconda.</p>
<p>You can search Anaconda Cloud to find the command needed to install
the package. For instance, here is the search result for the
<code>iris</code> package:</p>
<figure><img src="fig/01-iris-search.png" alt="Iris search on Anaconda Cloud" class="figure mx-auto d-block"></figure><p>As you can see, there are often multiple versions of the same package
up on Anaconda Cloud. To try and address this duplication problem, <a href="https://conda-forge.github.io/" class="external-link">conda-forge</a> has been launched,
which aims to be a central repository that contains just a single
(working) version of each package on Anaconda Cloud. You can therefore
expand the selection of packages available via
<code>conda install</code> beyond the chosen few thousand by adding the
conda-forge channel:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">$</span> conda config <span class="at">--add</span> channels conda-forge</span></code></pre>
</div>
<p>OR</p>
<figure><img src="fig/01-navigator-conda-forge.png" alt="Anaconda Navigator conda-forge" class="figure mx-auto d-block"></figure><p>We recommend not adding any other third-party channels unless
absolutely necessary, because mixing packages from multiple channels can
cause headaches like binary incompatibilities.</p>
</section><section><h2 class="section-heading" id="software-installation-for-these-lessons">Software installation for these lessons<a class="anchor" aria-label="anchor" href="#software-installation-for-these-lessons"></a>
<a class="anchor" aria-label="anchor" href="#software-installation-for-these-lessons"></a>
</h2>
<hr class="half-width">
<p>For these particular lessons we will use <code>xarray</code>, but all
the same tasks could be performed with <code>iris</code>. We’ll also
install <a href="https://dask.org/" class="external-link"><code>dask</code></a>
(<code>xarray</code> uses this for parallel processing), <a href="https://unidata.github.io/netcdf4-python/" class="external-link"><code>netCDF4</code></a>
(<code>xarray</code> requires this to read netCDF files), <a href="https://scitools.org.uk/cartopy/" class="external-link"><code>cartopy</code></a> (to
help with geographic plot projections), <a href="https://matplotlib.org/cmocean/" class="external-link"><code>cmocean</code></a> (for
nice color palettes) and <a href="https://cmdline-provenance.readthedocs.io/en/latest/" class="external-link"><code>cmdline_provenance</code></a>
(to keep track of our data processing steps). We don’t need to worry
about installing <a href="https://jupyter.org/" class="external-link">jupyter</a> (we will be
using the jupyter notebook) because it already comes pre-installed with
Anaconda.</p>
<p>We could install these libraries from Anaconda Navigator (not shown)
or using the Bash Shell or Anaconda Prompt (Windows):</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">$</span> conda install xarray dask netCDF4 cartopy cmocean cmdline_provenance</span></code></pre>
</div>
<p>If we then list all the libraries that we’ve got installed, we can
see that <code>jupyter</code>, <code>dask</code>, <code>xarray</code>,
<code>netCDF4</code>, <code>cartopy</code>, <code>cmocean</code>,
<code>cmdline_provenance</code> and their dependencies are now
there:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">$</span> conda list</span></code></pre>
</div>
<p>(This list can also be viewed in the environments tab of the
Navigator.)</p>
<div id="creating-separate-environments" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="creating-separate-environments" class="callout-inner">
<h3 class="callout-title">Creating separate environments<a class="anchor" aria-label="anchor" href="#creating-separate-environments"></a>
</h3>
<div class="callout-content">
<p>If you’ve got multiple data science projects on the go, installing
all your packages in the same conda environment can get a little messy.
(By default they are installed in the root/base environment.) It’s
therefore common practice to <a href="https://conda.io/docs/user-guide/tasks/manage-environments.html" class="external-link">create
separate conda environments</a> for the various projects you’re working
on.</p>
<p>For instance, we could create an environment called
<code>pyaos-lesson</code> for this lesson. The process of creating a new
environment can be managed in the environments tab of the Anaconda
Navigator or via the following Bash Shell / Anaconda Prompt
commands:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">$</span> conda create <span class="at">-n</span> pyaos-lesson jupyter xarray dask netCDF4 cartopy cmocean cmdline_provenance</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="ex">$</span> conda activate pyaos-lesson</span></code></pre>
</div>
<p>(it’s <code>conda deactivate</code> to exit)</p>
<p>Notice that in this case we had to include jupyter in the list of
packages to install. When you create a brand new conda environment, it
doesn’t automatically come with the pre-installed packages that are in
the base environment.</p>
<p>You can have lots of different environments,</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">$</span> conda info <span class="at">--envs</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># conda environments:
#
base                  *  /anaconda3
pyaos-lesson             /anaconda3/envs/pyaos-lesson
test                     /anaconda3/envs/test</code></pre>
</div>
<p>the details of which can be exported to a YAML configuration
file:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">$</span> conda env export <span class="at">-n</span> pyaos-lesson <span class="at">-f</span> pyaos-lesson.yml</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="ex">$</span> cat pyaos-lesson.yml</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>name: pyaos-lesson
channels:
  - conda-forge
  - defaults
dependencies:
  - cartopy=0.16.0=py36h81b52dc_1
  - certifi=2018.4.16=py36_0
  - cftime=1.0.1=py36h7eb728f_0
  - ...</code></pre>
</div>
<p>Other people (or you on a different computer) can then re-create that
exact environment using the YAML file:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">$</span> conda env create <span class="at">-f</span> pyaos-lesson.yml</span></code></pre>
</div>
<p>For ease of sharing the YAML file, it can be uploaded to your account
at the Anaconda Cloud website,</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">$</span> conda env upload <span class="at">-f</span> pyaos-lesson.yml</span></code></pre>
</div>
<p>so that others can re-create the environment by simply refering to
your Anaconda username:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">$</span> conda env create damienirving/pyaos-lesson</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="ex">$</span> conda activate pyaos-lesson</span></code></pre>
</div>
<p>The ease with which others can recreate your environment (on any
operating system) is a huge breakthough for reproducible research.</p>
<p>To delete the environment:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="ex">$</span> conda env remove <span class="at">-n</span> pyaos-lesson</span></code></pre>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="interacting-with-python">Interacting with Python<a class="anchor" aria-label="anchor" href="#interacting-with-python"></a>
<a class="anchor" aria-label="anchor" href="#interacting-with-python"></a>
</h2>
<hr class="half-width">
<p>Now that we know which Python libraries we want to use and how to
install them, we need to decide how we want to interact with Python.</p>
<p>The most simple way to use Python is to type code directly into the
interpreter. This can be accessed from the bash shell:</p>
<pre><code>$ python
Python 3.7.1 (default, Dec 14 2018, 13:28:58)
[Clang 4.0.1 (tags/RELEASE_401/final)] :: Anaconda, Inc. on darwin
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; print("hello world")
hello world
&gt;&gt;&gt; exit()
$</code></pre>
<p>The <code>&gt;&gt;&gt;</code> prompt indicates that you are now
talking to the Python interpreter.</p>
<p>A more powerful alternative to the default Python interpreter is
IPython (Interactive Python). The <a href="https://ipython.readthedocs.io/en/stable/" class="external-link">online
documentation</a> outlines all the special features that come with
IPython, but as an example, it lets you execute bash shell commands
without having to exit the IPython interpreter:</p>
<pre><code>$ ipython
Python 3.7.1 (default, Dec 14 2018, 13:28:58)
Type 'copyright', 'credits' or 'license' for more information
IPython 7.2.0 -- An enhanced Interactive Python. Type '?' for help.

In [1]: print("hello world")
hello world

In [2]: ls
data/                              script_template.py
plot_precipitation_climatology.py

In [3]: exit
$ </code></pre>
<p>(The IPython interpreter can also be accessed via the Anaconda
Navigator by running the QtConsole.)</p>
<p>While entering commands to the Python or IPython interpreter
line-by-line is great for quickly testing something, it’s clearly
impractical for developing longer bodies of code and/or interactively
exploring data. As such, Python users tend to do most of their code
development and data exploration using either an Integrated Development
Environment (IDE) or Jupyter Notebook:</p>
<ul>
<li>Two of the most common IDEs are <a href="https://www.spyder-ide.org/" class="external-link">Spyder</a> and <a href="https://www.jetbrains.com/pycharm/" class="external-link">PyCharm</a> (the former comes
with Anaconda) and will look very familiar to anyone who has used MATLAB
or R-Studio.</li>
<li>
<a href="https://jupyter.org/" class="external-link">Jupyter Notebooks</a> run in your web
browser and allow users to create and share documents that contain live
code, equations, visualizations and narrative text.</li>
</ul>
<p>We are going to use the Jupyter Notebook to explore our precipitation
data (and the plotting functionality of xarray) in the next few lessons.
A notebook can be launched from our <code>data-carpentry</code>
directory using the Bash Shell:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="ex">$</span> cd ~/Desktop/data-carpentry</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="ex">$</span> jupyter notebook <span class="kw">&amp;</span></span></code></pre>
</div>
<p>(The <code>&amp;</code> allows you to come back and use the bash
shell without closing your notebook first.)</p>
<p>Alternatively, you can launch Jupyter Notebook from the Anaconda
Navigator and navigate to the <code>data-carpentry</code> directory
before creating a new Python 3 notebook:</p>
<figure><img src="fig/01-launch-notebook.png" alt="Launch Jupyter notebook" class="figure mx-auto d-block"></figure><div id="jupyterlab" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="jupyterlab" class="callout-inner">
<h3 class="callout-title">JupyterLab<a class="anchor" aria-label="anchor" href="#jupyterlab"></a>
</h3>
<div class="callout-content">
<p>The Jupyter team have recently launched <a href="https://blog.jupyter.org/jupyterlab-is-ready-for-users-5a6f039b8906" class="external-link">JupyterLab</a>
which combines the Jupyter Notebook with many of the features common to
an IDE.</p>
</div>
</div>
</div>
<div id="install-the-python-libraries-required-for-this-lesson" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="install-the-python-libraries-required-for-this-lesson" class="callout-inner">
<h3 class="callout-title">Install the Python libraries required for this lesson<a class="anchor" aria-label="anchor" href="#install-the-python-libraries-required-for-this-lesson"></a>
</h3>
<div class="callout-content">
<p>If you haven’t already done so, go ahead and install the
<code>xarray</code>, <code>dask</code>, <code>netCDF4</code>,
<code>cartopy</code>, <code>cmocean</code> and
<code>cmdline_provenance</code> packages using either the Anaconda
Navigator or Bash Shell.</p>
<p>Remember that you’ll need to add the conda-forge channel first.</p>
<p>(You may like to create a separate <code>pyaos-lesson</code> conda
environment, but this is not necessary to complete the lessons. If you
create a new environment rather than using the base environment, you’ll
need to install jupyter too.)</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>The <a href="https://carpentries-lab.github.io/python-aos-lesson/setup.html" class="external-link">setup
menu</a> at the top of the page contains drop-down boxes explaining how
to install the Python libraries using the Bash Shell or Anaconda
Navigator.</p>
</div>
</div>
</div>
</div>
<div id="launch-a-jupyer-notebook" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="launch-a-jupyer-notebook" class="callout-inner">
<h3 class="callout-title">Launch a Jupyer Notebook<a class="anchor" aria-label="anchor" href="#launch-a-jupyer-notebook"></a>
</h3>
<div class="callout-content">
<p>In preparation for the next lesson, open a new Jupyter Notebook
<strong>in your <code>data-carpentry</code> directory</strong> by
entering <code>jupyter notebook &amp;</code> at the Bash Shell or by
clicking the Jupyter Notebook launch button in the Anaconda
Navigator.</p>
<p>If you use the Navigator, the Jupyter interface will open in a new
tab of your default web browser. Use that interface to navigate to the
<code>data-carpentry</code> directory that you created specifically for
these lessons before clicking to create a new Python 3 notebook:</p>
<figure><img src="fig/01-launch-notebook.png" alt="Launch Jupyter notebook" class="figure mx-auto d-block"></figure><p>Once your notebook is open, import <code>xarray</code>,
<code>catropy</code>, <code>matplotlib</code> and <code>numpy</code>
using the following Python commands:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code></pre>
</div>
<p>(Hint: Hold down the shift and return keys to execute a code cell in
a Jupyter Notebook.)</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>xarray and iris are the core Python libraries used in the atmosphere
and ocean sciences.</li>
<li>Use conda to install and manage your Python environments.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-02-visualisation"><p>Content from <a href="02-visualisation.html">Data processing and visualisation</a></p>
<hr>
<p>Last updated on 2024-07-25 |

        <a href="https://github.com/fishtree-attempt/python-aos-lesson/edit/main/episodes/02-visualisation.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I create a quick plot of my CMIP data?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Import the xarray library and use the functions it contains.</li>
<li>Convert precipitation units to mm/day.</li>
<li>Calculate and plot the precipitation climatology.</li>
<li>Use the cmocean library to find colormaps designed for ocean
science.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>As a first step towards making a visual comparison of the ACCESS-CM2
and ACCESS-ESM1-5 historical precipitation climatology, we are going to
create a quick plot of the ACCESS-CM2 data.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>accesscm2_pr_file <span class="op">=</span> <span class="st">"data/pr_Amon_ACCESS-CM2_historical_r1i1p1f1_gn_201001-201412.nc"</span></span></code></pre>
</div>
<p>We will need a number of the libraries introduced in the previous
lesson.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code></pre>
</div>
<p>Since geographic data files can often be very large, when we first
open our data file in xarray it simply loads the metadata associated
with the file (this is known as “lazy loading”). We can then view
summary information about the contents of the file before deciding
whether we’d like to load some or all of the data into memory.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>ds <span class="op">=</span> xr.open_dataset(accesscm2_pr_file)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="bu">print</span>(ds)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;xarray.Dataset&gt;
Dimensions:    (bnds: 2, lat: 144, lon: 192, time: 60)
Coordinates:
  * time       (time) datetime64[ns] 2010-01-16T12:00:00 ... 2014-12-16T12:00:00
  * lon        (lon) float64 0.9375 2.812 4.688 6.562 ... 355.3 357.2 359.1
  * lat        (lat) float64 -89.38 -88.12 -86.88 -85.62 ... 86.88 88.12 89.38
Dimensions without coordinates: bnds
Data variables:
    time_bnds  (time, bnds) datetime64[ns] ...
    lon_bnds   (lon, bnds) float64 ...
    lat_bnds   (lat, bnds) float64 ...
    pr         (time, lat, lon) float32 ...
Attributes:
    CDI:                    Climate Data Interface version 1.9.8 (https://mpi...
    source:                 ACCESS-CM2 (2019): \naerosol: UKCA-GLOMAP-mode\na...
    institution:            CSIRO (Commonwealth Scientific and Industrial Res...
    Conventions:            CF-1.7 CMIP-6.2
    activity_id:            CMIP
    branch_method:          standard
    branch_time_in_child:   0.0
    branch_time_in_parent:  0.0
    creation_date:          2019-11-08T08:26:37Z
    data_specs_version:     01.00.30
    experiment:             all-forcing simulation of the recent past
    experiment_id:          historical
    external_variables:     areacella
    forcing_index:          1
    frequency:              mon
    further_info_url:       https://furtherinfo.es-doc.org/CMIP6.CSIRO-ARCCSS...
    grid:                   native atmosphere N96 grid (144x192 latxlon)
    grid_label:             gn
    initialization_index:   1
    institution_id:         CSIRO-ARCCSS
    mip_era:                CMIP6
    nominal_resolution:     250 km
    notes:                  Exp: CM2-historical; Local ID: bj594; Variable: p...
    parent_activity_id:     CMIP
    parent_experiment_id:   piControl
    parent_mip_era:         CMIP6
    parent_source_id:       ACCESS-CM2
    parent_time_units:      days since 0950-01-01
    parent_variant_label:   r1i1p1f1
    physics_index:          1
    product:                model-output
    realization_index:      1
    realm:                  atmos
    run_variant:            forcing: GHG, Oz, SA, Sl, Vl, BC, OC, (GHG = CO2,...
    source_id:              ACCESS-CM2
    source_type:            AOGCM
    sub_experiment:         none
    sub_experiment_id:      none
    table_id:               Amon
    table_info:             Creation Date:(30 April 2019) MD5:e14f55f257cceaf...
    title:                  ACCESS-CM2 output prepared for CMIP6
    variable_id:            pr
    variant_label:          r1i1p1f1
    version:                v20191108
    cmor_version:           3.4.0
    tracking_id:            hdl:21.14100/b4dd0f13-6073-4d10-b4e6-7d7a4401e37d
    license:                CMIP6 model data produced by CSIRO is licensed un...
    CDO:                    Climate Data Operators version 1.9.8 (https://mpi...
    history:                Tue Jan 12 14:50:25 2021: ncatted -O -a history,p...
    NCO:                    netCDF Operators version 4.9.2 (Homepage = http:/...</code></pre>
</div>
<p>We can see that our <code>ds</code> object is an
<code>xarray.Dataset</code>, which when printed shows all the metadata
associated with our netCDF data file.</p>
<p>In this case, we are interested in the precipitation variable
contained within that xarray Dataset:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="bu">print</span>(ds[<span class="st">"pr"</span>])</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;xarray.DataArray 'pr' (time: 60, lat: 144, lon: 192)&gt;
[1658880 values with dtype=float32]
Coordinates:
  * time     (time) datetime64[ns] 2010-01-16T12:00:00 ... 2014-12-16T12:00:00
  * lon      (lon) float64 0.9375 2.812 4.688 6.562 ... 353.4 355.3 357.2 359.1
  * lat      (lat) float64 -89.38 -88.12 -86.88 -85.62 ... 86.88 88.12 89.38
Attributes:
    standard_name:  precipitation_flux
    long_name:      Precipitation
    units:          kg m-2 s-1
    comment:        includes both liquid and solid phases
    cell_methods:   area: time: mean
    cell_measures:  area: areacella</code></pre>
</div>
<p>We can actually use either the <code>ds["pr"]</code> or
<code>ds.pr</code> syntax to access the precipitation
<code>xarray.DataArray</code>.</p>
<p>To calculate the precipitation climatology, we can make use of the
fact that xarray DataArrays have built in functionality for averaging
over their dimensions.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>clim <span class="op">=</span> ds[<span class="st">"pr"</span>].mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="bu">print</span>(clim)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;xarray.DataArray 'pr' (lat: 144, lon: 192)&gt;
array([[1.8461452e-06, 1.9054805e-06, 1.9228980e-06, ..., 1.9869783e-06,
        2.0026005e-06, 1.9683730e-06],
       [1.9064508e-06, 1.9021350e-06, 1.8931637e-06, ..., 1.9433096e-06,
        1.9182237e-06, 1.9072245e-06],
       [2.1003202e-06, 2.0477617e-06, 2.0348527e-06, ..., 2.2391034e-06,
        2.1970161e-06, 2.1641599e-06],
       ...,
       [7.5109556e-06, 7.4777777e-06, 7.4689174e-06, ..., 7.3359679e-06,
        7.3987890e-06, 7.3978440e-06],
       [7.1837171e-06, 7.1722038e-06, 7.1926393e-06, ..., 7.1552149e-06,
        7.1576678e-06, 7.1592167e-06],
       [7.0353467e-06, 7.0403985e-06, 7.0326828e-06, ..., 7.0392648e-06,
        7.0387587e-06, 7.0304386e-06]], dtype=float32)
Coordinates:
  * lon      (lon) float64 0.9375 2.812 4.688 6.562 ... 353.4 355.3 357.2 359.1
  * lat      (lat) float64 -89.38 -88.12 -86.88 -85.62 ... 86.88 88.12 89.38
Attributes:
    standard_name:  precipitation_flux
    long_name:      Precipitation
    units:          kg m-2 s-1
    comment:        includes both liquid and solid phases
    cell_methods:   area: time: mean
    cell_measures:  area: areacella</code></pre>
</div>
<p>Now that we’ve calculated the climatology, we want to convert the
units from kg m-2 s-1 to something that we are a little more familiar
with like mm day-1.</p>
<p>To do this, consider that 1 kg of rain water spread over 1 m2 of
surface is 1 mm in thickness and that there are 86400 seconds in one
day. Therefore, 1 kg m-2 s-1 = 86400 mm day-1.</p>
<p>The data associated with our xarray DataArray is simply a numpy
array,</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="bu">type</span>(clim.data)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">numpy.ndarray</span></span></code></pre>
</div>
<p>so we can go ahead and multiply that array by 86400 and update the
units attribute accordingly:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>clim.data <span class="op">=</span> clim.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>clim.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="bu">print</span>(clim)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;xarray.DataArray 'pr' (lat: 144, lon: 192)&gt;
array([[0.15950695, 0.16463352, 0.16613839, ..., 0.17167493, 0.17302468,
        0.17006743],
       [0.16471735, 0.16434446, 0.16356934, ..., 0.16790195, 0.16573453,
        0.1647842 ],
       [0.18146767, 0.17692661, 0.17581128, ..., 0.19345854, 0.18982219,
        0.18698342],
       ...,
       [0.64894656, 0.64607999, 0.64531446, ..., 0.63382763, 0.63925537,
        0.63917372],
       [0.62067316, 0.61967841, 0.62144403, ..., 0.61821057, 0.6184225 ,
        0.61855632],
       [0.60785395, 0.60829043, 0.60762379, ..., 0.60819248, 0.60814875,
        0.6074299 ]])
Coordinates:
  * lon      (lon) float64 0.9375 2.812 4.688 6.562 ... 353.4 355.3 357.2 359.1
  * lat      (lat) float64 -89.38 -88.12 -86.88 -85.62 ... 86.88 88.12 89.38
Attributes:
    standard_name:  precipitation_flux
    long_name:      Precipitation
    units:          mm/day
    comment:        includes both liquid and solid phases
    cell_methods:   area: time: mean
    cell_measures:  area: areacella</code></pre>
</div>
<p>We could now go ahead and plot our climatology using matplotlib, but
it would take many lines of code to extract all the latitude and
longitude information and to setup all the plot characteristics.
Recognising this burden, the xarray developers have built on top of
<code>matplotlib.pyplot</code> to make the visualisation of xarray
DataArrays much easier.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>clim.plot.contourf(</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    levels<span class="op">=</span>np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>),</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    extend<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>    cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: clim.units}</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>)</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>ax.coastlines()</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>plt.show()</span></code></pre>
</div>
<figure><img src="fig/02-visualisation-viridis.png" alt="Precipitation climatology" class="figure mx-auto d-block"></figure><p>The default colorbar used by matplotlib is <code>viridis</code>. It
used to be <code>jet</code>, but that was changed a couple of years ago
in response to the <a href="https://www.climate-lab-book.ac.uk/2014/end-of-the-rainbow/" class="external-link">#endtherainbow</a>
campaign.</p>
<p>Putting all the code together (and reversing viridis so that wet is
purple and dry is yellow)…</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>accesscm2_pr_file <span class="op">=</span> <span class="st">"data/pr_Amon_ACCESS-CM2_historical_r1i1p1f1_gn_201001-201412.nc"</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>ds <span class="op">=</span> xr.open_dataset(accesscm2_pr_file)</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>clim <span class="op">=</span> ds[<span class="st">"pr"</span>].mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>clim.data <span class="op">=</span> clim.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>clim.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>clim.plot.contourf(</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>    levels<span class="op">=</span>np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>),</span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>    extend<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>    transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>    cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: clim.units},</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"viridis_r"</span>,</span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>)</span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a>ax.coastlines()</span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a>plt.show()</span></code></pre>
</div>
<figure><img src="fig/02-visualisation-viridis_r.png" alt="Precipitation climatology" class="figure mx-auto d-block"></figure><div id="color-palette" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="color-palette" class="callout-inner">
<h3 class="callout-title">Color palette<a class="anchor" aria-label="anchor" href="#color-palette"></a>
</h3>
<div class="callout-content">
<p>Copy and paste the final slab of code above into your own Jupyter
notebook.</p>
<p>The viridis color palette doesn’t seem quite right for rainfall.
Change it to the “haline” <a href="https://matplotlib.org/cmocean/" class="external-link">cmocean</a> palette used for
ocean salinity data.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="im">import</span> cmocean</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a> </span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>...</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>clim.plot.contourf(</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    ...</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>    cmap<span class="op">=</span>cmocean.cm.haline_r,</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="season-selection" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="season-selection" class="callout-inner">
<h3 class="callout-title">Season selection<a class="anchor" aria-label="anchor" href="#season-selection"></a>
</h3>
<div class="callout-content">
<p>Rather than plot the annual climatology, edit the code so that it
plots the June-August (JJA) season.</p>
<p>(Hint: the <a href="">groupby</a> functionality can be used to group
all the data into seasons prior to averaging over the time axis)</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>clim.data <span class="op">=</span> clim.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>clim.attrs[<span class="st">'units'</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>clim.sel(season<span class="op">=</span><span class="st">"JJA"</span>).plot.contourf(</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>    ...</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="add-a-title" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="add-a-title" class="callout-inner">
<h3 class="callout-title">Add a title<a class="anchor" aria-label="anchor" href="#add-a-title"></a>
</h3>
<div class="callout-content">
<p>Add a title to the plot which gives the name of the model (taken from
the <code>ds</code> attributes) followed by the words “precipitation
climatology (JJA)”</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>model <span class="op">=</span> ds.attrs[<span class="st">"source_id"</span>]</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>title <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss"> precipitation climatology (JJA)"</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>plt.title(title)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Libraries such as xarray can make loading, processing and
visualising netCDF data much easier.</li>
<li>The cmocean library contains colormaps custom made for the ocean
sciences.</li>
</ul>
</div>
</div>
</div></section><section id="aio-03-functions"><p>Content from <a href="03-functions.html">Functions</a></p>
<hr>
<p>Last updated on 2024-07-25 |

        <a href="https://github.com/fishtree-attempt/python-aos-lesson/edit/main/episodes/03-functions.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I define my own functions?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Define a function that takes parameters.</li>
<li>Use docstrings to document functions.</li>
<li>Break our existing plotting code into a series of small,
single-purpose functions.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>In the previous lesson we created a plot of the ACCESS-CM2 historical
precipitation climatology using the following commands:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="im">import</span> cmocean</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>accesscm2_pr_file <span class="op">=</span> <span class="st">"data/pr_Amon_ACCESS-CM2_historical_r1i1p1f1_gn_201001-201412.nc"</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>ds <span class="op">=</span> xr.open_dataset(accesscm2_pr_file)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>clim.data <span class="op">=</span> clim.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>clim.attrs[<span class="st">'units'</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>clim.sel(season<span class="op">=</span><span class="st">"JJA"</span>).plot.contourf(</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>    levels<span class="op">=</span>np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>),</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>    extend<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>    transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>    cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: clim.units},</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>    cmap<span class="op">=</span>cmocean.cm.haline_r,</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>)</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>ax.coastlines()</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>model <span class="op">=</span> ds.attrs[<span class="st">"source_id"</span>]</span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a>title <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss"> precipitation climatology (JJA)"</span></span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a>plt.title(title)</span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a>plt.show()</span></code></pre>
</div>
<figure><img src="fig/03-functions-accesscm2-jja.png" alt="Precipitation climatology" class="figure mx-auto d-block"></figure><p>If we wanted to create a similar plot for a different model and/or
different month, we could cut and paste the code and edit accordingly.
The problem with that (common) approach is that it increases the chances
of a making a mistake. If we manually updated the season to ‘DJF’ for
the <code>clim.sel(season=</code> command but forgot to update it when
calling <code>plt.title</code>, for instance, we’d have a mismatch
between the data and title.</p>
<p>The cut and paste approach is also much more time consuming. If we
think of a better way to create this plot in future (e.g. we might want
to add gridlines using <code>plt.gca().gridlines()</code>), then we have
to find and update every copy and pasted instance of the code.</p>
<p>A better approach is to put the code in a function. The code itself
then remains untouched, and we simply call the function with different
input arguments.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">def</span> plot_pr_climatology(pr_file, season, gridlines<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    <span class="co">"""Plot the precipitation climatology.</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">      pr_file (str): Precipitation data file</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">      season (str): Season (3 letter abbreviation, e.g. JJA)</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co">      gridlines (bool): Select whether to plot gridlines</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(pr_file)</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>    clim.data <span class="op">=</span> clim.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>    clim.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    clim.sel(season<span class="op">=</span>season).plot.contourf(</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>        levels<span class="op">=</span>np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>),</span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>        extend<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>        transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>        cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: clim.units},</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>        cmap<span class="op">=</span>cmocean.cm.haline_r,</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>    )</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>    ax.coastlines()</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>    <span class="cf">if</span> gridlines:</span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a>        plt.gca().gridlines()</span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a>    </span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a>    model <span class="op">=</span> ds.attrs[<span class="st">"source_id"</span>]</span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a>    title <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss"> precipitation climatology (</span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>    plt.title(title)</span></code></pre>
</div>
<p>The docstring allows us to have good documentation for our
function:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="bu">help</span>(plot_pr_climatology)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Help on function plot_pr_climatology in module __main__:

plot_pr_climatology(pr_file, season, gridlines=False)
    Plot the precipitation climatology.

    Args:
      pr_file (str): Precipitation data file
      season (str): Season (3 letter abbreviation, e.g. JJA)
      gridlines (bool): Select whether to plot gridlines</code></pre>
</div>
<p>We can now use this function to create exactly the same plot as
before:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>plot_pr_climatology(<span class="st">"data/pr_Amon_ACCESS-CM2_historical_r1i1p1f1_gn_201001-201412.nc"</span>, <span class="st">"JJA"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>plt.show()</span></code></pre>
</div>
<figure><img src="fig/03-functions-accesscm2-jja.png" alt="Precipitation climatology" class="figure mx-auto d-block"></figure><p>Plot a different model and season:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>plot_pr_climatology(<span class="st">"data/pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412.nc"</span>, <span class="st">"DJF"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>plt.show()</span></code></pre>
</div>
<figure><img src="fig/03-functions-accessesm-djf.png" alt="Precipitation climatology" class="figure mx-auto d-block"></figure><p>Or use the optional <code>gridlines</code> input argument to change
the default behaviour of the function (keyword arguments are usually
used for options that the user will only want to change
occasionally):</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>plot_pr_climatology(</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    <span class="st">"data/pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412.nc"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="st">"DJF"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    gridlines<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>)</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>plt.show()</span></code></pre>
</div>
<figure><img src="fig/03-functions-accessesm-djf-gridlines.png" alt="Precipitation climatology" class="figure mx-auto d-block"></figure><div id="short-functions" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="short-functions" class="callout-inner">
<h3 class="callout-title">Short functions<a class="anchor" aria-label="anchor" href="#short-functions"></a>
</h3>
<div class="callout-content">
<p>Our <code>plot_pr_climatology</code> function works, but at 16 lines
of code it’s starting to get a little long. In general, people can only
fit around 7-12 pieces of information in their short term memory. The
readability of your code can therefore be greatly enhanced by keeping
your functions short and sharp. The speed at which people can analyse
their data is usually limited by the time it takes to
read/understand/edit their code (as opposed to the time it takes the
code to actually run), so the frequent use of short, well documented
functions can dramatically speed up your data science.</p>
<ol style="list-style-type: decimal">
<li>Cut and paste the <code>plot_pr_climatology</code> function (defined
in the notes above) into your own notebook and try running it with
different input arguments.</li>
<li>Break the contents of <code>plot_pr_climatology</code> down into a
series of smaller functions, such that it reads as follows:</li>
</ol>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">def</span> plot_pr_climatology(pr_file, season, gridlines<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    <span class="co">"""Plot the precipitation climatology.</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co">      pr_file (str): Precipitation data file</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co">      season (str): Season (3 letter abbreviation, e.g. JJA)</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="co">      gridlines (bool): Select whether to plot gridlines</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(pr_file)</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>    clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>    create_plot(clim, ds.attrs[<span class="st">"source_id"</span>], season, gridlines<span class="op">=</span>gridlines)</span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>    plt.show()</span></code></pre>
</div>
<p>In other words, you’ll need to define new
<code>convert_pr_units</code> and <code>create_plot</code> functions
using code from the existing <code>plot_pr_climatology</code>
function.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">def</span> convert_pr_units(da):</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    <span class="co">"""Convert kg m-2 s-1 to mm day-1.</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Precipitation data</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>   </span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>    da.data <span class="op">=</span> da.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>    da.attrs[<span class="st">'units'</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>   </span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>    <span class="cf">return</span> da</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="kw">def</span> create_plot(clim, model, season, gridlines<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>    <span class="co">"""Plot the precipitation climatology.</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a><span class="co">      clim (xarray.DataArray): Precipitation climatology data</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a><span class="co">      model (str) : Name of the climate model</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a><span class="co">      season (str): Season </span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a><span class="co">    Kwargs:  </span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a><span class="co">      gridlines (bool): Select whether to plot gridlines    </span></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>       </span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>    clim.sel(season<span class="op">=</span>season).plot.contourf(</span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a>        levels<span class="op">=</span>np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>),</span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a>        extend<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a>        transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a>        cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: clim.units},</span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a>        cmap<span class="op">=</span>cmocean.cm.haline_r,</span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a>    )</span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a>    ax.coastlines()</span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a>    <span class="cf">if</span> gridlines:</span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a>        plt.gca().gridlines()</span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a>   </span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a>    title <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss"> precipitation climatology (</span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb9-43"><a href="#cb9-43" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb9-44"><a href="#cb9-44" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" tabindex="-1"></a></span>
<span id="cb9-46"><a href="#cb9-46" tabindex="-1"></a><span class="kw">def</span> plot_pr_climatology(pr_file, season, gridlines<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb9-47"><a href="#cb9-47" tabindex="-1"></a>    <span class="co">"""Plot the precipitation climatology.</span></span>
<span id="cb9-48"><a href="#cb9-48" tabindex="-1"></a></span>
<span id="cb9-49"><a href="#cb9-49" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb9-50"><a href="#cb9-50" tabindex="-1"></a><span class="co">      pr_file (str): Precipitation data file</span></span>
<span id="cb9-51"><a href="#cb9-51" tabindex="-1"></a><span class="co">      season (str): Season (3 letter abbreviation, e.g. JJA)</span></span>
<span id="cb9-52"><a href="#cb9-52" tabindex="-1"></a><span class="co">      gridlines (bool): Select whether to plot gridlines</span></span>
<span id="cb9-53"><a href="#cb9-53" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-55"><a href="#cb9-55" tabindex="-1"></a></span>
<span id="cb9-56"><a href="#cb9-56" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(pr_file)</span>
<span id="cb9-57"><a href="#cb9-57" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-58"><a href="#cb9-58" tabindex="-1"></a>    clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb9-59"><a href="#cb9-59" tabindex="-1"></a>    create_plot(clim, ds.attrs[<span class="st">"source_id"</span>], season, gridlines<span class="op">=</span>gridlines)</span>
<span id="cb9-60"><a href="#cb9-60" tabindex="-1"></a>    plt.show()</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="writing-your-own-modules" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="writing-your-own-modules" class="callout-inner">
<h3 class="callout-title">Writing your own modules<a class="anchor" aria-label="anchor" href="#writing-your-own-modules"></a>
</h3>
<div class="callout-content">
<p>We’ve used functions to avoid code duplication in this particular
notebook/script, but what if we wanted to convert precipitation units
from kg m-2 s-1 to mm/day in a different notebook/script?</p>
<p>To avoid cutting and pasting from this notebook/script to another,
the solution would be to place the <code>convert_pr_units</code>
function in a separate script full of similar functions.</p>
<p>For instance, we could put all our unit conversion functions in a
script called <code>unit_conversion.py</code>. When we want to convert
precipitation units (in any script or notebook we’re working on), we can
simply import that “module” and use the <code>convert_pr_units</code>
function:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="im">import</span> unit_conversion</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>clim.data <span class="op">=</span> unit_conversion.convert_pr_units(clim.data)</span></code></pre>
</div>
<p>No copy and paste required!</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Define a function using <code>def name(...params...)</code>.</li>
<li>The body of a function must be indented.</li>
<li>Call a function using <code>name(...values...)</code>.</li>
<li>Use <code>help(thing)</code> to view help for something.</li>
<li>Put docstrings in functions to provide help for that function.</li>
<li>Specify default values for parameters when defining a function using
<code>name=value</code> in the parameter list.</li>
<li>The readability of your code can be greatly enhanced by using
numerous short functions.</li>
<li>Write (and import) modules to avoid code duplication.</li>
</ul>
</div>
</div>
</div></section><section id="aio-04-cmdline"><p>Content from <a href="04-cmdline.html">Command line programs</a></p>
<hr>
<p>Last updated on 2024-07-25 |

        <a href="https://github.com/fishtree-attempt/python-aos-lesson/edit/main/episodes/04-cmdline.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I write my own command line programs?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Use the <code>argparse</code> library to manage command-line
arguments in a program.</li>
<li>Structure Python scripts according to a simple template.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>We’ve arrived at the point where we have successfully defined the
functions required to plot the precipitation data.</p>
<p>We could continue to execute these functions from the Jupyter
notebook, but in most cases notebooks are simply used to try things out
and/or take notes on a new data analysis task. Once you’ve scoped out
the task (as we have for plotting the precipitation climatology), that
code can be transferred to a Python script so that it can be executed at
the command line. It’s likely that your data processing workflows will
include command line utilities from the CDO and NCO projects in addition
to Python code, so the command line is the natural place to manage your
workflows (e.g. using shell scripts or make files).</p>
<p>In general, the first thing that gets added to any Python script is
the following:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>    main()</span></code></pre>
</div>
<p>The reason we need these two lines of code is that running a Python
script in bash is very similar to importing that file in Python. The
biggest difference is that we don’t expect anything to happen when we
import a file, whereas when running a script we expect to see some
output (e.g. an output file, figure and/or some text printed to the
screen).</p>
<p>The <code>__name__</code> variable exists to handle these two
situations. When you import a Python file <code>__name__</code> is set
to the name of that file (e.g. when importing script.py,
<code>__name__</code> is <code>script</code>), but when running a script
in bash <code>__name__</code> is always set to <code>__main__</code>.
The convention is to call the function that produces the output
<code>main()</code>, but you can call it whatever you like.</p>
<p>The next thing you’ll need is a library to parse the command line for
input arguments. The most widely used option is <a href="https://docs.python.org/3/library/argparse.html" class="external-link">argparse</a>.</p>
<p>Putting those together, here’s a template for what most python
command line programs look like:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">$</span> cat script_template.py</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co"># All your functions (that will be called by main()) go here.</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Input file: "</span>, inargs.infile)</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Output file: "</span>, inargs.outfile)</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>    description <span class="op">=</span> <span class="st">"Print the input arguments to the screen."</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span>description)</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>    </span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>    parser.add_argument(<span class="st">"infile"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Input file name"</span>)</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>    parser.add_argument(<span class="st">"outfile"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Output file name"</span>)</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()            </span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>    main(args)</span></code></pre>
</div>
<p>By running <code>script_template.py</code> at the command line we’ll
see that <code>argparse</code> handles all the input arguments:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">$</span> python script_template.py in.nc out.nc</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Input file:  in.nc
Output file:  out.nc</code></pre>
</div>
<p>It also generates help information for the user:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">$</span> python script_template.py <span class="at">-h</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>usage: script_template.py [-h] infile outfile

Print the input arguments to the screen.

positional arguments:
  infile      Input file name
  outfile     Output file name

optional arguments:
  -h, --help  show this help message and exit</code></pre>
</div>
<p>and issues errors when users give the program invalid arguments:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">$</span> python script_template.py in.nc</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>usage: script_template.py [-h] infile outfile
script_template.py: error: the following arguments are required: outfile</code></pre>
</div>
<p>Using this template as a starting point, we can add the functions we
developed previously to a script called
<code>plot_precipitation_climatology.py</code>.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">$</span> cat plot_precipitation_climatology.py</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="im">import</span> cmocean</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="kw">def</span> convert_pr_units(da):</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>    <span class="co">"""Convert kg m-2 s-1 to mm day-1.</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Precipitation data</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>    </span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>    da.data <span class="op">=</span> darray.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>    da.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>    </span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>    <span class="cf">return</span> da</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a><span class="kw">def</span> create_plot(clim, model, season, gridlines<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>    <span class="co">"""Plot the precipitation climatology.</span></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a><span class="co">      clim (xarray.DataArray): Precipitation climatology data</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a><span class="co">      model (str): Name of the climate model</span></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a><span class="co">      season (str): Season</span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a><span class="co">      </span></span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a><span class="co">    Kwargs:  </span></span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a><span class="co">      gridlines (bool): Select whether to plot gridlines    </span></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a>        </span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a>    clim.sel(season<span class="op">=</span>season).plot.contourf(</span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a>        levels<span class="op">=</span>np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>),</span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a>        extend<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a>        transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a>        cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: clim.units},</span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a>        cmap<span class="op">=</span>cmocean.cm.haline_r,</span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a>    )</span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a>    ax.coastlines()</span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a>    <span class="cf">if</span> gridlines:</span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a>        plt.gca().gridlines()</span>
<span id="cb11-49"><a href="#cb11-49" tabindex="-1"></a>    </span>
<span id="cb11-50"><a href="#cb11-50" tabindex="-1"></a>    title <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss"> precipitation climatology (</span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb11-51"><a href="#cb11-51" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb11-52"><a href="#cb11-52" tabindex="-1"></a></span>
<span id="cb11-53"><a href="#cb11-53" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb11-55"><a href="#cb11-55" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb11-56"><a href="#cb11-56" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(inargs.pr_file)</span>
<span id="cb11-58"><a href="#cb11-58" tabindex="-1"></a>    </span>
<span id="cb11-59"><a href="#cb11-59" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-60"><a href="#cb11-60" tabindex="-1"></a>    clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb11-61"><a href="#cb11-61" tabindex="-1"></a></span>
<span id="cb11-62"><a href="#cb11-62" tabindex="-1"></a>    create_plot(clim, ds.attrs[<span class="st">"source_id"</span>], inargs.season)</span>
<span id="cb11-63"><a href="#cb11-63" tabindex="-1"></a>    plt.savefig(</span>
<span id="cb11-64"><a href="#cb11-64" tabindex="-1"></a>        inargs.output_file,</span>
<span id="cb11-65"><a href="#cb11-65" tabindex="-1"></a>        dpi<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb11-66"><a href="#cb11-66" tabindex="-1"></a>        bbox_inches<span class="op">=</span><span class="st">"tight"</span>,</span>
<span id="cb11-67"><a href="#cb11-67" tabindex="-1"></a>        facecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb11-68"><a href="#cb11-68" tabindex="-1"></a>    )</span>
<span id="cb11-69"><a href="#cb11-69" tabindex="-1"></a></span>
<span id="cb11-70"><a href="#cb11-70" tabindex="-1"></a></span>
<span id="cb11-71"><a href="#cb11-71" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb11-72"><a href="#cb11-72" tabindex="-1"></a>    description<span class="op">=</span><span class="st">'Plot the precipitation climatology.'</span></span>
<span id="cb11-73"><a href="#cb11-73" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span>description)</span>
<span id="cb11-74"><a href="#cb11-74" tabindex="-1"></a>    </span>
<span id="cb11-75"><a href="#cb11-75" tabindex="-1"></a>    parser.add_argument(<span class="st">"pr_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Precipitation data file"</span>)</span>
<span id="cb11-76"><a href="#cb11-76" tabindex="-1"></a>    parser.add_argument(<span class="st">"season"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Season to plot"</span>)</span>
<span id="cb11-77"><a href="#cb11-77" tabindex="-1"></a>    parser.add_argument(<span class="st">"output_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Output file name"</span>)</span>
<span id="cb11-78"><a href="#cb11-78" tabindex="-1"></a></span>
<span id="cb11-79"><a href="#cb11-79" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb11-80"><a href="#cb11-80" tabindex="-1"></a>    </span>
<span id="cb11-81"><a href="#cb11-81" tabindex="-1"></a>    main(args)</span></code></pre>
</div>
<p>… and then run it at the command line:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">$</span> python plot_precipitation_climatology.py data/pr_Amon_ACCESS-CM2_historical_r1i1p1f1_gn_201001-201412.nc MAM pr_Amon_ACCESS-CM2_historical_r1i1p1f1_gn_201001-201412-MAM-clim.png</span></code></pre>
</div>
<div id="choices" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="choices" class="callout-inner">
<h3 class="callout-title">Choices<a class="anchor" aria-label="anchor" href="#choices"></a>
</h3>
<div class="callout-content">
<p>For this series of challenges, you are required to make improvements
to the <code>plot_precipitation_climatology.py</code> script that you
downloaded earlier from the setup tab at the top of the page.</p>
<p>For the first improvement, edit the line of code that defines the
season command line argument
(<code>parser.add_argument("season", type=str, help="Season to plot")</code>)
so that it only allows the user to input a valid three letter
abbreviation (i.e. <code>["DJF", "MAM", "JJA", "SON"]</code>).</p>
<p>(Hint: Read about the <code>choices</code> keyword argument at the <a href="https://docs.python.org/3/howto/argparse.html" class="external-link">argparse
tutorial</a>.)</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>parser.add_argument(</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>    <span class="st">"season"</span>,</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    choices<span class="op">=</span>[<span class="st">"DJF"</span>, <span class="st">"MAM"</span>, <span class="st">"JJA"</span>, <span class="st">"SON"</span>], </span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    <span class="bu">help</span><span class="op">=</span><span class="st">"Season to plot"</span>,</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="gridlines" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="gridlines" class="callout-inner">
<h3 class="callout-title">Gridlines<a class="anchor" aria-label="anchor" href="#gridlines"></a>
</h3>
<div class="callout-content">
<p>Add an optional command line argument that allows the user to add
gridlines to the plot.</p>
<p>(Hint: Read about the <code>action="store_true"</code> keyword
argument at the <a href="https://docs.python.org/3/howto/argparse.html" class="external-link">argparse
tutorial</a>.)</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>Make the following additions to
<code>plot_precipitation_climatology.py</code> (code omitted from this
abbreviated version of the script is denoted <code>...</code>):</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>...</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>   ... </span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>   create_plot(</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>       clim,</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>       ds.attrs[<span class="st">"source_id"</span>],</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>       inargs.season,</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>       gridlines<span class="op">=</span>inargs.gridlines,</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>    )</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>...</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>    ... </span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>        <span class="st">"--gridlines"</span>,</span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>        action<span class="op">=</span><span class="st">"store_true"</span>,</span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>        default<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Include gridlines on the plot"</span>,</span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>    )</span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a>... </span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="colorbar-levels" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="colorbar-levels" class="callout-inner">
<h3 class="callout-title">Colorbar levels<a class="anchor" aria-label="anchor" href="#colorbar-levels"></a>
</h3>
<div class="callout-content">
<p>Add an optional command line argument that allows the user to specify
the tick levels used in the colourbar</p>
<p>(Hint: You’ll need to use the <code>nargs='*'</code> keyword
argument.)</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>Make the following additions to
<code>plot_precipitation_climatology.py</code> (code omitted from this
abbreviated version of the script is denoted <code>...</code>):</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>...</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="kw">def</span> create_plot(clim, model_name, season, gridlines<span class="op">=</span><span class="va">False</span>, levels<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    <span class="co">"""Plot the precipitation climatology.</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="co">      ...</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">      Kwargs:</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="co">        gridlines (bool): Select whether to plot gridlines</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="co">        levels (list): Tick marks on the colorbar      </span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> levels:</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>        levels <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>    ...</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>    clim.sel(season<span class="op">=</span>season).plot.contourf(</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>        ...,</span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>    )</span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>...</span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a>    ... </span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>    create_plot(</span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a>        clim,</span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a>        ds.attrs[<span class="st">"source_id"</span>],</span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a>        inargs.season,</span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a>        gridlines<span class="op">=</span>inargs.gridlines,</span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a>        levels<span class="op">=</span>inargs.cbar_levels,</span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a>    )</span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a>...</span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a></span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a></span>
<span id="cb15-40"><a href="#cb15-40" tabindex="-1"></a>    ... </span>
<span id="cb15-41"><a href="#cb15-41" tabindex="-1"></a></span>
<span id="cb15-42"><a href="#cb15-42" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb15-43"><a href="#cb15-43" tabindex="-1"></a>        <span class="st">"--cbar_levels"</span>,</span>
<span id="cb15-44"><a href="#cb15-44" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>,</span>
<span id="cb15-45"><a href="#cb15-45" tabindex="-1"></a>        nargs<span class="op">=</span><span class="st">"*"</span>,</span>
<span id="cb15-46"><a href="#cb15-46" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb15-47"><a href="#cb15-47" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"list of levels / tick marks to appear on the colorbar"</span>,</span>
<span id="cb15-48"><a href="#cb15-48" tabindex="-1"></a>    )</span>
<span id="cb15-49"><a href="#cb15-49" tabindex="-1"></a></span>
<span id="cb15-50"><a href="#cb15-50" tabindex="-1"></a>... </span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="free-time" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="free-time" class="callout-inner">
<h3 class="callout-title">Free time<a class="anchor" aria-label="anchor" href="#free-time"></a>
</h3>
<div class="callout-content">
<p>Add any other options you’d like for customising the plot
(e.g. title, axis labels, figure size).</p>
</div>
</div>
</div>
<div id="plot_precipitation_climatology.py" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="plot_precipitation_climatology.py" class="callout-inner">
<h3 class="callout-title">plot_precipitation_climatology.py<a class="anchor" aria-label="anchor" href="#plot_precipitation_climatology.py"></a>
</h3>
<div class="callout-content">
<p>At the conclusion of this lesson your
<code>plot_precipitation_climatology.py</code> script should look
something like the following:</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Show me the solution </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="im">import</span> cmocean</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="kw">def</span> convert_pr_units(da):</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>    <span class="co">"""Convert kg m-2 s-1 to mm day-1.</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Precipitation data</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>    </span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>    da.data <span class="op">=</span> darray.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>    da.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>   </span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>    <span class="cf">return</span> da</span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a><span class="kw">def</span> create_plot(clim, model, season, gridlines<span class="op">=</span><span class="va">False</span>, levels<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>    <span class="co">"""Plot the precipitation climatology.</span></span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a><span class="co">      clim (xarray.DataArray): Precipitation climatology data</span></span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a><span class="co">      model (str): Name of the climate model</span></span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a><span class="co">      season (str): Season</span></span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a><span class="co">      </span></span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a><span class="co">    Kwargs:</span></span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a><span class="co">      gridlines (bool): Select whether to plot gridlines</span></span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a><span class="co">      levels (list): Tick marks on the colorbar    </span></span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-35"><a href="#cb16-35" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-36"><a href="#cb16-36" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> levels:</span>
<span id="cb16-38"><a href="#cb16-38" tabindex="-1"></a>        levels <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb16-39"><a href="#cb16-39" tabindex="-1"></a>        </span>
<span id="cb16-40"><a href="#cb16-40" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb16-41"><a href="#cb16-41" tabindex="-1"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb16-42"><a href="#cb16-42" tabindex="-1"></a>    clim.sel(season<span class="op">=</span>season).plot.contourf(</span>
<span id="cb16-43"><a href="#cb16-43" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb16-44"><a href="#cb16-44" tabindex="-1"></a>        levels<span class="op">=</span>levels,</span>
<span id="cb16-45"><a href="#cb16-45" tabindex="-1"></a>        extend<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb16-46"><a href="#cb16-46" tabindex="-1"></a>        transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb16-47"><a href="#cb16-47" tabindex="-1"></a>        cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: clim.units},</span>
<span id="cb16-48"><a href="#cb16-48" tabindex="-1"></a>        cmap<span class="op">=</span>cmocean.cm.haline_r,</span>
<span id="cb16-49"><a href="#cb16-49" tabindex="-1"></a>    )</span>
<span id="cb16-50"><a href="#cb16-50" tabindex="-1"></a>    ax.coastlines()</span>
<span id="cb16-51"><a href="#cb16-51" tabindex="-1"></a>    <span class="cf">if</span> gridlines:</span>
<span id="cb16-52"><a href="#cb16-52" tabindex="-1"></a>        plt.gca().gridlines()</span>
<span id="cb16-53"><a href="#cb16-53" tabindex="-1"></a>    </span>
<span id="cb16-54"><a href="#cb16-54" tabindex="-1"></a>    title <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss"> precipitation climatology (</span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb16-55"><a href="#cb16-55" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb16-56"><a href="#cb16-56" tabindex="-1"></a></span>
<span id="cb16-57"><a href="#cb16-57" tabindex="-1"></a></span>
<span id="cb16-58"><a href="#cb16-58" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb16-59"><a href="#cb16-59" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb16-60"><a href="#cb16-60" tabindex="-1"></a></span>
<span id="cb16-61"><a href="#cb16-61" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(inargs.pr_file)</span>
<span id="cb16-62"><a href="#cb16-62" tabindex="-1"></a>    </span>
<span id="cb16-63"><a href="#cb16-63" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-64"><a href="#cb16-64" tabindex="-1"></a>    clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb16-65"><a href="#cb16-65" tabindex="-1"></a></span>
<span id="cb16-66"><a href="#cb16-66" tabindex="-1"></a>    create_plot(</span>
<span id="cb16-67"><a href="#cb16-67" tabindex="-1"></a>        clim,</span>
<span id="cb16-68"><a href="#cb16-68" tabindex="-1"></a>        ds.attrs[<span class="st">"source_id"</span>],</span>
<span id="cb16-69"><a href="#cb16-69" tabindex="-1"></a>        inargs.season,</span>
<span id="cb16-70"><a href="#cb16-70" tabindex="-1"></a>        gridlines<span class="op">=</span>inargs.gridlines,</span>
<span id="cb16-71"><a href="#cb16-71" tabindex="-1"></a>        levels<span class="op">=</span>inargs.cbar_levels,</span>
<span id="cb16-72"><a href="#cb16-72" tabindex="-1"></a>    )</span>
<span id="cb16-73"><a href="#cb16-73" tabindex="-1"></a>    plt.savefig(</span>
<span id="cb16-74"><a href="#cb16-74" tabindex="-1"></a>        inargs.output_file,</span>
<span id="cb16-75"><a href="#cb16-75" tabindex="-1"></a>        dpi<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb16-76"><a href="#cb16-76" tabindex="-1"></a>        bbox_inches<span class="op">=</span><span class="st">"tight"</span>,</span>
<span id="cb16-77"><a href="#cb16-77" tabindex="-1"></a>        facecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb16-78"><a href="#cb16-78" tabindex="-1"></a>    )</span>
<span id="cb16-79"><a href="#cb16-79" tabindex="-1"></a></span>
<span id="cb16-80"><a href="#cb16-80" tabindex="-1"></a></span>
<span id="cb16-81"><a href="#cb16-81" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb16-82"><a href="#cb16-82" tabindex="-1"></a>    description <span class="op">=</span> <span class="st">"Plot the precipitation climatology."</span></span>
<span id="cb16-83"><a href="#cb16-83" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span>description)</span>
<span id="cb16-84"><a href="#cb16-84" tabindex="-1"></a>   </span>
<span id="cb16-85"><a href="#cb16-85" tabindex="-1"></a>    parser.add_argument(<span class="st">"pr_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Precipitation data file"</span>)</span>
<span id="cb16-86"><a href="#cb16-86" tabindex="-1"></a>    parser.add_argument(<span class="st">"season"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Season to plot"</span>)</span>
<span id="cb16-87"><a href="#cb16-87" tabindex="-1"></a>    parser.add_argument(<span class="st">"output_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Output file name"</span>)</span>
<span id="cb16-88"><a href="#cb16-88" tabindex="-1"></a></span>
<span id="cb16-89"><a href="#cb16-89" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb16-90"><a href="#cb16-90" tabindex="-1"></a>        <span class="st">"--gridlines"</span>,</span>
<span id="cb16-91"><a href="#cb16-91" tabindex="-1"></a>        action<span class="op">=</span><span class="st">"store_true"</span>,</span>
<span id="cb16-92"><a href="#cb16-92" tabindex="-1"></a>        default<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb16-93"><a href="#cb16-93" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Include gridlines on the plot"</span>,</span>
<span id="cb16-94"><a href="#cb16-94" tabindex="-1"></a>    )</span>
<span id="cb16-95"><a href="#cb16-95" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb16-96"><a href="#cb16-96" tabindex="-1"></a>        <span class="st">"--cbar_levels"</span>,</span>
<span id="cb16-97"><a href="#cb16-97" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>,</span>
<span id="cb16-98"><a href="#cb16-98" tabindex="-1"></a>        nargs<span class="op">=</span><span class="st">"*"</span>,</span>
<span id="cb16-99"><a href="#cb16-99" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb16-100"><a href="#cb16-100" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"list of levels / tick marks to appear on the colorbar"</span>,</span>
<span id="cb16-101"><a href="#cb16-101" tabindex="-1"></a>    )</span>
<span id="cb16-102"><a href="#cb16-102" tabindex="-1"></a></span>
<span id="cb16-103"><a href="#cb16-103" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb16-104"><a href="#cb16-104" tabindex="-1"></a>    main(args)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Libraries such as <code>argparse</code> can be used the efficiently
handle command line arguments.</li>
<li>Most Python scripts have a similar structure that can be used as a
template.</li>
</ul>
</div>
</div>
</div></section><section id="aio-05-git"><p>Content from <a href="05-git.html">Version control</a></p>
<hr>
<p>Last updated on 2024-07-25 |

        <a href="https://github.com/fishtree-attempt/python-aos-lesson/edit/main/episodes/05-git.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I record the revision history of my code?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Configure <code>git</code> the first time it is used on a
computer.</li>
<li>Create a local Git repository.</li>
<li>Go through the modify-add-commit cycle for one or more files.</li>
<li>Explain what the HEAD of a repository is and how to use it.</li>
<li>Identify and use Git commit numbers.</li>
<li>Compare various versions of tracked files.</li>
<li>Restore old versions of files.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="follow-along" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="follow-along" class="callout-inner">
<h3 class="callout-title">Follow along<a class="anchor" aria-label="anchor" href="#follow-along"></a>
</h3>
<div class="callout-content">
<p>For this lesson participants follow along command by command, rather
than observing and then completing challenges afterwards.</p>
</div>
</div>
</div>
<p>A version control system stores an authoritative copy of your code in
a repository, which you can’t edit directly.</p>
<p>Instead, you checkout a working copy of the code, edit that code,
then commit changes back to the repository.</p>
<p>In this way, the system records a complete revision history (i.e. of
every commit), so that you can retrieve and compare previous versions at
any time.</p>
<p>This is useful from an individual viewpoint, because you don’t need
to store multiple (but slightly different) copies of the same
script.</p>
<figure><img src="fig/05-git-file-mess.gif" alt="File mess" class="figure mx-auto d-block"></figure><p>It’s also useful from a collaboration viewpoint (including
collaborating with yourself across different computers) because the
system keeps a record of who made what changes and when.</p>
<section><h2 class="section-heading" id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<hr class="half-width">
<p>When we use Git on a new computer for the first time, we need to
configure a few things.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">$</span> git config <span class="at">--global</span> user.name <span class="st">"Your Name"</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">$</span> git config <span class="at">--global</span> user.email <span class="st">"you@email.com"</span></span></code></pre>
</div>
<p>This user name and email will be associated with your subsequent Git
activity, which means that any changes pushed to <a href="https://github.com/" class="external-link">GitHub</a>, <a href="https://bitbucket.org/" class="external-link">BitBucket</a>, <a href="https://gitlab.com/" class="external-link">GitLab</a> or another Git host server later
on in this lesson will include this information.</p>
<p>You only need to run these configuration commands once - git will
remember then for next time.</p>
<p>We then need to navigate to our <code>data-carpentry</code> directory
and tell Git to initialise that directory as a Git repository.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">$</span> cd ~/Desktop/data-carpentry</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="ex">$</span> git init</span></code></pre>
</div>
<p>If we use <code>ls</code> to show the directory’s contents, it
appears that nothing has changed:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">$</span> ls <span class="at">-F</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">data</span><span class="op">/</span>          <span class="va">script_template.py</span></span>
<span><span class="va">plot_precipitation_climatology.py</span></span></code></pre>
</div>
<p>But if we add the <code>-a</code> flag to show everything, we can see
that Git has created a hidden directory within
<code>data-carpentry</code> called <code>.git</code>:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">$</span> ls <span class="at">-F</span> <span class="at">-a</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">.</span><span class="op">/</span>                  <span class="va">data</span><span class="op">/</span></span>
<span><span class="va">..</span><span class="op">/</span>                 <span class="va">plot_precipitation_climatology.py</span></span>
<span><span class="va">.git</span><span class="op">/</span>               <span class="va">script_template.py</span></span></code></pre>
</div>
<p>Git stores information about the project in this special
sub-directory. If we ever delete it, we will lose the project’s
history.</p>
<p>We can check that everything is set up correctly by asking Git to
tell us the status of our project:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">$</span> git status</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>$ git status
On branch main

Initial commit

Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)

	data/
	plot_precipitation_climatology.py
	script_template.py

nothing added to commit but untracked files present (use "git add" to track)</code></pre>
</div>
<div id="branch-naming" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="branch-naming" class="callout-inner">
<h3 class="callout-title">Branch naming<a class="anchor" aria-label="anchor" href="#branch-naming"></a>
</h3>
<div class="callout-content">
<p>If you’re running an older version of Git, you may see
<code>On branch master</code> instead of <code>On branch main</code> at
the top of the <code>git status</code> output. Since 2021, Git has
followed a move in the developer community to change the default branch
name from “master” to “main” for cultural sensitivity reasons, avoiding
“master/slave” terminology.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="tracking-changes">Tracking changes<a class="anchor" aria-label="anchor" href="#tracking-changes"></a>
<a class="anchor" aria-label="anchor" href="#tracking-changes"></a>
</h2>
<hr class="half-width">
<p>The “untracked files” message means that there’s a file/s in the
directory that Git isn’t keeping track of. We can tell Git to track a
file using <code>git add</code>:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">$</span> git add plot_precipitation_climatology.py</span></code></pre>
</div>
<p>and then check that the right thing happened:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">$</span> git status</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>On branch main

Initial commit

Changes to be committed:
  (use "git rm --cached &lt;file&gt;..." to unstage)

	new file:   plot_precipitation_climatology.py

Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)

	data/
	script_template.py</code></pre>
</div>
<p>Git now knows that it’s supposed to keep track of
<code>plot_precipitation_climatology.py</code>, but it hasn’t recorded
these changes as a commit yet. To get it to do that, we need to run one
more command:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">$</span> git commit <span class="at">-m</span> <span class="st">"Initial commit of precip climatology script"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[main (root-commit) 8e69d70] Initial commit of precip climatology script
 1 file changed, 75 insertions(+)
 create mode 100644 plot_precipitation_climatology.py</code></pre>
</div>
<p>When we run <code>git commit</code>, Git takes everything we have
told it to save by using <code>git add</code> and stores a copy
permanently inside the special <code>.git</code> directory. This
permanent copy is called a commit (or revision) and its short identifier
is <code>8e69d70</code> (Your commit may have another identifier.)</p>
<p>We use the <code>-m</code> flag (for “message”) to record a short,
descriptive, and specific comment that will help us remember later on
what we did and why. If we just run <code>git commit</code> without the
<code>-m</code> option, Git will launch <code>nano</code> (or whatever
other editor we configured as <code>core.editor</code>) so that we can
write a longer message.</p>
<p>If we run <code>git status</code> now:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="ex">$</span> git status</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>On branch main
Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)

	data/
	script_template.py

nothing added to commit but untracked files present (use "git add" to track)</code></pre>
</div>
<p>it tells us everything is up to date. If we want to know what we’ve
done recently, we can ask Git to show us the project’s history using
<code>git log</code>:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="ex">$</span> git log</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>commit 8e69d7086cb7c44a48a096122e5324ad91b8a439
Author: Damien Irving &lt;my@email.com&gt;
Date:   Wed Mar 3 15:46:48 2021 +1100

    Initial commit of precip climatology script</code></pre>
</div>
<p><code>git log</code> lists all commits made to a repository in
reverse chronological order. The listing for each commit includes the
commit’s full identifier (which starts with the same characters as the
short identifier printed by the <code>git commit</code> command
earlier), the commit’s author, when it was created, and the log message
Git was given when the commit was created.</p>
<p>Let’s go ahead and open our favourite text editor and make a small
change to <code>plot_precipitation_climatology.py</code> by editing the
<code>description</code> variable (which is used by argparse in the help
information it displays at the command line).</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>description <span class="op">=</span> <span class="st">"Plot the precipitation climatology for a given season."</span></span></code></pre>
</div>
<p>When we run <code>git status</code> now, it tells us that a file it
already knows about has been modified:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="ex">$</span> git status</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>On branch main
Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git restore &lt;file&gt;..." to discard changes in working directory)

	modified:   plot_precipitation_climatology.py

Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)

	data/
	script_template.py

no changes added to commit (use "git add" and/or "git commit -a")</code></pre>
</div>
<p>The last line is the key phrase: “no changes added to commit”. We
have changed this file, but we haven’t told Git we will want to save
those changes (which we do with <code>git add</code>) nor have we saved
them (which we do with <code>git commit</code>). So let’s do that now.
It is good practice to always review our changes before saving them. We
do this using <code>git diff</code>. This shows us the differences
between the current state of the file and the most recently saved
version:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="ex">$</span> git diff</span></code></pre>
</div>
<pre><code>$ git diff
diff --git a/plot_precipitation_climatology.py b/plot_precipitation_climatology.py
index 58903f5..6c12b29 100644
--- a/plot_precipitation_climatology.py
+++ b/plot_precipitation_climatology.py
@@ -62,7 +62,7 @@ def main(inargs):


 if __name__ == '__main__':
-    description = "Plot the precipitation climatology."
+    description = "Plot the precipitation climatology for a given season."
     parser = argparse.ArgumentParser(description=description)

     parser.add_argument("pr_file", type=str, help="Precipitation data file")</code></pre>
<p>The output is a little cryptic because it’s actually a series of
commands for tools like editors and <code>patch</code> telling them how
to reconstruct one file given the other, but the + and - markers clearly
show what has been changed.</p>
<p>After reviewing our change, it’s time to commit it:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="ex">$</span> git commit <span class="at">-m</span> <span class="st">"Small improvement to help information"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>On branch main
Changes not staged for commit:
	modified:   plot_precipitation_climatology.py

Untracked files:
	data/
	script_template.py

no changes added to commit</code></pre>
</div>
<p>Whoops: Git won’t commit because we didn’t use <code>git add</code>
first. Let’s fix that:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="ex">$</span> git add plot_precipitation_climatology.py</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="ex">$</span> git commit <span class="at">-m</span> <span class="st">"Small improvement to help information"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[main 35f22b7] Small improvement to help information
 1 file changed, 1 insertion(+), 1 deletion(-)</code></pre>
</div>
<p>Git insists that we add files to the set we want to commit before
actually committing anything. This allows us to commit our changes in
stages and capture changes in logical portions rather than only large
batches. For example, suppose we’re writing our thesis using LaTeX (the
plain text <code>.tex</code> files can be tracked using Git) and we add
a few citations to the introduction chapter. We might want to commit
those additions to our <code>introduction.tex</code> file but
<em>not</em> commit the work we’re doing on the
<code>conclusion.tex</code> file (which we haven’t finished yet).</p>
<p>To allow for this, Git has a special <em>staging area</em> where it
keeps track of things that have been added to the current changeset but
not yet committed.</p>
<figure><img src="fig/05-git-staging-area.svg" alt="The Git Staging Area" class="figure mx-auto d-block"></figure><p>Let’s do the whole edit-add-commit process one more time to watch as
our changes to a file move from our editor to the staging area and into
long-term storage. First, we’ll tweak the section of the script that
imports all the libraries we need, by putting them in the order
suggested by the <a href="https://www.python.org/dev/peps/pep-0008/#imports" class="external-link">PEP 8 - Style
Guide for Python Code</a>. The convention is to import packages from the
<a href="https://docs.python.org/3/library/" class="external-link">Python Standard Library</a>
first, then other external packages, then your own modules (with a blank
line between each grouping).</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a><span class="im">import</span> cmocean</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="ex">$</span> git diff</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>diff --git a/plot_precipitation_climatology.py b/plot_precipitation_climatology.py
index 6c12b29..c6beb12 100644
--- a/plot_precipitation_climatology.py
+++ b/plot_precipitation_climatology.py
@@ -1,9 +1,10 @@
+import argparse
+
 import xarray as xr
 import cartopy.crs as ccrs
 import matplotlib.pyplot as plt
 import numpy as np
 import cmocean
-import argparse


 def convert_pr_units(da):</code></pre>
</div>
<p>Let’s save our changes:</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="ex">$</span> git add plot_precipitation_climatology.py</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="ex">$</span> git commit <span class="at">-m</span> <span class="st">"Ordered imports according to PEP 8"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[main a6cea2c] Ordered imports according to PEP 8
 1 file changed, 2 insertions(+), 1 deletion(-)</code></pre>
</div>
<p>check our status:</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="ex">$</span> git status</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>On branch main
Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)

	data/
	script_template.py

nothing added to commit but untracked files present (use "git add" to track)</code></pre>
</div>
<p>and look at the history of what we’ve done so far:</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="ex">$</span> git log</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>commit a6cea2cd4facde6adfdde3a08ff9413b45479623 (HEAD -&gt; main)
Author: Damien Irving &lt;my@email.com&gt;
Date:   Wed Mar 3 16:01:45 2021 +1100

    Ordered imports according to PEP 8

commit 35f22b74b11ed7993b23f9b4554b03ffc295e823
Author: Damien Irving &lt;my@email.com&gt;
Date:   Wed Mar 3 15:55:18 2021 +1100

    Small improvement to help information

commit 8e69d7086cb7c44a48a096122e5324ad91b8a439
Author: Damien Irving &lt;my@email.com&gt;
Date:   Wed Mar 3 15:46:48 2021 +1100

    Initial commit of precip climatology script</code></pre>
</div>
</section><section><h2 class="section-heading" id="exploring-history">Exploring history<a class="anchor" aria-label="anchor" href="#exploring-history"></a>
<a class="anchor" aria-label="anchor" href="#exploring-history"></a>
</h2>
<hr class="half-width">
<p>As we saw earlier, we can refer to commits by their identifiers. You
can refer to the <em>most recent commit</em> of the working directory by
using the identifier <code>HEAD</code>.</p>
<p>To demonstrate how to use <code>HEAD</code>, let’s make a trival
change to <code>plot_precipitation_climatology.py</code> by inserting a
comment.</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="co"># A random comment</span></span></code></pre>
</div>
<p>Now, let’s see what we get.</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="ex">$</span> git diff HEAD plot_precipitation_climatology.py</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>diff --git a/plot_precipitation_climatology.py b/plot_precipitation_climatology.py
index c6beb12..c11707c 100644
--- a/plot_precipitation_climatology.py
+++ b/plot_precipitation_climatology.py
@@ -6,6 +6,7 @@ import matplotlib.pyplot as plt
 import numpy as np
 import cmocean

+# A random comment

 def convert_pr_units(darray):
     """Convert kg m-2 s-1 to mm day-1.</code></pre>
</div>
<p>which is the same as what you would get if you leave out
<code>HEAD</code> (try it). The real benefit of using the HEAD notation
is the ease with which you can refer to previous commits. We do that by
adding <code>~1</code> to refer to the commit one before
<code>HEAD</code>.</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="ex">$</span> git diff HEAD~1 plot_precipitation_climatology.py</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>diff --git a/plot_precipitation_climatology.py b/plot_precipitation_climatology.py
index 6c12b29..c11707c 100644
--- a/plot_precipitation_climatology.py
+++ b/plot_precipitation_climatology.py
@@ -1,10 +1,12 @@
+import argparse
+
 import xarray as xr
 import cartopy.crs as ccrs
 import matplotlib.pyplot as plt
 import numpy as np
 import cmocean
-import argparse

+# A random comment

 def convert_pr_units(da):
     """Convert kg m-2 s-1 to mm day-1.</code></pre>
</div>
<p>If we want to see the differences between older commits we can use
<code>git diff</code> again, but with the notation <code>HEAD~2</code>,
<code>HEAD~3</code>, and so on, to refer to them.</p>
<p>We can also refer to commits using those long strings of digits and
letters that <code>git log</code> displays. These are unique IDs for the
changes, and “unique” really does mean unique: every change to any set
of files on any computer has a unique 40-character identifier. Our first
commit (HEAD~2) was given the ID
<code>8e69d7086cb7c44a48a096122e5324ad91b8a439</code>, but you only have
to use the first seven characters for git to know what you mean:</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="ex">$</span> git diff 8e69d70 plot_precipitation_climatology.py</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>diff --git a/plot_precipitation_climatology.py b/plot_precipitation_climatology.py
index 58903f5..c11707c 100644
--- a/plot_precipitation_climatology.py
+++ b/plot_precipitation_climatology.py
@@ -1,10 +1,12 @@
+import argparse
+
 import xarray as xr
 import cartopy.crs as ccrs
 import matplotlib.pyplot as plt
 import numpy as np
 import cmocean
-import argparse

+# A random comment

 def convert_pr_units(da):
     """Convert kg m-2 s-1 to mm day-1.
@@ -62,7 +64,7 @@ def main(inargs):


 if __name__ == '__main__':
-    description = "Plot the precipitation climatology."
+    description = "Plot the precipitation climatology for a given season."
     parser = argparse.ArgumentParser(description=description)

     parser.add_argument("pr_file", type=str, help="Precipitation data file")</code></pre>
</div>
<p>Now that we can save changes to files and see what we’ve changed —-
how can we restore older versions of things? Let’s suppose we
accidentally overwrite our file:</p>
<div class="codewrapper sourceCode" id="cb43">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="ex">$</span> echo <span class="st">"whoops"</span> <span class="op">&gt;</span> plot_precipitation_climatology.py</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="ex">$</span> cat plot_precipitation_climatology.py</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">whoops</span></span></code></pre>
</div>
<p><code>git status</code> now tells us that the file has been changed,
but those changes haven’t been staged:</p>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="ex">$</span> git status</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>On branch main
Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git restore &lt;file&gt;..." to discard changes in working directory)

	modified:   plot_precipitation_climatology.py

Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)

	data/
	script_template.py

no changes added to commit (use "git add" and/or "git commit -a")</code></pre>
</div>
<p>We can put things back the way they were at the time of our last
commit by using <code>git restore</code>:</p>
<div class="codewrapper sourceCode" id="cb47">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="ex">$</span> git restore plot_precipitation_climatology.py</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="ex">$</span> cat plot_precipitation_climatology</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>import argparse

import xarray as xr
import cartopy.crs as ccrs
...</code></pre>
</div>
<p>The random comment that we inserted has been lost (that change hadn’t
been committed) but everything else that was in our last commit is
there.</p>
<div id="checking-out-with-git" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="checking-out-with-git" class="callout-inner">
<h3 class="callout-title">Checking out with Git<a class="anchor" aria-label="anchor" href="#checking-out-with-git"></a>
</h3>
<div class="callout-content">
<p>If you’re running a different version of Git, you may see a
suggestion for <code>git checkout</code> instead of
<code>git restore</code>. As of Git version 2.29,
<code>git restore</code> is still an experimental command and operates
as a specialized form of <code>git checkout</code>.
<code>git checkout HEAD plot_precipitation_climatology</code> is the
equivalent command.</p>
</div>
</div>
</div>
<div id="plot_precipitation_climatology.py" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="plot_precipitation_climatology.py" class="callout-inner">
<h3 class="callout-title">plot_precipitation_climatology.py<a class="anchor" aria-label="anchor" href="#plot_precipitation_climatology.py"></a>
</h3>
<div class="callout-content">
<p>At the conclusion of this lesson your
<code>plot_precipitation_climatology.py</code> script should look
something like the following:</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb49">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb49-4"><a href="#cb49-4" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb49-5"><a href="#cb49-5" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb49-6"><a href="#cb49-6" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb49-7"><a href="#cb49-7" tabindex="-1"></a><span class="im">import</span> cmocean</span>
<span id="cb49-8"><a href="#cb49-8" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" tabindex="-1"></a><span class="kw">def</span> convert_pr_units(da):</span>
<span id="cb49-11"><a href="#cb49-11" tabindex="-1"></a>    <span class="co">"""Convert kg m-2 s-1 to mm day-1.</span></span>
<span id="cb49-12"><a href="#cb49-12" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb49-13"><a href="#cb49-13" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb49-14"><a href="#cb49-14" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Precipitation data</span></span>
<span id="cb49-15"><a href="#cb49-15" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb49-16"><a href="#cb49-16" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb49-17"><a href="#cb49-17" tabindex="-1"></a>    </span>
<span id="cb49-18"><a href="#cb49-18" tabindex="-1"></a>    da.data <span class="op">=</span> da.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb49-19"><a href="#cb49-19" tabindex="-1"></a>    da.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb49-20"><a href="#cb49-20" tabindex="-1"></a>   </span>
<span id="cb49-21"><a href="#cb49-21" tabindex="-1"></a>    <span class="cf">return</span> darray</span>
<span id="cb49-22"><a href="#cb49-22" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" tabindex="-1"></a></span>
<span id="cb49-24"><a href="#cb49-24" tabindex="-1"></a><span class="kw">def</span> create_plot(clim, model, season, gridlines<span class="op">=</span><span class="va">False</span>, levels<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb49-25"><a href="#cb49-25" tabindex="-1"></a>    <span class="co">"""Plot the precipitation climatology.</span></span>
<span id="cb49-26"><a href="#cb49-26" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb49-27"><a href="#cb49-27" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb49-28"><a href="#cb49-28" tabindex="-1"></a><span class="co">      clim (xarray.DataArray): Precipitation climatology data</span></span>
<span id="cb49-29"><a href="#cb49-29" tabindex="-1"></a><span class="co">      model (str): Name of the climate model</span></span>
<span id="cb49-30"><a href="#cb49-30" tabindex="-1"></a><span class="co">      season (str): Season</span></span>
<span id="cb49-31"><a href="#cb49-31" tabindex="-1"></a><span class="co">      </span></span>
<span id="cb49-32"><a href="#cb49-32" tabindex="-1"></a><span class="co">    Kwargs:</span></span>
<span id="cb49-33"><a href="#cb49-33" tabindex="-1"></a><span class="co">      gridlines (bool): Select whether to plot gridlines</span></span>
<span id="cb49-34"><a href="#cb49-34" tabindex="-1"></a><span class="co">      levels (list): Tick marks on the colorbar    </span></span>
<span id="cb49-35"><a href="#cb49-35" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb49-36"><a href="#cb49-36" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb49-37"><a href="#cb49-37" tabindex="-1"></a></span>
<span id="cb49-38"><a href="#cb49-38" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> levels:</span>
<span id="cb49-39"><a href="#cb49-39" tabindex="-1"></a>        levels <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb49-40"><a href="#cb49-40" tabindex="-1"></a>        </span>
<span id="cb49-41"><a href="#cb49-41" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb49-42"><a href="#cb49-42" tabindex="-1"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb49-43"><a href="#cb49-43" tabindex="-1"></a>    clim.sel(season<span class="op">=</span>season).plot.contourf(</span>
<span id="cb49-44"><a href="#cb49-44" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb49-45"><a href="#cb49-45" tabindex="-1"></a>        levels<span class="op">=</span>levels,</span>
<span id="cb49-46"><a href="#cb49-46" tabindex="-1"></a>        extend<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb49-47"><a href="#cb49-47" tabindex="-1"></a>        transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb49-48"><a href="#cb49-48" tabindex="-1"></a>        cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: clim.units},</span>
<span id="cb49-49"><a href="#cb49-49" tabindex="-1"></a>        cmap<span class="op">=</span>cmocean.cm.haline_r</span>
<span id="cb49-50"><a href="#cb49-50" tabindex="-1"></a>    )</span>
<span id="cb49-51"><a href="#cb49-51" tabindex="-1"></a>    ax.coastlines()</span>
<span id="cb49-52"><a href="#cb49-52" tabindex="-1"></a>    <span class="cf">if</span> gridlines:</span>
<span id="cb49-53"><a href="#cb49-53" tabindex="-1"></a>        plt.gca().gridlines()</span>
<span id="cb49-54"><a href="#cb49-54" tabindex="-1"></a>    </span>
<span id="cb49-55"><a href="#cb49-55" tabindex="-1"></a>    title <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss"> precipitation climatology (</span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb49-56"><a href="#cb49-56" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb49-57"><a href="#cb49-57" tabindex="-1"></a></span>
<span id="cb49-58"><a href="#cb49-58" tabindex="-1"></a></span>
<span id="cb49-59"><a href="#cb49-59" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb49-60"><a href="#cb49-60" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb49-61"><a href="#cb49-61" tabindex="-1"></a></span>
<span id="cb49-62"><a href="#cb49-62" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(inargs.pr_file)</span>
<span id="cb49-63"><a href="#cb49-63" tabindex="-1"></a>    </span>
<span id="cb49-64"><a href="#cb49-64" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>)</span>
<span id="cb49-65"><a href="#cb49-65" tabindex="-1"></a>    clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb49-66"><a href="#cb49-66" tabindex="-1"></a></span>
<span id="cb49-67"><a href="#cb49-67" tabindex="-1"></a>    create_plot(</span>
<span id="cb49-68"><a href="#cb49-68" tabindex="-1"></a>        clim,</span>
<span id="cb49-69"><a href="#cb49-69" tabindex="-1"></a>        ds.attrs[<span class="st">"source_id"</span>],</span>
<span id="cb49-70"><a href="#cb49-70" tabindex="-1"></a>        inargs.season,</span>
<span id="cb49-71"><a href="#cb49-71" tabindex="-1"></a>        gridlines<span class="op">=</span>inargs.gridlines,</span>
<span id="cb49-72"><a href="#cb49-72" tabindex="-1"></a>        levels<span class="op">=</span>inargs.cbar_levels</span>
<span id="cb49-73"><a href="#cb49-73" tabindex="-1"></a>    )</span>
<span id="cb49-74"><a href="#cb49-74" tabindex="-1"></a>    plt.savefig(</span>
<span id="cb49-75"><a href="#cb49-75" tabindex="-1"></a>        inargs.output_file,</span>
<span id="cb49-76"><a href="#cb49-76" tabindex="-1"></a>        dpi<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb49-77"><a href="#cb49-77" tabindex="-1"></a>        bbox_inches<span class="op">=</span><span class="st">"tight"</span>,</span>
<span id="cb49-78"><a href="#cb49-78" tabindex="-1"></a>        facecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb49-79"><a href="#cb49-79" tabindex="-1"></a>    )</span>
<span id="cb49-80"><a href="#cb49-80" tabindex="-1"></a></span>
<span id="cb49-81"><a href="#cb49-81" tabindex="-1"></a></span>
<span id="cb49-82"><a href="#cb49-82" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb49-83"><a href="#cb49-83" tabindex="-1"></a>    description <span class="op">=</span> <span class="st">"Plot the precipitation climatology for a given season."</span></span>
<span id="cb49-84"><a href="#cb49-84" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span>description)</span>
<span id="cb49-85"><a href="#cb49-85" tabindex="-1"></a>   </span>
<span id="cb49-86"><a href="#cb49-86" tabindex="-1"></a>    parser.add_argument(<span class="st">"pr_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Precipitation data file"</span>)</span>
<span id="cb49-87"><a href="#cb49-87" tabindex="-1"></a>    parser.add_argument(<span class="st">"season"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Season to plot"</span>)</span>
<span id="cb49-88"><a href="#cb49-88" tabindex="-1"></a>    parser.add_argument(<span class="st">"output_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Output file name"</span>)</span>
<span id="cb49-89"><a href="#cb49-89" tabindex="-1"></a></span>
<span id="cb49-90"><a href="#cb49-90" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb49-91"><a href="#cb49-91" tabindex="-1"></a>        <span class="st">"--gridlines"</span>,</span>
<span id="cb49-92"><a href="#cb49-92" tabindex="-1"></a>        action<span class="op">=</span><span class="st">"store_true"</span>,</span>
<span id="cb49-93"><a href="#cb49-93" tabindex="-1"></a>        default<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb49-94"><a href="#cb49-94" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Include gridlines on the plot"</span>,</span>
<span id="cb49-95"><a href="#cb49-95" tabindex="-1"></a>    )</span>
<span id="cb49-96"><a href="#cb49-96" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb49-97"><a href="#cb49-97" tabindex="-1"></a>        <span class="st">"--cbar_levels"</span>,</span>
<span id="cb49-98"><a href="#cb49-98" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>,</span>
<span id="cb49-99"><a href="#cb49-99" tabindex="-1"></a>        nargs<span class="op">=</span><span class="st">"*"</span>,</span>
<span id="cb49-100"><a href="#cb49-100" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb49-101"><a href="#cb49-101" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"list of levels / tick marks to appear on the colorbar"</span>,</span>
<span id="cb49-102"><a href="#cb49-102" tabindex="-1"></a>    )</span>
<span id="cb49-103"><a href="#cb49-103" tabindex="-1"></a></span>
<span id="cb49-104"><a href="#cb49-104" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb49-105"><a href="#cb49-105" tabindex="-1"></a>    main(args)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Use <code>git config</code> to configure a user name, email address,
editor, and other preferences once per machine.</li>
<li>
<code>git init</code> initializes a repository.</li>
<li>
<code>git status</code> shows the status of a repository.</li>
<li>Files can be stored in a project’s working directory (which users
see), the staging area (where the next commit is being built up) and the
local repository (where commits are permanently recorded).</li>
<li>
<code>git add</code> puts files in the staging area.</li>
<li>
<code>git commit</code> saves the staged content as a new commit in
the local repository.</li>
<li>Always write a log message when committing changes.</li>
<li>
<code>git diff</code> displays differences between commits.</li>
<li>
<code>git restore</code> recovers old versions of files.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-06-github"><p>Content from <a href="06-github.html">GitHub</a></p>
<hr>
<p>Last updated on 2024-07-25 |

        <a href="https://github.com/fishtree-attempt/python-aos-lesson/edit/main/episodes/06-github.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I make my code available on GitHub?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Explain what remote repositories are and why they are useful.</li>
<li>Push to or pull from a remote repository.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="follow-along" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="follow-along" class="callout-inner">
<h3 class="callout-title">Follow along<a class="anchor" aria-label="anchor" href="#follow-along"></a>
</h3>
<div class="callout-content">
<p>For this lesson participants follow along command by command, rather
than observing and then completing challenges afterwards.</p>
</div>
</div>
</div>
<section><h2 class="section-heading" id="creating-a-remote-repository">Creating a remote repository<a class="anchor" aria-label="anchor" href="#creating-a-remote-repository"></a>
<a class="anchor" aria-label="anchor" href="#creating-a-remote-repository"></a>
</h2>
<hr class="half-width">
<p>Version control really comes into its own when we begin to
collaborate with other people (including ourselves for those who work on
multiple computers). We already have most of the machinery we need to do
this; the only thing missing is to copy changes from one repository to
another.</p>
<p>Systems like Git allow us to move work between any two repositories.
In practice, though, it’s easiest to use one copy as a central hub, and
to keep it on the web rather than on someone’s laptop. Most programmers
use hosting services like <a href="https://github.com" class="external-link">GitHub</a>, <a href="https://bitbucket.org" class="external-link">BitBucket</a> or <a href="https://gitlab.com/" class="external-link">GitLab</a> to hold those master copies.</p>
<p>Let’s start by sharing the changes we’ve made to our current project
with the world. Log in to GitHub, then click on the icon in the top
right corner to create a new repository called
<code>data-carpentry</code>:</p>
<figure><img src="fig/06-github-create-repo-01.png" alt="Creating a Repository on GitHub (Step 1)" class="figure mx-auto d-block"></figure><p>Name your repository “data-carpentry” and then click “Create
Repository”:</p>
<figure><img src="fig/06-github-create-repo-02.png" alt="Creating a Repository on GitHub (Step 2)" class="figure mx-auto d-block"></figure><p>As soon as the repository is created, GitHub displays a page with a
URL and some information on how to configure your local repository:</p>
<figure><img src="fig/06-github-create-repo-03.png" alt="Creating a Repository on GitHub (Step 3)" class="figure mx-auto d-block"></figure><p>This effectively does the following on GitHub’s servers:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">$</span> mkdir data-carpentry</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">$</span> cd data-carpentry</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="ex">$</span> git init</span></code></pre>
</div>
<p>Our local repository still contains our earlier work on
<code>plot_precipitation_climatology.py</code>, but the remote
repository on GitHub doesn’t contain any files yet.</p>
<p>The next step is to connect the two repositories. We do this by
making the GitHub repository a “remote” for the local repository. The
home page of the repository on GitHub includes the string we need to
identify it:</p>
<figure><img src="fig/06-github-find-repo-string.png" alt="Where to Find Repository URL on GitHub" class="figure mx-auto d-block"></figure><p>Click on the ‘SSH’ link to change the protocol from HTTPS to SSH if
SSH isn’t already selected.</p>
<div id="https-vs.-ssh" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="https-vs.-ssh" class="callout-inner">
<h3 class="callout-title">HTTPS vs. SSH<a class="anchor" aria-label="anchor" href="#https-vs.-ssh"></a>
</h3>
<div class="callout-content">
<p>We use SSH here because, while it requires some additional
configuration, it is a security protocol widely used by many
applications. If you want to use HTTPS instead, you’ll need to create a
<a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" class="external-link">Personal
Access Token</a>.</p>
</div>
</div>
</div>
<p>Copy that location from the browser, go into the local
<code>data-carpentry</code> repository, and run this command:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">$</span> git remote add origin git@github.com:DamienIrving/data-carpentry.git</span></code></pre>
</div>
<p>Make sure to use the location for your repository rather than
Damien’s: the only difference should be your username instead of
<code>DamienIrving</code>.</p>
<p>We can check that the command has worked by running
<code>git remote -v</code>:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">$</span> git remote <span class="at">-v</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>origin   git@github.com/DamienIrving/data-carpentry.git (push)
origin   git@github.com/DamienIrving/data-carpentry.git (fetch)</code></pre>
</div>
<p>The name <code>origin</code> is a local nickname for your remote
repository. We could use something else if we wanted to, but
<code>origin</code> is by far the most common choice.</p>
</section><section><h2 class="section-heading" id="connecting-to-github-with-ssh">Connecting to GitHub with SSH<a class="anchor" aria-label="anchor" href="#connecting-to-github-with-ssh"></a>
<a class="anchor" aria-label="anchor" href="#connecting-to-github-with-ssh"></a>
</h2>
<hr class="half-width">
<p>Before we can connect to our remote repository, we need to set up a
way for our computer to authenticate with GitHub so it knows it’s us
trying to connect to our remote repository.</p>
<p>We are going to set up the method that is commonly used by many
different services to authenticate access on the command line. This
method is called Secure Shell Protocol (SSH). SSH is a cryptographic
network protocol that allows secure communication between computers
using an otherwise insecure network.</p>
<p>SSH uses what is called a key pair. This is two keys that work
together to validate access. One key is publicly known and called the
public key, and the other key called the private key is kept private.
Very descriptive names.</p>
<p>You can think of the public key as a padlock, and only you have the
key (the private key) to open it. You use the public key where you want
a secure method of communication, such as your GitHub account. You give
this padlock, or public key, to GitHub and say “lock the communications
to my account with this so that only computers that have my private key
can unlock communications and send git commands as my GitHub
account.”</p>
<p>What we will do now is the minimum required to set up the SSH keys
and add the public key to a GitHub account.</p>
<div id="keeping-your-keys-secure" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="keeping-your-keys-secure" class="callout-inner">
<h3 class="callout-title">Keeping your keys secure<a class="anchor" aria-label="anchor" href="#keeping-your-keys-secure"></a>
</h3>
<div class="callout-content">
<p>You shouldn’t really forget about your SSH keys, since they keep your
account secure. It’s good practice to audit your secure shell keys every
so often. Especially if you are using multiple computers to access your
account.</p>
</div>
</div>
</div>
<p>The first thing we are going to do is check if this has already been
done on the computer we’re on. Because generally speaking, this setup
only needs to happen once and then you can forget about it. We can run
the list command to check what key pairs already exist on our
computer.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-al</span> ~/.ssh</span></code></pre>
</div>
<p>(Your output is going to look a little different depending on whether
or not SSH has ever been set up on the computer you are using.)</p>
<p>I have not set up SSH on my computer, so my output is</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>ls: cannot access '/home/damien/.ssh': No such file or directory</code></pre>
</div>
<p>If SSH has been set up on the computer you’re using, the public and
private key pairs will be listed. The file names are either
<code>id_ed25519</code>/<code>id_ed25519.pub</code> or
<code>id_rsa</code>/<code>id_rsa.pub</code> depending on how the key
pairs were set up.</p>
<p>If they don’t exist on your computer, you can use this command to
create them.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">$</span> ssh-keygen <span class="at">-t</span> ed25519 <span class="at">-C</span> <span class="st">"you@email.com"</span></span></code></pre>
</div>
<p>The <code>-t</code> option specifies which type of algorithm to use
and <code>-C</code> attaches a comment to the key (here, your
email).</p>
<p>If you are using a legacy system that doesn’t support the Ed25519
algorithm, use:<br><code>$ ssh-keygen -t rsa -b 4096 -C "you@email.com"</code></p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Generating public/private ed25519 key pair.
Enter file in which to save the key (/home/damien/.ssh/id_ed25519):</code></pre>
</div>
<p>We want to use the default file, so just press <kbd>Enter</kbd>.</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Created directory '/home/damien/.ssh'.
Enter passphrase (empty for no passphrase):</code></pre>
</div>
<p>Now, it is prompting us for a passphrase. If you’re using a laptop
that other people sometimes have access to, you might want to create a
passphrase. Be sure to use something memorable or save your passphrase
somewhere, as there is no “reset my password” option.</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Enter same passphrase again:</code></pre>
</div>
<p>After entering the same passphrase a second time, we receive the
confirmation.</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Your identification has been saved in /home/damien/.ssh/id_ed25519
Your public key has been saved in /home/damien/.ssh/id_ed25519.pub
The key fingerprint is:
SHA256:SMSPIStNyA00KPxuYu94KpZgRAYjgt9g4BA4kFy3g1o you@email.com
The key's randomart image is:
+--[ED25519 256]--+
|^B== o.          |
|%*=.*.+          |
|+=.E =.+         |
| .=.+.o..        |
|....  . S        |
|.+ o             |
|+ =              |
|.o.o             |
|oo+.             |
+----[SHA256]-----+</code></pre>
</div>
<p>The “identification” is actually the private key. You should never
share it. The public key is appropriately named. The “key fingerprint”
is a shorter version of a public key.</p>
<p>Now that we have generated the SSH keys, we will find the SSH files
when we check.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-al</span> ~/.ssh</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>drwxr-xr-x 1 Damien  staff  197121   0 Jul 16 14:48 ./
drwxr-xr-x 1 Damien  staff  197121   0 Jul 16 14:48 ../
-rw-r--r-- 1 Damien  staff  197121 419 Jul 16 14:48 id_ed25519
-rw-r--r-- 1 Damien  staff  197121 106 Jul 16 14:48 id_ed25519.pub</code></pre>
</div>
<p>Now we have a SSH key pair and we can run this command to check if
GitHub can read our authentication.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-T</span> git@github.com</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>The authenticity of host 'github.com (192.30.255.112)' can't be established.
RSA key fingerprint is SHA256:nThbg6kXUpJWGl7E1IGOCspRomTxdCARLviKw6E5SY8.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? y
Please type 'yes', 'no' or the fingerprint: yes
Warning: Permanently added 'github.com' (RSA) to the list of known hosts.
git@github.com: Permission denied (publickey).</code></pre>
</div>
<p>Right, we forgot that we need to give GitHub our public key!</p>
<p>First, we need to copy the public key. Be sure to include the
<code>.pub</code> at the end, otherwise you’re looking at the private
key.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">cat</span> ~/.ssh/id_ed25519.pub</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDmRA3d51X0uu9wXek559gfn6UFNF69yZjChyBIU2qKI you@email.com</code></pre>
</div>
<p>Now, going to GitHub.com, click on your profile icon in the top right
corner to get the drop-down menu. Click “Settings,” then on the settings
page, click “SSH and GPG keys,” on the left side “Account settings”
menu. Click the “New SSH key” button on the right side. Now, you can add
a title (e.g. “work laptop” so you can remember where the original key
pair files are located), paste your SSH key into the field, and click
the “Add SSH key” to complete the setup.</p>
<figure><img src="fig/06-github-add-ssh-keys.png" alt="Adding SSH heys on GitHub" class="figure mx-auto d-block"></figure><p>Now that we’ve set that up, let’s check our authentication again from
the command line.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="ex">$</span> ssh <span class="at">-T</span> git@github.com</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Hi Damien! You've successfully authenticated, but GitHub does not provide shell access.</code></pre>
</div>
<p>Good! This output confirms that the SSH key works as intended. We are
now ready to push our work to the remote repository.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="ex">$</span> git push origin main</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Counting objects: 9, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (6/6), done.
Writing objects: 100% (9/9), 821 bytes, done.
Total 9 (delta 2), reused 0 (delta 0)
To github.com:DamienIrving/data-carpentry.git
 * [new branch]      master -&gt; master
Branch master set up to track remote branch master from origin.</code></pre>
</div>
<p>We can pull changes from the remote repository to the local one as
well:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="ex">$</span> git pull origin main</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>From github.com:DamienIrving/data-carpentry.git
 * branch            master     -&gt; FETCH_HEAD
Already up-to-date.</code></pre>
</div>
<p>Pulling has no effect in this case because the two repositories are
already synchronised. If someone else had pushed some changes to the
repository on GitHub, though, this command would download them to our
local repository.</p>
</section><section><h2 class="section-heading" id="sharing-code-with-yourself-or-others">Sharing code with yourself or others<a class="anchor" aria-label="anchor" href="#sharing-code-with-yourself-or-others"></a>
<a class="anchor" aria-label="anchor" href="#sharing-code-with-yourself-or-others"></a>
</h2>
<hr class="half-width">
<p>If we logged onto a different computer (e.g. a supercomputing
facility or our desktop computer at home) we could access a copy of our
code by “cloning” it.</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="ex">$</span> git clone git@github.com:DamienIrving/data-carpentry.git</span></code></pre>
</div>
<p>Since our repository is public, anyone (e.g. research collaborators)
could clone the repository by getting the location from the
corresponding page on GitHub:</p>
<figure><img src="fig/06-github-clone.png" alt="Cloning a repository on GitHub" class="figure mx-auto d-block"></figure><div id="working-with-others" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="working-with-others" class="callout-inner">
<h3 class="callout-title">Working with others<a class="anchor" aria-label="anchor" href="#working-with-others"></a>
</h3>
<div class="callout-content">
<p>Someone who clones your repository can’t push changes directly to it
(unless you add them as a collaborator). They could, however, “fork”
your repository and submit suggested changes via a “pull request”.
Collaborators and pull requests are beyond the scope of this lesson, but
you may come across them as you get more experienced with using git and
GitHub.</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>A local Git repository can be connected to one or more remote
repositories.</li>
<li>You can use the SSH protocol to connect to remote repositories.</li>
<li>
<code>git push</code> copies changes from a local repository to a
remote repository.</li>
<li>
<code>git pull</code> copies changes from a remote repository to a
local repository.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-07-vectorisation"><p>Content from <a href="07-vectorisation.html">Vectorisation</a></p>
<hr>
<p>Last updated on 2024-07-25 |

        <a href="https://github.com/fishtree-attempt/python-aos-lesson/edit/main/episodes/07-vectorisation.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I avoid looping over each element of large data arrays?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Use surface land fraction data to mask the land or ocean.</li>
<li>Use the vectorised operations available in the <code>numpy</code>
library to avoid looping over array elements.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>A useful addition to our
<code>plot_precipitation_climatology.py</code> script would be the
option to apply a land or ocean mask. To do this, we need to use the
land area fraction file.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>accesscm2_sftlf_file <span class="op">=</span> <span class="st">"data/sftlf_fx_ACCESS-CM2_historical_r1i1p1f1_gn.nc"</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>ds <span class="op">=</span> xr.open_dataset(accesscm2_sftlf_file)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>sftlf <span class="op">=</span> ds[<span class="st">"sftlf"</span>]</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="bu">print</span>(sftlf)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;xarray.DataArray 'sftlf' (lat: 144, lon: 192)&gt;
array([[100., 100., 100., ..., 100., 100., 100.],
       [100., 100., 100., ..., 100., 100., 100.],
       [100., 100., 100., ..., 100., 100., 100.],
       ...,
       [  0.,   0.,   0., ...,   0.,   0.,   0.],
       [  0.,   0.,   0., ...,   0.,   0.,   0.],
       [  0.,   0.,   0., ...,   0.,   0.,   0.]], dtype=float32)
Coordinates:
  * lat      (lat) float64 -89.38 -88.12 -86.88 -85.62 ... 86.88 88.12 89.38
  * lon      (lon) float64 0.9375 2.812 4.688 6.562 ... 353.4 355.3 357.2 359.1
Attributes:
    standard_name:   land_area_fraction
    long_name:       Percentage of the grid  cell occupied by land (including...
    comment:         Percentage of horizontal area occupied by land.
    units:           %
    original_units:  1
    history:         2019-11-09T02:47:20Z altered by CMOR: Converted units fr...
    cell_methods:    area: mean
    cell_measures:   area: areacella</code></pre>
</div>
<p>The data in a sftlf file assigns each grid cell a percentage value
between 0% (no land) to 100% (all land).</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="bu">print</span>(sftlf.data.<span class="bu">max</span>())</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="bu">print</span>(sftlf.data.<span class="bu">min</span>())</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fl">100.0</span></span>
<span><span class="fl">0.0</span></span></code></pre>
</div>
<p>To apply a mask to our plot, the value of all the data points we’d
like to mask needs to be set to <code>np.nan</code>. The most obvious
solution to applying a land mask, for example, might therefore be to
loop over each cell in our data array and decide whether it is a land
point (and thus needs to be set to <code>np.nan</code>).</p>
<p>(For this example, we are going to define land as any grid point that
is more than 50% land.)</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>ds <span class="op">=</span> xr.open_dataset(<span class="st">"data/pr_Amon_ACCESS-CM2_historical_r1i1p1f1_gn_201001-201412.nc"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>clim <span class="op">=</span> ds[<span class="st">'pr'</span>].mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>nlats, nlons <span class="op">=</span> clim.data.shape</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(nlats):</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(nlons):</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>        <span class="cf">if</span> sftlf.data[y, x] <span class="op">&gt;</span> <span class="dv">50</span>:</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>            clim.data[y, x] <span class="op">=</span> np.nan</span></code></pre>
</div>
<p>While this approach technically works, the problem is that (a) the
code is hard to read, and (b) in contrast to low level languages like
Fortran and C, high level languages like Python and Matlab are built for
usability (i.e. they make it easy to write concise, readable code) as
opposed to speed. This particular array is so small that the looping
isn’t noticably slow, but in general looping over every data point in an
array should be avoided.</p>
<p>Fortunately, there are lots of numpy functions (which are written in
C under the hood) that allow you to get around this problem by applying
a particular operation to an entire array at once (which is known as a
vectorised operation). The <code>np.where</code> function, for instance,
allows you to make a true/false decision at each data point in the array
and then perform a different action depending on the answer.</p>
<p>The developers of xarray have built-in the <code>np.where</code>
functionality, so creating a new DataArray with the land masked becomes
a one-line command:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>clim_ocean <span class="op">=</span> clim.where(sftlf.data <span class="op">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="bu">print</span>(clim_ocean)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;xarray.DataArray 'pr' (lat: 144, lon: 192)&gt;
array([[          nan,           nan,           nan, ...,           nan,
                  nan,           nan],
       [          nan,           nan,           nan, ...,           nan,
                  nan,           nan],
       [          nan,           nan,           nan, ...,           nan,
                  nan,           nan],
       ...,
       [7.5109556e-06, 7.4777777e-06, 7.4689174e-06, ..., 7.3359679e-06,
        7.3987890e-06, 7.3978440e-06],
       [7.1837171e-06, 7.1722038e-06, 7.1926393e-06, ..., 7.1552149e-06,
        7.1576678e-06, 7.1592167e-06],
       [7.0353467e-06, 7.0403985e-06, 7.0326828e-06, ..., 7.0392648e-06,
        7.0387587e-06, 7.0304386e-06]], dtype=float32)
Coordinates:
  * lon      (lon) float64 0.9375 2.812 4.688 6.562 ... 353.4 355.3 357.2 359.1
  * lat      (lat) float64 -89.38 -88.12 -86.88 -85.62 ... 86.88 88.12 89.38
Attributes:
    standard_name:  precipitation_flux
    long_name:      Precipitation
    units:          kg m-2 s-1
    comment:        includes both liquid and solid phases
    cell_methods:   area: time: mean
    cell_measures:  area: areacella</code></pre>
</div>
<div id="mask-option" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="mask-option" class="callout-inner">
<h3 class="callout-title">Mask option<a class="anchor" aria-label="anchor" href="#mask-option"></a>
</h3>
<div class="callout-content">
<p>Modify <code>plot_precipitation_climatology.py</code> so that the
user can choose to apply a mask via the following <code>argparse</code>
option:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>parser.add_argument(</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    <span class="st">"--mask"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>    nargs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    metavar<span class="op">=</span>(<span class="st">"SFTLF_FILE"</span>, <span class="st">"REALM"</span>),</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    <span class="bu">help</span><span class="op">=</span><span class="st">"""Provide sftlf file and realm to mask ('land' or 'ocean')"""</span>,</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>)</span></code></pre>
</div>
<p>This should involve defining a new function called
<code>apply_mask()</code>, in order to keep <code>main()</code> short
and readable.</p>
<p>Test to see if your mask worked by plotting the ACCESS-CM2
climatology for JJA:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">$</span> python plot_precipitation_climatology.py data/pr_Amon_ACCESS-CM2_historical_r1i1p1f1_gn_201001-201412.nc JJA pr_Amon_ACCESS-CM2_historical_r1i1p1f1_gn_201001-201412-JJA-clim_land-mask.png <span class="at">--mask</span> data/sftlf_fx_ACCESS-CM2_historical_r1i1p1f1_gn.nc ocean</span></code></pre>
</div>
<figure><img src="fig/07-vectorisation-ocean-mask.png" alt="Ocean masked rainfall plot" class="figure mx-auto d-block"></figure><p>Commit the changes to git and then push to GitHub.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>Make the following additions to
<code>plot_precipitation_climatology.py</code> (code omitted from this
abbreviated version of the script is denoted <code>...</code>):</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">def</span> apply_mask(da, sftlf_file, realm):</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    <span class="co">"""Mask ocean or land using a sftlf (land surface fraction) file.</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">     da (xarray.DataArray): Data to mask</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co">     sftlf_file (str): Land surface fraction file</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co">     realm (str): Realm to mask</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  </span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(sftlf_file)</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  </span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>    <span class="cf">if</span> realm <span class="op">==</span> <span class="st">'land'</span>:</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>        masked_da <span class="op">=</span> da.where(ds[<span class="st">'sftlf'</span>].data <span class="op">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>        masked_da <span class="op">=</span> da.where(ds[<span class="st">'sftlf'</span>].data <span class="op">&gt;</span> <span class="dv">50</span>)   </span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>  </span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>    <span class="cf">return</span> masked_da</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>...</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(inargs.pr_file)</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>   </span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>    clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>    <span class="cf">if</span> inargs.mask:</span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>        sftlf_file, realm <span class="op">=</span> inargs.mask</span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>        clim <span class="op">=</span> apply_mask(clim, sftlf_file, realm)</span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>    ...</span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a>    description <span class="op">=</span> <span class="st">"Plot the precipitation climatology for a given season."</span></span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span>description)</span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a>    ...</span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a>   </span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a>        <span class="st">"--mask"</span>,</span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a>        nargs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a>        metavar<span class="op">=</span>(<span class="st">"SFTLF_FILE"</span>, <span class="st">"REALM"</span>),</span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"""Provide sftlf file and realm to mask ('land' or 'ocean')"""</span>,</span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a>    )</span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a></span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()            </span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a>    main(args)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="plot_precipitation_climatology.py" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="plot_precipitation_climatology.py" class="callout-inner">
<h3 class="callout-title">plot_precipitation_climatology.py<a class="anchor" aria-label="anchor" href="#plot_precipitation_climatology.py"></a>
</h3>
<div class="callout-content">
<p>At the conclusion of this lesson your
<code>plot_precipitation_climatology.py</code> script should look
something like the following:</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="im">import</span> cmocean</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="kw">def</span> convert_pr_units(da):</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    <span class="co">"""Convert kg m-2 s-1 to mm day-1.</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Precipitation data</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>   </span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>    da.data <span class="op">=</span> da.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>    da.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>   </span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>    <span class="cf">return</span> da</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a><span class="kw">def</span> apply_mask(da, sftlf_file, realm):</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>    <span class="co">"""Mask ocean or land using a sftlf (land surface fraction) file.</span></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Data to mask</span></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a><span class="co">      sftlf_file (str): Land surface fraction file</span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a><span class="co">      realm (str): Realm to mask</span></span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>  </span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(sftlf_file)</span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a>  </span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>    <span class="cf">if</span> realm <span class="op">==</span> <span class="st">'land'</span>:</span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a>        masked_da <span class="op">=</span> da.where(ds[<span class="st">'sftlf'</span>].data <span class="op">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a>        masked_da <span class="op">=</span> da.where(ds[<span class="st">'sftlf'</span>].data <span class="op">&gt;</span> <span class="dv">50</span>)   </span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a>   </span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a>    <span class="cf">return</span> masked_da</span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a><span class="kw">def</span> create_plot(clim, model, season, gridlines<span class="op">=</span><span class="va">False</span>, levels<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a>    <span class="co">"""Plot the precipitation climatology.</span></span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a><span class="co">      clim (xarray.DataArray): Precipitation climatology data</span></span>
<span id="cb11-49"><a href="#cb11-49" tabindex="-1"></a><span class="co">      model (str): Name of the climate model</span></span>
<span id="cb11-50"><a href="#cb11-50" tabindex="-1"></a><span class="co">      season (str): Season</span></span>
<span id="cb11-51"><a href="#cb11-51" tabindex="-1"></a><span class="co">     </span></span>
<span id="cb11-52"><a href="#cb11-52" tabindex="-1"></a><span class="co">    Kwargs:</span></span>
<span id="cb11-53"><a href="#cb11-53" tabindex="-1"></a><span class="co">      gridlines (bool): Select whether to plot gridlines</span></span>
<span id="cb11-54"><a href="#cb11-54" tabindex="-1"></a><span class="co">      levels (list): Tick marks on the colorbar    </span></span>
<span id="cb11-55"><a href="#cb11-55" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-56"><a href="#cb11-56" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-57"><a href="#cb11-57" tabindex="-1"></a></span>
<span id="cb11-58"><a href="#cb11-58" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> levels:</span>
<span id="cb11-59"><a href="#cb11-59" tabindex="-1"></a>        levels <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb11-60"><a href="#cb11-60" tabindex="-1"></a>       </span>
<span id="cb11-61"><a href="#cb11-61" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb11-62"><a href="#cb11-62" tabindex="-1"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb11-63"><a href="#cb11-63" tabindex="-1"></a>    clim.sel(season<span class="op">=</span>season).plot.contourf(</span>
<span id="cb11-64"><a href="#cb11-64" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb11-65"><a href="#cb11-65" tabindex="-1"></a>        levels<span class="op">=</span>levels,</span>
<span id="cb11-66"><a href="#cb11-66" tabindex="-1"></a>        extend<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb11-67"><a href="#cb11-67" tabindex="-1"></a>        transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb11-68"><a href="#cb11-68" tabindex="-1"></a>        cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: clim.units},</span>
<span id="cb11-69"><a href="#cb11-69" tabindex="-1"></a>        cmap<span class="op">=</span>cmocean.cm.haline_r</span>
<span id="cb11-70"><a href="#cb11-70" tabindex="-1"></a>    )</span>
<span id="cb11-71"><a href="#cb11-71" tabindex="-1"></a>    ax.coastlines()</span>
<span id="cb11-72"><a href="#cb11-72" tabindex="-1"></a>    <span class="cf">if</span> gridlines:</span>
<span id="cb11-73"><a href="#cb11-73" tabindex="-1"></a>        plt.gca().gridlines()</span>
<span id="cb11-74"><a href="#cb11-74" tabindex="-1"></a>    </span>
<span id="cb11-75"><a href="#cb11-75" tabindex="-1"></a>    title <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss"> precipitation climatology (</span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb11-76"><a href="#cb11-76" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb11-77"><a href="#cb11-77" tabindex="-1"></a></span>
<span id="cb11-78"><a href="#cb11-78" tabindex="-1"></a></span>
<span id="cb11-79"><a href="#cb11-79" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb11-80"><a href="#cb11-80" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb11-81"><a href="#cb11-81" tabindex="-1"></a></span>
<span id="cb11-82"><a href="#cb11-82" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(inargs.pr_file)</span>
<span id="cb11-83"><a href="#cb11-83" tabindex="-1"></a>    </span>
<span id="cb11-84"><a href="#cb11-84" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-85"><a href="#cb11-85" tabindex="-1"></a>    clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb11-86"><a href="#cb11-86" tabindex="-1"></a></span>
<span id="cb11-87"><a href="#cb11-87" tabindex="-1"></a>    <span class="cf">if</span> inargs.mask:</span>
<span id="cb11-88"><a href="#cb11-88" tabindex="-1"></a>        sftlf_file, realm <span class="op">=</span> inargs.mask</span>
<span id="cb11-89"><a href="#cb11-89" tabindex="-1"></a>        clim <span class="op">=</span> apply_mask(clim, sftlf_file, realm)</span>
<span id="cb11-90"><a href="#cb11-90" tabindex="-1"></a></span>
<span id="cb11-91"><a href="#cb11-91" tabindex="-1"></a>    create_plot(</span>
<span id="cb11-92"><a href="#cb11-92" tabindex="-1"></a>        clim,</span>
<span id="cb11-93"><a href="#cb11-93" tabindex="-1"></a>        ds.attrs[<span class="st">"source_id"</span>],</span>
<span id="cb11-94"><a href="#cb11-94" tabindex="-1"></a>        inargs.season,</span>
<span id="cb11-95"><a href="#cb11-95" tabindex="-1"></a>        gridlines<span class="op">=</span>inargs.gridlines,</span>
<span id="cb11-96"><a href="#cb11-96" tabindex="-1"></a>        levels<span class="op">=</span>inargs.cbar_levels</span>
<span id="cb11-97"><a href="#cb11-97" tabindex="-1"></a>    )</span>
<span id="cb11-98"><a href="#cb11-98" tabindex="-1"></a>    plt.savefig(</span>
<span id="cb11-99"><a href="#cb11-99" tabindex="-1"></a>        inargs.output_file,</span>
<span id="cb11-100"><a href="#cb11-100" tabindex="-1"></a>        dpi<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb11-101"><a href="#cb11-101" tabindex="-1"></a>        bbox_inches<span class="op">=</span><span class="st">"tight"</span>,</span>
<span id="cb11-102"><a href="#cb11-102" tabindex="-1"></a>        facecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb11-103"><a href="#cb11-103" tabindex="-1"></a>    )</span>
<span id="cb11-104"><a href="#cb11-104" tabindex="-1"></a></span>
<span id="cb11-105"><a href="#cb11-105" tabindex="-1"></a></span>
<span id="cb11-106"><a href="#cb11-106" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb11-107"><a href="#cb11-107" tabindex="-1"></a>    description <span class="op">=</span> <span class="st">"Plot the precipitation climatology for a given season."</span></span>
<span id="cb11-108"><a href="#cb11-108" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span>description)</span>
<span id="cb11-109"><a href="#cb11-109" tabindex="-1"></a>   </span>
<span id="cb11-110"><a href="#cb11-110" tabindex="-1"></a>    parser.add_argument(<span class="st">"pr_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Precipitation data file"</span>)</span>
<span id="cb11-111"><a href="#cb11-111" tabindex="-1"></a>    parser.add_argument(<span class="st">"season"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Season to plot"</span>)</span>
<span id="cb11-112"><a href="#cb11-112" tabindex="-1"></a>    parser.add_argument(<span class="st">"output_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Output file name"</span>)</span>
<span id="cb11-113"><a href="#cb11-113" tabindex="-1"></a></span>
<span id="cb11-114"><a href="#cb11-114" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb11-115"><a href="#cb11-115" tabindex="-1"></a>        <span class="st">"--gridlines"</span>,</span>
<span id="cb11-116"><a href="#cb11-116" tabindex="-1"></a>        action<span class="op">=</span><span class="st">"store_true"</span>,</span>
<span id="cb11-117"><a href="#cb11-117" tabindex="-1"></a>        default<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb11-118"><a href="#cb11-118" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Include gridlines on the plot"</span>,</span>
<span id="cb11-119"><a href="#cb11-119" tabindex="-1"></a>    )</span>
<span id="cb11-120"><a href="#cb11-120" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb11-121"><a href="#cb11-121" tabindex="-1"></a>        <span class="st">"--cbar_levels"</span>,</span>
<span id="cb11-122"><a href="#cb11-122" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>,</span>
<span id="cb11-123"><a href="#cb11-123" tabindex="-1"></a>        nargs<span class="op">=</span><span class="st">"*"</span>,</span>
<span id="cb11-124"><a href="#cb11-124" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb11-125"><a href="#cb11-125" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"list of levels / tick marks to appear on the colorbar"</span>,</span>
<span id="cb11-126"><a href="#cb11-126" tabindex="-1"></a>    )</span>
<span id="cb11-127"><a href="#cb11-127" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb11-128"><a href="#cb11-128" tabindex="-1"></a>        <span class="st">"--mask"</span>,</span>
<span id="cb11-129"><a href="#cb11-129" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb11-130"><a href="#cb11-130" tabindex="-1"></a>        nargs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb11-131"><a href="#cb11-131" tabindex="-1"></a>        metavar<span class="op">=</span>(<span class="st">"SFTLF_FILE"</span>, <span class="st">"REALM"</span>),</span>
<span id="cb11-132"><a href="#cb11-132" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb11-133"><a href="#cb11-133" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"""Provide sftlf file and realm to mask ('land' or 'ocean')"""</span>,</span>
<span id="cb11-134"><a href="#cb11-134" tabindex="-1"></a>    )</span>
<span id="cb11-135"><a href="#cb11-135" tabindex="-1"></a></span>
<span id="cb11-136"><a href="#cb11-136" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb11-137"><a href="#cb11-137" tabindex="-1"></a>    main(args)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>For large arrays, looping over each element can be slow in
high-level languages like Python.</li>
<li>Vectorised operations can be used to avoid looping over array
elements.</li>
</ul>
</div>
</div>
</div></section><section id="aio-08-defensive"><p>Content from <a href="08-defensive.html">Defensive programming</a></p>
<hr>
<p>Last updated on 2024-07-25 |

        <a href="https://github.com/fishtree-attempt/python-aos-lesson/edit/main/episodes/08-defensive.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I make my programs more reliable?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Signal errors by raising exceptions.</li>
<li>Use try-except blocks to catch and handle exceptions.</li>
<li>Explain what an assertion is.</li>
<li>Add assertions that check the program’s state is correct.</li>
<li>Use a logging framework to report on program activity.</li>
<li>Identify sources of more advanced lessons on code testing.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="scientists-nightmare" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="scientists-nightmare" class="callout-inner">
<h3 class="callout-title">Scientist’s nightmare<a class="anchor" aria-label="anchor" href="#scientists-nightmare"></a>
</h3>
<div class="callout-content">
<p>If you needed any motivation to learn and employ the principles of
defensive programming, look no further than <a href="https://science.sciencemag.org/content/314/5807/1856" class="external-link">this
article</a>. It documents the experience of a researcher who had to
retract five published papers - three of which were in <em>Science</em>
- because his code had inadvertently switched the rows and columns of a
data table.</p>
</div>
</div>
</div>
<p>Now that we’ve written
<code>plot_precipitation_climatology.py</code>, how can we be sure that
it’s producing reliable results?</p>
<p>The first step toward getting the right answers from our programs is
to assume that mistakes <em>will</em> happen and to guard against them.
This is called defensive programming, and there are a number of tools
and approaches at our disposal for doing this. Broadly speaking, we can
raise and handle errors to check and respond to program inputs, use
assertions to make sure nothing crazy or unexpected has happened, write
unit tests to make sure each component of our program produces expected
outputs, and use a logging framework to report on program activity. In
this lesson, we’ll look at how error handling, assertions and logging
can make the unit conversion in our program more reliable, and we’ll
provide links to further information on unit testing.</p>
<section><h2 class="section-heading" id="types-of-errors">Types of errors<a class="anchor" aria-label="anchor" href="#types-of-errors"></a>
<a class="anchor" aria-label="anchor" href="#types-of-errors"></a>
</h2>
<hr class="half-width">
<p>There are essentially two kinds of errors that can arise in Python:
<em>syntax errors</em> and <em>exceptions</em>. You’re probably familiar
with the former:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>rainfall <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="cf">if</span> rainfall <span class="op">&gt;</span> <span class="dv">10</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"heavy rainfall"</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>    if rainfall &gt; 10
                    ^
SyntaxError: expected ':'</code></pre>
</div>
<p>Once a statement or expression is syntactically correct, it may cause
an error when an attempt is made to execute it. Errors detected during
execution are called exceptions (i.e. an exception from normal
behaviour) and there are lots of different types of exceptions:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="dv">10</span> <span class="op">*</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">0</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>ZeroDivisionError: division by zero</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="dv">4</span> <span class="op">+</span> spam<span class="op">*</span><span class="dv">3</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>NameError: name 'spam' is not defined</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co">"2"</span> <span class="op">+</span> <span class="dv">2</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>TypeError: can only concatenate str (not "int") to str</code></pre>
</div>
</section><section><h2 class="section-heading" id="raising-errors">Raising errors<a class="anchor" aria-label="anchor" href="#raising-errors"></a>
<a class="anchor" aria-label="anchor" href="#raising-errors"></a>
</h2>
<hr class="half-width">
<p>With respect to defensive programming, it can sometimes be useful to
raise your own exceptions (using the <code>raise</code> keyword).</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>infile <span class="op">=</span> <span class="st">"temperature_data.txt"</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>file_format <span class="op">=</span> infile.split(<span class="st">"."</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="cf">if</span> file_format <span class="op">!=</span> <span class="st">"nc"</span>:</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"</span><span class="sc">{</span>infile<span class="sc">}</span><span class="ss"> does not have the netCDF file extension .nc"</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>ValueError                                Traceback (most recent call last)
/var/folders/6v/vrpsky6j509dff7250jyg8240000gp/T/ipykernel_12425/3612736507.py in &lt;module&gt;
      2 file_format = infile.split(".")[-1]
      3 if file_format != "nc":
----&gt; 4     raise ValueError(f"{infile} does not have the netCDF file extension .nc")

ValueError: temperature_data.txt does not have the netCDF file extension .nc</code></pre>
</div>
<p>In this case we’ve chosen to raise a <code>ValueError</code>, but we
could pick any of the <a href="https://docs.python.org/3/library/exceptions.html#exception-hierarchy" class="external-link">builtin
exception types</a> (including just a generic <code>Exception</code>) or
define our own <a href="https://towardsdatascience.com/how-to-define-custom-exception-classes-in-python-bfa346629bca" class="external-link">custom
exception class</a>.</p>
<p>In the context of our <code>plot_precipitation_climatology.py</code>
script, we currently multiply our data by 86400 regardless of what the
input units are. It would be better if we modified the <code>main</code>
function so that the program multiplied by 86400 if the input units are
kg m-2 s-1, performed no unit conversion if the input units are mm/day,
or halted with an informative error message if the input data have some
other units.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>input_units <span class="op">=</span> clim.attrs[<span class="st">"units"</span>]</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="cf">if</span> input_units <span class="op">==</span> <span class="st">"kg m-2 s-1"</span>:</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="cf">elif</span> input_units <span class="op">==</span> <span class="st">"mm/day"</span>:</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"""Input units are not 'kg m-2 s-1' or 'mm/day'"""</span>)</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="handling-errors">Handling errors<a class="anchor" aria-label="anchor" href="#handling-errors"></a>
<a class="anchor" aria-label="anchor" href="#handling-errors"></a>
</h2>
<hr class="half-width">
<p>As we’ve seen in the examples above, if exceptions aren’t dealt with
the program crashes. The error message upon crashing is sometimes be
easy to understand (particularly if you wrote the <code>raise</code>
statement yourself) but can often be cryptic.</p>
<p>If we’d rather the program didn’t crash when a particular exception
occurs, we can use a try-except block to catch and handle the exception.
The syntax of the try-except block is:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>    <span class="op">&lt;</span>do something<span class="op">&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    <span class="op">&lt;</span>handle the error<span class="op">&gt;</span></span></code></pre>
</div>
<p>The code in the except block is only executed if an exception
occurred in the try block. The except block is required with a try
block, even if it contains only the <code>pass</code> statement
(i.e. ignore the exception and carry on). For example, let’s say there’s
a calculation in our program where we need to divide by the number of
available weather stations. If there were no weather stations available,
by default the program would crash.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>quantity <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>n_stations <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>scaled_quantity <span class="op">=</span> quantity <span class="op">/</span> n_stations</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="bu">print</span>(scaled_quantity)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>ZeroDivisionError                         Traceback (most recent call last)
/var/folders/6v/vrpsky6j509dff7250jyg8240000gp/T/ipykernel_12425/3927438267.py in &lt;module&gt;
      2 n_stations = 0
      3
----&gt; 4 scaled_quantity = quantity / n_stations
      5 print(scaled_quantity)

ZeroDivisionError: division by zero</code></pre>
</div>
<p>If we’d prefer the program simply continue with a
<code>scaled_quantity</code> value of NaN, we could catch and handle the
<code>ZeroDivisionError</code>.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>quantity <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>n_stations <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>    scaled_quantity <span class="op">=</span> quantity <span class="op">/</span> n_stations</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ZeroDivisionError</span>:</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>    scaled_quantity <span class="op">=</span> np.nan</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="bu">print</span>(scaled_quantity)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="va">nan</span></span></code></pre>
</div>
<p>In the context of our <code>plot_precipitation_climatology.py</code>
script, the variable attributes from the input netCDF file are stored in
a dictionary that we access via <code>clim.attrs</code>. The dictionary
keys are the names of the variable attributes
(e.g. <code>standard_name</code>, <code>long_name</code>,
<code>units</code>) and the dictionary values are the values
corresponding to those keys (e.g. <code>precipitation_flux</code>,
<code>Precipitation</code>, <code>kg m-2 s-1</code>). If the input data
file didn’t have a units attribute associated with the precipitation
variable, our program would currently fail with a <code>KeyError</code>
(which Python raises when you ask for a key that isn’t in a
dictionary).</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>example_dict <span class="op">=</span> {</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>    <span class="st">"standard_name"</span>: <span class="st">"precipitation_flux"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>    <span class="st">"long_name"</span>: <span class="st">"Precipitation"</span>,</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>}</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>units <span class="op">=</span> example_dict[<span class="st">"units"</span>]</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>KeyError                                  Traceback (most recent call last)
/var/folders/6v/vrpsky6j509dff7250jyg8240000gp/T/ipykernel_12425/2679443625.py in &lt;module&gt;
      1 example_dict = {
      2     "standard_name": "precipitation_flux",
      3     "long_name": "Precipitation",
      4 }
----&gt; 5 units = example_dict["units"]

KeyError: 'units'</code></pre>
</div>
<p>It’s fine that our program would crash in this situation (we can’t
continue if we don’t know the units of the input data), but the error
message doesn’t explicitly tell the user that the input file requires a
units attribute. To make this crystal clear, we could use a try-except
block in the <code>main</code> function to catch the
<code>KeyError</code> and re-define a better error message.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>    input_units <span class="op">=</span> clim.attrs[<span class="st">"units"</span>]</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="cf">except</span> <span class="pp">KeyError</span>:</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="ss">f"Precipitation variable in </span><span class="sc">{</span>inargs<span class="sc">.</span>pr_file<span class="sc">}</span><span class="ss"> does not have a units attribute"</span>)</span></code></pre>
</div>
</section><section><h2 class="section-heading" id="assertions">Assertions<a class="anchor" aria-label="anchor" href="#assertions"></a>
<a class="anchor" aria-label="anchor" href="#assertions"></a>
</h2>
<hr class="half-width">
<p>Unexpected behaviour in a program can sometimes propagate a long way
before triggering an exception or producing a perplexing result. For
instance, if a calculation produces a non-physical value for
precipitation (e.g. a negative value) that value could be used in
various downstream calculations of drought and fire risk (combined with
values for temperature, wind, humidity, etc). The final plot of the
forest fire danger index might look wrong (or not, which would be even
worse) to the scientist who wrote and executed the code, but it wouldn’t
be immediately obvious that the precipitation calculation was the source
of the problem.</p>
<p>In order to avoid propagation, it’s best to nip unexpected behaviour
in the bud right when it occurs. One way to do this is to add assertions
to your code. An assertion is simply a statement that something must be
true at a certain point in a program. When Python sees one, it evaluates
the assertion’s condition. If it’s true, Python does nothing, but if
it’s false, Python halts the program immediately and raises an
<code>AssertionError</code> with a custom error message.</p>
<p>To demonstrate an assertion in action, consider this piece of code
that halts if any precipitation data is negative:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>pr_data <span class="op">=</span> np.array([<span class="fl">1.5</span>, <span class="fl">2.3</span>, <span class="fl">0.7</span>, <span class="op">-</span><span class="fl">0.2</span>, <span class="fl">4.4</span>])</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="cf">assert</span> pr_data.<span class="bu">min</span>() <span class="op">&gt;=</span> <span class="fl">0.0</span>, <span class="st">"There is at least one negative precipitation value"</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
&lt;ipython-input-19-33d87ea29ae4&gt; in &lt;module&gt;()
----&gt; 1 assert pr_data.min() &gt;= 0.0, "There is at least one negative precipitation value"

AssertionError: There is at least one negative precipitation value</code></pre>
</div>
<p>With respect to our command line program, one thing to check would be
that the climatological precipitation values lie within a sensible range
after the unit conversion. The <a href="https://wmo.asu.edu/content/world-greatest-twenty-four-hour-1-day-rainfall" class="external-link">world
record highest daily rainfall total</a> is 1825mm (at Reunion Island in
1966), so climatological values across the globe should be more than 0
but less than 2000 mm/day. We could add the following assertions to our
<code>convert_pr_units</code> function to catch unexpected precipitation
values.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="cf">assert</span> darray.data.<span class="bu">min</span>() <span class="op">&gt;=</span> <span class="fl">0.0</span>, <span class="st">"There is at least one negative precipitation value"</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="cf">assert</span> darray.data.<span class="bu">max</span>() <span class="op">&lt;</span> <span class="dv">2000</span>, <span class="st">"There is a precipitation value/s &gt; 2000 mm/day"</span></span></code></pre>
</div>
<p>Assertions are also used in unit testing (each test culminates in an
assertion), but that topic is beyond the scope of this lesson.</p>
<div id="testing-and-continuous-integration" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="testing-and-continuous-integration" class="callout-inner">
<h3 class="callout-title">Testing and continuous integration<a class="anchor" aria-label="anchor" href="#testing-and-continuous-integration"></a>
</h3>
<div class="callout-content">
<p>An assertion checks that something is true at a particular point in
the program. For programs that are more complex (or research critical)
than <code>plot_precipitation_climatology.py</code>, it’s a good idea to
take the next step and check the overall behavior of entire pieces (or
units) of code. Related concepts like unit testing and continuous
integration are beyond the scope of this lesson, but <em>Research
Software Engineering With Python</em> has a <a href="https://merely-useful.github.io/py-rse/testing.html" class="external-link">chapter on
testing</a> that is well worth a read.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="logging">Logging<a class="anchor" aria-label="anchor" href="#logging"></a>
<a class="anchor" aria-label="anchor" href="#logging"></a>
</h2>
<hr class="half-width">
<p>So far we’ve considered how to make our programs halt or handle the
situation when things go wrong. Another option in our defensive
programming toolkit is to have our programs report their own
activity.</p>
<p>For example, let’s say we’re working with relative humidity data. We
wouldn’t typically expect to encounter any values over 100%, but it is
physically possible. Rather than halt the program if a value over 100%
occurs, we might therefore want our program to simply report the maximum
relative humidity. We can then decide whether to trust the output or not
(e.g. a value of 100.1% might be ok but not 150%).</p>
<p>To do this reporting, our first instinct might be to add a
<code>print</code> statement to the program.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>rh_data <span class="op">=</span> np.array([<span class="fl">1.5</span>, <span class="fl">20.4</span>, <span class="fl">100.1</span>, <span class="fl">76.3</span>, <span class="fl">54.4</span>])</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>rh_max <span class="op">=</span> rh_data.<span class="bu">max</span>()</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"The maximum relative humidity was </span><span class="sc">{</span>rh_max<span class="sc">}</span><span class="ss">%"</span>)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>The maximum relative humidity was 100.1%</code></pre>
</div>
<p>The problem with this approach is that information printed to the
screen is lost once we close our command line session. Constantly
adding, removing or commenting out <code>print</code> statements is also
tedious and error-prone.</p>
<p>A better approach is to use a logging framework, such as Python’s
<code>logging</code> library. This lets us leave debugging statements in
our code and turn them on or off at will. Let’s start by replacing our
<code>print</code> statement with a <code>logging</code> command.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>rh_data <span class="op">=</span> np.array([<span class="fl">1.5</span>, <span class="fl">20.4</span>, <span class="fl">100.1</span>, <span class="fl">76.3</span>, <span class="fl">54.4</span>])</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>rh_max <span class="op">=</span> rh_data.<span class="bu">max</span>()</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>logging.debug(<span class="ss">f"The maximum relative humidity was </span><span class="sc">{</span>rh_max<span class="sc">}</span><span class="ss">%"</span>)</span></code></pre>
</div>
<p>Whoops! There’s no output because by default the logging library only
reports information at the “warning” level and above. In order of
increasing severity, the available levels are:</p>
<ul>
<li>
<code>debug</code>: very detailed information used for localizing
errors.</li>
<li>
<code>info</code>: confirmation that things are working as
expected.</li>
<li>
<code>warning</code>: something unexpected happened, but the program
will keep going.</li>
<li>
<code>error</code>: something has gone badly wrong, but the program
hasn’t hurt anything.</li>
<li>
<code>critical</code>: potential loss of data, security breach,
etc.</li>
</ul>
<p>If we want to see the output from less severe levels (i.e. turn our
debugging statements on), we’d need to change the minimum level in the
logging configuration. We can also provide the name of a file to write
the logging information to, so that it isn’t lost when we finish our
command line session.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># for loop only required in notebooks</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="cf">for</span> handler <span class="kw">in</span> logging.root.handlers[:]:</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>    logging.root.removeHandler(handler)</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>    </span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>logging.basicConfig(level<span class="op">=</span>logging.DEBUG, filename<span class="op">=</span><span class="st">"log.txt"</span>)) </span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>rh_data <span class="op">=</span> np.array([<span class="fl">1.5</span>, <span class="fl">20.4</span>, <span class="fl">100.1</span>, <span class="fl">76.3</span>, <span class="fl">54.4</span>])</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>rh_max <span class="op">=</span> rh_data.<span class="bu">max</span>()</span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>logging.debug(<span class="ss">f"The maximum relative humidity was </span><span class="sc">{</span>rh_max<span class="sc">}</span><span class="ss">%"</span>)</span></code></pre>
</div>
<p>(The for loop is needed to turn off the background logging the
notebook does itself. It’s not needed in a Python script.)</p>
<p>Notice that we’ve used capital <code>logging.DEBUG</code> (which is
an integer value) to set the logging level, as opposed to the
<code>logging.debug</code> function that is used for logging a
message.</p>
<p>By setting the logging level to “DEBUG”, our output “log.txt” file
will now capture all logging information with a flag of ‘debug’ or
higher - that is, all logging outputs will be written to our log
file.</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="ex">$</span> cat log.txt</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>DEBUG:root:The maximum relative humidity was 100.1%</code></pre>
</div>
<p>In the context of the <code>plot_precipitation_climatology.py</code>
script, it would be nice to know whether or not unit conversion was
performed. To do this we just need a few small changes to the script. We
need to import the logging library at the top of the script,</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="im">import</span> logging</span></code></pre>
</div>
<p>and set the logging configuration and add a <code>logging.info</code>
command in the <code>main</code> function.</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>    </span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>    logging.basicConfig(level<span class="op">=</span>logging.DEBUG, filename<span class="op">=</span><span class="st">"log.txt"</span>) </span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>    </span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>    ...</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>    </span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>    <span class="cf">if</span> input_units <span class="op">==</span> <span class="st">'kg m-2 s-1'</span>:</span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>        clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>        logging.info(<span class="st">"Units converted from kg m-2 s-1 to mm/day"</span>)</span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>    <span class="cf">elif</span> input_units <span class="op">==</span> <span class="st">"mm/day"</span>:</span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"""Input units are not 'kg m-2 s-1' or 'mm/day'"""</span>)</span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>    </span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a>    ...</span></code></pre>
</div>
<div id="update-your-script" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="update-your-script" class="callout-inner">
<h3 class="callout-title">Update your script<a class="anchor" aria-label="anchor" href="#update-your-script"></a>
</h3>
<div class="callout-content">
<p>Update your working copy of
<code>plot_precipitation_climatology.py</code> with the changes from
this lesson.</p>
<p>This will mean your <code>main</code> function will now read as
follows,</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>    logging.basicConfig(level<span class="op">=</span>logging.DEBUG, filename<span class="op">=</span><span class="st">"log.txt"</span>) </span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(inargs.pr_file)</span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a>   </span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a>        input_units <span class="op">=</span> clim.attrs[<span class="st">"units"</span>]</span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyError</span>:</span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="ss">f"Precipitation variable in </span><span class="sc">{</span>inargs<span class="sc">.</span>pr_file<span class="sc">}</span><span class="ss"> must have a units attribute"</span>)</span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a>    <span class="cf">if</span> input_units <span class="op">==</span> <span class="st">"kg m-2 s-1"</span>:</span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a>        clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb31-17"><a href="#cb31-17" tabindex="-1"></a>        logging.info(<span class="st">"Units converted from kg m-2 s-1 to mm/day"</span>)</span>
<span id="cb31-18"><a href="#cb31-18" tabindex="-1"></a>    <span class="cf">elif</span> input_units <span class="op">==</span> <span class="st">"mm/day"</span>:</span>
<span id="cb31-19"><a href="#cb31-19" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb31-20"><a href="#cb31-20" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb31-21"><a href="#cb31-21" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"""Input units are not 'kg m-2 s-1' or 'mm/day'"""</span>)</span>
<span id="cb31-22"><a href="#cb31-22" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" tabindex="-1"></a>    <span class="cf">if</span> inargs.mask:</span>
<span id="cb31-24"><a href="#cb31-24" tabindex="-1"></a>        sftlf_file, realm <span class="op">=</span> inargs.mask</span>
<span id="cb31-25"><a href="#cb31-25" tabindex="-1"></a>        clim <span class="op">=</span> apply_mask(clim, sftlf_file, realm)</span>
<span id="cb31-26"><a href="#cb31-26" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" tabindex="-1"></a>    create_plot(</span>
<span id="cb31-28"><a href="#cb31-28" tabindex="-1"></a>        clim,</span>
<span id="cb31-29"><a href="#cb31-29" tabindex="-1"></a>        dset.attrs[<span class="st">"source_id"</span>],</span>
<span id="cb31-30"><a href="#cb31-30" tabindex="-1"></a>        inargs.season,</span>
<span id="cb31-31"><a href="#cb31-31" tabindex="-1"></a>        gridlines<span class="op">=</span>inargs.gridlines,</span>
<span id="cb31-32"><a href="#cb31-32" tabindex="-1"></a>        levels<span class="op">=</span>inargs.cbar_levels</span>
<span id="cb31-33"><a href="#cb31-33" tabindex="-1"></a>    )    </span>
<span id="cb31-34"><a href="#cb31-34" tabindex="-1"></a>    plt.savefig(</span>
<span id="cb31-35"><a href="#cb31-35" tabindex="-1"></a>        inargs.output_file,</span>
<span id="cb31-36"><a href="#cb31-36" tabindex="-1"></a>        dpi<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb31-37"><a href="#cb31-37" tabindex="-1"></a>        bbox_inches<span class="op">=</span><span class="st">"tight"</span>,</span>
<span id="cb31-38"><a href="#cb31-38" tabindex="-1"></a>        facecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb31-39"><a href="#cb31-39" tabindex="-1"></a>    )</span></code></pre>
</div>
<p>and your <code>convert_pr_units</code> as:</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="kw">def</span> convert_pr_units(da):</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>    <span class="co">"""Convert kg m-2 s-1 to mm day-1.</span></span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Precipitation data</span></span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a>    </span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a>    da.data <span class="op">=</span> da.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a>    da.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a>   </span>
<span id="cb32-12"><a href="#cb32-12" tabindex="-1"></a>    <span class="cf">assert</span> da.data.<span class="bu">min</span>() <span class="op">&gt;=</span> <span class="fl">0.0</span>, <span class="st">"There is at least one negative precipitation value"</span></span>
<span id="cb32-13"><a href="#cb32-13" tabindex="-1"></a>    <span class="cf">assert</span> da.data.<span class="bu">max</span>() <span class="op">&lt;</span> <span class="dv">2000</span>, <span class="st">"There is a precipitation value/s &gt; 2000 mm/day"</span></span>
<span id="cb32-14"><a href="#cb32-14" tabindex="-1"></a>    </span>
<span id="cb32-15"><a href="#cb32-15" tabindex="-1"></a>    <span class="cf">return</span> da</span></code></pre>
</div>
</div>
</div>
</div>
<div id="verbose-reporting" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="verbose-reporting" class="callout-inner">
<h3 class="callout-title">Verbose reporting<a class="anchor" aria-label="anchor" href="#verbose-reporting"></a>
</h3>
<div class="callout-content">
<p>Add two new command line options to
<code>plot_precipitation_climatology.py</code>.</p>
<p>The first should change the logging level so reporting from the
program is more verbose.</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>parser.add_argument(</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>    <span class="st">"-v"</span>,</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>    <span class="st">"--verbose"</span>,</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a>    action<span class="op">=</span><span class="st">"store_true"</span>,</span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a>    default<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a>    <span class="bu">help</span><span class="op">=</span><span class="st">"Change the minimum logging reporting level from WARNING (default) to INFO"</span>,</span>
<span id="cb33-7"><a href="#cb33-7" tabindex="-1"></a>)</span></code></pre>
</div>
<p>The second should allow the user to specify the name of the log file.
(If they don’t specify a name then the logging information is printed to
the screen.)</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>parser.add_argument(</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>    <span class="st">"--logfile"</span>,</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a>    <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a>    default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a>    <span class="bu">help</span><span class="op">=</span><span class="st">"Name of log file (by default logging information is printed to the screen)"</span>,</span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a>)</span></code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>The basic configuration command at the top of the <code>main</code>
function
(<code>logging.basicConfig(level=logging.DEBUG, filename="log.txt")</code>)
needs to be replaced with the following:</p>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>log_lev <span class="op">=</span> logging.INFO <span class="cf">if</span> inargs.verbose <span class="cf">else</span> logging.WARNING</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>logging.basicConfig(level<span class="op">=</span>log_lev, filename<span class="op">=</span>inargs.logfile) </span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="error-handling-for-landocean-masks" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="error-handling-for-landocean-masks" class="callout-inner">
<h3 class="callout-title">Error handling for land/ocean masks<a class="anchor" aria-label="anchor" href="#error-handling-for-landocean-masks"></a>
</h3>
<div class="callout-content">
<p>In the previous lesson we added an <code>apply_mask</code> function
to our script. Update the following if statement in that function so
that it raises a <code>ValueError</code> if the realm is not
<code>ocean</code> or <code>land</code>.</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="cf">if</span> realm <span class="op">==</span> <span class="st">"land"</span>:</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>    masked_da <span class="op">=</span> da.where(ds[<span class="st">"sftlf"</span>].data <span class="op">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a>    masked_da <span class="op">=</span> da.where(ds[<span class="st">"sftlf"</span>].data <span class="op">&gt;</span> <span class="dv">50</span>)</span></code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="cf">if</span> realm.lower() <span class="op">==</span> <span class="st">'land'</span>:</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>    masked_da <span class="op">=</span> da.where(ds[<span class="st">"sftlf"</span>].data <span class="op">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="cf">elif</span> realm.lower() <span class="op">==</span> <span class="st">'ocean'</span>:</span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a>    masked_da <span class="op">=</span> da.where(ds[<span class="st">"sftlf"</span>].data <span class="op">&gt;</span> <span class="dv">50</span>)</span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"""Mask realm is not 'ocean' or 'land'"""</span>)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="plot_precipitation_climatology.py" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="plot_precipitation_climatology.py" class="callout-inner">
<h3 class="callout-title">plot_precipitation_climatology.py<a class="anchor" aria-label="anchor" href="#plot_precipitation_climatology.py"></a>
</h3>
<div class="callout-content">
<p>At the conclusion of this lesson your
<code>plot_precipitation_climatology.py</code> script should look
something like the following:</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb38-8"><a href="#cb38-8" tabindex="-1"></a><span class="im">import</span> cmocean</span>
<span id="cb38-9"><a href="#cb38-9" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" tabindex="-1"></a><span class="kw">def</span> convert_pr_units(da):</span>
<span id="cb38-12"><a href="#cb38-12" tabindex="-1"></a>    <span class="co">"""Convert kg m-2 s-1 to mm day-1.</span></span>
<span id="cb38-13"><a href="#cb38-13" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb38-14"><a href="#cb38-14" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb38-15"><a href="#cb38-15" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Precipitation data</span></span>
<span id="cb38-16"><a href="#cb38-16" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb38-17"><a href="#cb38-17" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-18"><a href="#cb38-18" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" tabindex="-1"></a>    da.data <span class="op">=</span> da.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb38-20"><a href="#cb38-20" tabindex="-1"></a>    da.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb38-21"><a href="#cb38-21" tabindex="-1"></a>   </span>
<span id="cb38-22"><a href="#cb38-22" tabindex="-1"></a>    <span class="cf">assert</span> da.data.<span class="bu">min</span>() <span class="op">&gt;=</span> <span class="fl">0.0</span>, <span class="st">"There is at least one negative precipitation value"</span></span>
<span id="cb38-23"><a href="#cb38-23" tabindex="-1"></a>    <span class="cf">assert</span> da.data.<span class="bu">max</span>() <span class="op">&lt;</span> <span class="dv">2000</span>, <span class="st">"There is a precipitation value/s &gt; 2000 mm/day"</span></span>
<span id="cb38-24"><a href="#cb38-24" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" tabindex="-1"></a>    <span class="cf">return</span> da</span>
<span id="cb38-26"><a href="#cb38-26" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" tabindex="-1"></a></span>
<span id="cb38-28"><a href="#cb38-28" tabindex="-1"></a><span class="kw">def</span> apply_mask(da, sftlf_file, realm):</span>
<span id="cb38-29"><a href="#cb38-29" tabindex="-1"></a>    <span class="co">"""Mask ocean or land using a sftlf (land surface fraction) file.</span></span>
<span id="cb38-30"><a href="#cb38-30" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb38-31"><a href="#cb38-31" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb38-32"><a href="#cb38-32" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Data to mask</span></span>
<span id="cb38-33"><a href="#cb38-33" tabindex="-1"></a><span class="co">      sftlf_file (str): Land surface fraction file</span></span>
<span id="cb38-34"><a href="#cb38-34" tabindex="-1"></a><span class="co">      realm (str): Realm to mask</span></span>
<span id="cb38-35"><a href="#cb38-35" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb38-36"><a href="#cb38-36" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-37"><a href="#cb38-37" tabindex="-1"></a>  </span>
<span id="cb38-38"><a href="#cb38-38" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(sftlf_file)</span>
<span id="cb38-39"><a href="#cb38-39" tabindex="-1"></a>    <span class="cf">if</span> realm.lower() <span class="op">==</span> <span class="st">"land"</span>:</span>
<span id="cb38-40"><a href="#cb38-40" tabindex="-1"></a>        masked_da <span class="op">=</span> da.where(ds[<span class="st">"sftlf"</span>].data <span class="op">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb38-41"><a href="#cb38-41" tabindex="-1"></a>    <span class="cf">elif</span> realm.lower() <span class="op">==</span> <span class="st">'ocean'</span>:</span>
<span id="cb38-42"><a href="#cb38-42" tabindex="-1"></a>        masked_da <span class="op">=</span> da.where(ds[<span class="st">"sftlf"</span>].data <span class="op">&gt;</span> <span class="dv">50</span>)   </span>
<span id="cb38-43"><a href="#cb38-43" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb38-44"><a href="#cb38-44" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"""Mask realm is not 'ocean' or 'land'"""</span>)    </span>
<span id="cb38-45"><a href="#cb38-45" tabindex="-1"></a></span>
<span id="cb38-46"><a href="#cb38-46" tabindex="-1"></a>    <span class="cf">return</span> masked_da</span>
<span id="cb38-47"><a href="#cb38-47" tabindex="-1"></a></span>
<span id="cb38-48"><a href="#cb38-48" tabindex="-1"></a></span>
<span id="cb38-49"><a href="#cb38-49" tabindex="-1"></a><span class="kw">def</span> create_plot(clim, model, season, gridlines<span class="op">=</span><span class="va">False</span>, levels<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb38-50"><a href="#cb38-50" tabindex="-1"></a>    <span class="co">"""Plot the precipitation climatology.</span></span>
<span id="cb38-51"><a href="#cb38-51" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb38-52"><a href="#cb38-52" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb38-53"><a href="#cb38-53" tabindex="-1"></a><span class="co">      clim (xarray.DataArray): Precipitation climatology data</span></span>
<span id="cb38-54"><a href="#cb38-54" tabindex="-1"></a><span class="co">      model (str): Name of the climate model</span></span>
<span id="cb38-55"><a href="#cb38-55" tabindex="-1"></a><span class="co">      season (str): Season</span></span>
<span id="cb38-56"><a href="#cb38-56" tabindex="-1"></a><span class="co">     </span></span>
<span id="cb38-57"><a href="#cb38-57" tabindex="-1"></a><span class="co">    Kwargs:</span></span>
<span id="cb38-58"><a href="#cb38-58" tabindex="-1"></a><span class="co">      gridlines (bool): Select whether to plot gridlines</span></span>
<span id="cb38-59"><a href="#cb38-59" tabindex="-1"></a><span class="co">      levels (list): Tick marks on the colorbar    </span></span>
<span id="cb38-60"><a href="#cb38-60" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb38-61"><a href="#cb38-61" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-62"><a href="#cb38-62" tabindex="-1"></a></span>
<span id="cb38-63"><a href="#cb38-63" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> levels:</span>
<span id="cb38-64"><a href="#cb38-64" tabindex="-1"></a>        levels <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb38-65"><a href="#cb38-65" tabindex="-1"></a>       </span>
<span id="cb38-66"><a href="#cb38-66" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb38-67"><a href="#cb38-67" tabindex="-1"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb38-68"><a href="#cb38-68" tabindex="-1"></a>    clim.sel(season<span class="op">=</span>season).plot.contourf(</span>
<span id="cb38-69"><a href="#cb38-69" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb38-70"><a href="#cb38-70" tabindex="-1"></a>        levels<span class="op">=</span>levels,</span>
<span id="cb38-71"><a href="#cb38-71" tabindex="-1"></a>        extend<span class="op">=</span><span class="st">'max'</span>,</span>
<span id="cb38-72"><a href="#cb38-72" tabindex="-1"></a>        transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb38-73"><a href="#cb38-73" tabindex="-1"></a>        cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: clim.units},</span>
<span id="cb38-74"><a href="#cb38-74" tabindex="-1"></a>        cmap<span class="op">=</span>cmocean.cm.haline_r,</span>
<span id="cb38-75"><a href="#cb38-75" tabindex="-1"></a>    )</span>
<span id="cb38-76"><a href="#cb38-76" tabindex="-1"></a>    ax.coastlines()</span>
<span id="cb38-77"><a href="#cb38-77" tabindex="-1"></a>    <span class="cf">if</span> gridlines:</span>
<span id="cb38-78"><a href="#cb38-78" tabindex="-1"></a>        plt.gca().gridlines()</span>
<span id="cb38-79"><a href="#cb38-79" tabindex="-1"></a>    </span>
<span id="cb38-80"><a href="#cb38-80" tabindex="-1"></a>    title <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss"> precipitation climatology (</span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb38-81"><a href="#cb38-81" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb38-82"><a href="#cb38-82" tabindex="-1"></a></span>
<span id="cb38-83"><a href="#cb38-83" tabindex="-1"></a></span>
<span id="cb38-84"><a href="#cb38-84" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb38-85"><a href="#cb38-85" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb38-86"><a href="#cb38-86" tabindex="-1"></a></span>
<span id="cb38-87"><a href="#cb38-87" tabindex="-1"></a>    log_lev <span class="op">=</span> logging.DEBUG <span class="cf">if</span> inargs.verbose <span class="cf">else</span> logging.WARNING</span>
<span id="cb38-88"><a href="#cb38-88" tabindex="-1"></a>    logging.basicConfig(level<span class="op">=</span>log_lev, filename<span class="op">=</span>inargs.logfile) </span>
<span id="cb38-89"><a href="#cb38-89" tabindex="-1"></a></span>
<span id="cb38-90"><a href="#cb38-90" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(inargs.pr_file)</span>
<span id="cb38-91"><a href="#cb38-91" tabindex="-1"></a>    </span>
<span id="cb38-92"><a href="#cb38-92" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">'pr'</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-93"><a href="#cb38-93" tabindex="-1"></a></span>
<span id="cb38-94"><a href="#cb38-94" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb38-95"><a href="#cb38-95" tabindex="-1"></a>        input_units <span class="op">=</span> clim.attrs[<span class="st">"units"</span>]</span>
<span id="cb38-96"><a href="#cb38-96" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyError</span>:</span>
<span id="cb38-97"><a href="#cb38-97" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="ss">f"Precipitation variable in </span><span class="sc">{</span>inargs<span class="sc">.</span>pr_file<span class="sc">}</span><span class="ss"> does not have a units attribute"</span>)</span>
<span id="cb38-98"><a href="#cb38-98" tabindex="-1"></a></span>
<span id="cb38-99"><a href="#cb38-99" tabindex="-1"></a>    <span class="cf">if</span> input_units <span class="op">==</span> <span class="st">"kg m-2 s-1"</span>:</span>
<span id="cb38-100"><a href="#cb38-100" tabindex="-1"></a>        clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb38-101"><a href="#cb38-101" tabindex="-1"></a>        logging.info(<span class="st">"Units converted from kg m-2 s-1 to mm/day"</span>)</span>
<span id="cb38-102"><a href="#cb38-102" tabindex="-1"></a>    <span class="cf">elif</span> input_units <span class="op">==</span> <span class="st">"mm/day"</span>:</span>
<span id="cb38-103"><a href="#cb38-103" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb38-104"><a href="#cb38-104" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb38-105"><a href="#cb38-105" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"""Input units are not 'kg m-2 s-1' or 'mm/day'"""</span>)</span>
<span id="cb38-106"><a href="#cb38-106" tabindex="-1"></a></span>
<span id="cb38-107"><a href="#cb38-107" tabindex="-1"></a>    <span class="cf">if</span> inargs.mask:</span>
<span id="cb38-108"><a href="#cb38-108" tabindex="-1"></a>        sftlf_file, realm <span class="op">=</span> inargs.mask</span>
<span id="cb38-109"><a href="#cb38-109" tabindex="-1"></a>        clim <span class="op">=</span> apply_mask(clim, sftlf_file, realm)</span>
<span id="cb38-110"><a href="#cb38-110" tabindex="-1"></a></span>
<span id="cb38-111"><a href="#cb38-111" tabindex="-1"></a>    create_plot(</span>
<span id="cb38-112"><a href="#cb38-112" tabindex="-1"></a>        clim,</span>
<span id="cb38-113"><a href="#cb38-113" tabindex="-1"></a>        ds.attrs[<span class="st">"source_id"</span>],</span>
<span id="cb38-114"><a href="#cb38-114" tabindex="-1"></a>        inargs.season,</span>
<span id="cb38-115"><a href="#cb38-115" tabindex="-1"></a>        gridlines<span class="op">=</span>inargs.gridlines,</span>
<span id="cb38-116"><a href="#cb38-116" tabindex="-1"></a>        levels<span class="op">=</span>inargs.cbar_levels</span>
<span id="cb38-117"><a href="#cb38-117" tabindex="-1"></a>    )</span>
<span id="cb38-118"><a href="#cb38-118" tabindex="-1"></a>    plt.savefig(</span>
<span id="cb38-119"><a href="#cb38-119" tabindex="-1"></a>        inargs.output_file,</span>
<span id="cb38-120"><a href="#cb38-120" tabindex="-1"></a>        dpi<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb38-121"><a href="#cb38-121" tabindex="-1"></a>        bbox_inches<span class="op">=</span><span class="st">"tight"</span>,</span>
<span id="cb38-122"><a href="#cb38-122" tabindex="-1"></a>        facecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb38-123"><a href="#cb38-123" tabindex="-1"></a>    )</span>
<span id="cb38-124"><a href="#cb38-124" tabindex="-1"></a></span>
<span id="cb38-125"><a href="#cb38-125" tabindex="-1"></a></span>
<span id="cb38-126"><a href="#cb38-126" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb38-127"><a href="#cb38-127" tabindex="-1"></a>    description<span class="op">=</span><span class="st">'Plot the precipitation climatology for a given season.'</span></span>
<span id="cb38-128"><a href="#cb38-128" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span>description)</span>
<span id="cb38-129"><a href="#cb38-129" tabindex="-1"></a>   </span>
<span id="cb38-130"><a href="#cb38-130" tabindex="-1"></a>    parser.add_argument(<span class="st">"pr_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Precipitation data file"</span>)</span>
<span id="cb38-131"><a href="#cb38-131" tabindex="-1"></a>    parser.add_argument(<span class="st">"season"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Season to plot"</span>)</span>
<span id="cb38-132"><a href="#cb38-132" tabindex="-1"></a>    parser.add_argument(<span class="st">"output_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Output file name"</span>)</span>
<span id="cb38-133"><a href="#cb38-133" tabindex="-1"></a></span>
<span id="cb38-134"><a href="#cb38-134" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb38-135"><a href="#cb38-135" tabindex="-1"></a>        <span class="st">"--gridlines"</span>,</span>
<span id="cb38-136"><a href="#cb38-136" tabindex="-1"></a>        action<span class="op">=</span><span class="st">"store_true"</span>,</span>
<span id="cb38-137"><a href="#cb38-137" tabindex="-1"></a>        default<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb38-138"><a href="#cb38-138" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Include gridlines on the plot"</span>,</span>
<span id="cb38-139"><a href="#cb38-139" tabindex="-1"></a>    )</span>
<span id="cb38-140"><a href="#cb38-140" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb38-141"><a href="#cb38-141" tabindex="-1"></a>        <span class="st">"--cbar_levels"</span>,</span>
<span id="cb38-142"><a href="#cb38-142" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>,</span>
<span id="cb38-143"><a href="#cb38-143" tabindex="-1"></a>        nargs<span class="op">=</span><span class="st">"*"</span>,</span>
<span id="cb38-144"><a href="#cb38-144" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb38-145"><a href="#cb38-145" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"list of levels / tick marks to appear on the colorbar"</span>,</span>
<span id="cb38-146"><a href="#cb38-146" tabindex="-1"></a>    )</span>
<span id="cb38-147"><a href="#cb38-147" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb38-148"><a href="#cb38-148" tabindex="-1"></a>        <span class="st">"--mask"</span>,</span>
<span id="cb38-149"><a href="#cb38-149" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb38-150"><a href="#cb38-150" tabindex="-1"></a>        nargs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb38-151"><a href="#cb38-151" tabindex="-1"></a>        metavar<span class="op">=</span>(<span class="st">"SFTLF_FILE"</span>, <span class="st">"REALM"</span>),</span>
<span id="cb38-152"><a href="#cb38-152" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb38-153"><a href="#cb38-153" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"""Provide sftlf file and realm to mask ('land' or 'ocean')"""</span>,</span>
<span id="cb38-154"><a href="#cb38-154" tabindex="-1"></a>    )</span>
<span id="cb38-155"><a href="#cb38-155" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb38-156"><a href="#cb38-156" tabindex="-1"></a>        <span class="st">"-v"</span>,</span>
<span id="cb38-157"><a href="#cb38-157" tabindex="-1"></a>        <span class="st">"--verbose"</span>,</span>
<span id="cb38-158"><a href="#cb38-158" tabindex="-1"></a>        action<span class="op">=</span><span class="st">"store_true"</span>,</span>
<span id="cb38-159"><a href="#cb38-159" tabindex="-1"></a>        default<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb38-160"><a href="#cb38-160" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Change the minimum logging reporting level from WARNING (default) to DEBUG"</span>,</span>
<span id="cb38-161"><a href="#cb38-161" tabindex="-1"></a>    )</span>
<span id="cb38-162"><a href="#cb38-162" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb38-163"><a href="#cb38-163" tabindex="-1"></a>        <span class="st">"--logfile"</span>,</span>
<span id="cb38-164"><a href="#cb38-164" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb38-165"><a href="#cb38-165" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb38-166"><a href="#cb38-166" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Name of log file (by default logging information is printed to the screen)"</span>,</span>
<span id="cb38-167"><a href="#cb38-167" tabindex="-1"></a>    )</span>
<span id="cb38-168"><a href="#cb38-168" tabindex="-1"></a></span>
<span id="cb38-169"><a href="#cb38-169" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb38-170"><a href="#cb38-170" tabindex="-1"></a>    main(args)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Program defensively, i.e., assume that errors are going to arise,
and write code to detect them when they do.</li>
<li>You can raise exceptions in your own code.</li>
<li>Put try-except blocks in programs to catch and handle
exceptions.</li>
<li>Put assertions in programs to check their state as they run.</li>
<li>Use a logging framework instead of <code>print</code> statements to
report program activity.</li>
<li>The are more advanced lessons you can read to learn about code
testing.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-09-provenance"><p>Content from <a href="09-provenance.html">Data provenance</a></p>
<hr>
<p>Last updated on 2024-07-25 |

        <a href="https://github.com/fishtree-attempt/python-aos-lesson/edit/main/episodes/09-provenance.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can keep track of my data processing steps?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Automate the process of recording the history of what was entered at
the command line to produce a given data file or image.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>We’ve now successfully created a command line program -
<code>plot_precipitation_climatology.py</code> - that calculates and
plots the precipitation climatology for a given season. The last step is
to capture the provenance of that plot. In other words, we need a log of
all the data processing steps that were taken from the intial download
of the data file to the end result (i.e. the PNG image).</p>
<p>The simplest way to do this is to follow the lead of the <a href="https://nco.sourceforge.net/" class="external-link">NCO</a> and <a href="https://code.mpimet.mpg.de/projects/cdo" class="external-link">CDO</a> command line
tools, which insert a record of what was executed at the command line
into the history attribute of the output netCDF file. If fact, they were
both used in the pre-processing of the data files used in these
lessons:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>accessesm15_pr_file <span class="op">=</span> <span class="st">"data/pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412.nc"</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>ds <span class="op">=</span> xr.open_dataset(accessesm15_pr_file)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="bu">print</span>(ds.attrs[<span class="st">'history'</span>])</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Tue Jan 12 14:50:35 2021: ncatted -O -a history,pr,d,, pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412.nc
Tue Jan 12 14:48:10 2021: cdo seldate,2010-01-01,2014-12-31 /g/data/fs38/publications/CMIP6/CMIP/CSIRO/ACCESS-ESM1-5/historical/r1i1p1f1/Amon/pr/gn/latest/pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_185001-201412.nc pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412.nc
2019-11-15T04:32:57Z ; CMOR rewrote data to be consistent with CMIP6, CF-1.7 CMIP-6.2 and CF standards.</code></pre>
</div>
<p>Fortunately, there is a Python package called <a href="https://cmdline-provenance.readthedocs.io/en/latest/" class="external-link">cmdline-provenance</a>
that creates NCO/CDO-style records of what was executed at the command
line. We can use it to add to the command log, before inserting the
updated log into the metadata associated with our output image file.</p>
<p>To start, let’s import the <code>cmdline_provenance</code> library
with the other imports at the top of our
<code>plot_precipitation_climatology.py</code> script,</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">import</span> cmdline_provenance <span class="im">as</span> cmdprov</span></code></pre>
</div>
<p>and then make the following updates to the original line of code
responsible for saving the image to file:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>new_log <span class="op">=</span> cmdprov.new_log(infile_logs<span class="op">=</span>{inargs.pr_file: dset.attrs[<span class="st">"history"</span>]})</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>plt.savefig(</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    inargs.output_file,</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    metadata<span class="op">=</span>{<span class="st">"History"</span>: new_log},</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    dpi<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    bbox_inches<span class="op">=</span><span class="st">"tight"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>)</span></code></pre>
</div>
<p>When we execute <code>plot_precipitation_climatology.py</code>,
<code>cmdprov.new_log</code> will create a record of what was entered at
the command line. The name of the input precipitation file and its
history attribute have been provided using the <code>infile_logs</code>
argument, so that <code>cmdprov.new_log</code> can append the history of
that file to the new command log. The <code>metadata</code> argument for
<code>plt.savefig</code> has then been used to save the new command log
to the image metadata.</p>
<p>To see this in action, we can run the program,</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">$</span> python plot_precipitation_climatology.py data/pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412.nc SON pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412-SON-clim.png</span></code></pre>
</div>
<p>and then view the metadata of the new PNG image file. There are a
number of different programs available to do this, but they can often be
tricky to install. Fortunately, <code>conda</code> is used to install
programs written in many different languages, not just Python. There are
<a href="https://anaconda.org/conda-forge/exiftool" class="external-link">installation
recipes</a> for a command line program called <a href="https://exiftool.org/" class="external-link"><code>exiftool</code></a> on anaconda.org,
so let’s go ahead and install that:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">$</span> conda install exiftool</span></code></pre>
</div>
<p>Once installed, we can use it to view the metadata associated with
our image file:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">$</span> exiftool pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412-SON-clim.png</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>ExifTool Version Number         : 12.17
File Name                       : pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412-SON-clim.png
Directory                       : .
File Size                       : 315 KiB
File Modification Date/Time     : 2021:02:08 10:16:56+11:00
File Access Date/Time           : 2021:02:08 10:16:58+11:00
File Inode Change Date/Time     : 2021:02:08 10:16:56+11:00
File Permissions                : rw-r--r--
File Type                       : PNG
File Type Extension             : png
MIME Type                       : image/png
Image Width                     : 2400
Image Height                    : 1000
Bit Depth                       : 8
Color Type                      : RGB with Alpha
Compression                     : Deflate/Inflate
Filter                          : Adaptive
Interlace                       : Noninterlaced
Software                        : Matplotlib version3.3.3, https://matplotlib.org/
History                         : Mon Feb 08 09:45:17 2021: /Users/damien/opt/anaconda3/envs/pyaos-lesson/bin/python code/plot_precipitation_climatology.py data/pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412.nc SON pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412-SON-clim.png.Tue Jan 12 14:50:35 2021: ncatted -O -a history,pr,d,, pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412.nc.Tue Jan 12 14:48:10 2021: cdo seldate,2010-01-01,2014-12-31 /g/data/fs38/publications/CMIP6/CMIP/CSIRO/ACCESS-ESM1-5/historical/r1i1p1f1/Amon/pr/gn/latest/pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_185001-201412.nc pr_Amon_ACCESS-ESM1-5_historical_r1i1p1f1_gn_201001-201412.nc.2019-11-15T04:32:57Z ; CMOR rewrote data to be consistent with CMIP6, CF-1.7 CMIP-6.2 and CF standards. .
Pixels Per Unit X               : 7874
Pixels Per Unit Y               : 7874
Pixel Units                     : meters
Image Size                      : 2400x1000
Megapixels                      : 2.4</code></pre>
</div>
<p>Now that we’ve successfully added a command log to our PNG image, we
might want to think about how our script should handle other image
formats (e.g. PDF, EPS)? For PNG files you can pick whatever metadata
keys you like (hence we picked “History”), but other formats only allow
specific keys. For now we can add raise an error so that the program
halts if someone tries to generate a format that isn’t PNG, and in the
exercises we’ll add more valid formats to the script.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>image_format <span class="op">=</span> inargs.output_file.split(<span class="st">"."</span>)[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="cf">if</span> image_format <span class="op">!=</span> <span class="st">"png"</span>:</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Output file must have the PNG image file extension .png"</span>)</span></code></pre>
</div>
<p>Putting this altogether, here’s what the <code>main</code> function
in <code>plot_precipitation_climatology.py</code> looks like:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    log_lev <span class="op">=</span> logging.DEBUG <span class="cf">if</span> inargs.verbose <span class="cf">else</span> logging.WARNING</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>    logging.basicConfig(level<span class="op">=</span>log_lev, filename<span class="op">=</span>inargs.logfile) </span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(inargs.pr_file)</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>    </span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>        input_units <span class="op">=</span> clim.attrs[<span class="st">"units"</span>]</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyError</span>:</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="ss">f"Precipitation variable in </span><span class="sc">{</span>inargs<span class="sc">.</span>pr_file<span class="sc">}</span><span class="ss"> does not have a units attribute"</span>)</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    <span class="cf">if</span> input_units <span class="op">==</span> <span class="st">"kg m-2 s-1"</span>:</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>        clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>        logging.info(<span class="st">"Units converted from kg m-2 s-1 to mm/day"</span>)</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>    <span class="cf">elif</span> input_units <span class="op">==</span> <span class="st">"mm/day"</span>:</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"""Input units are not 'kg m-2 s-1' or 'mm/day'"""</span>)</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>    <span class="cf">if</span> inargs.mask:</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>        sftlf_file, realm <span class="op">=</span> inargs.mask</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>        clim <span class="op">=</span> apply_mask(clim, sftlf_file, realm)</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>    create_plot(</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>        clim,</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>        ds.attrs[<span class="st">"source_id"</span>],</span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>        inargs.season,</span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>        gridlines<span class="op">=</span>inargs.gridlines,</span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a>        levels<span class="op">=</span>inargs.cbar_levels,</span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>    )</span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>    </span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a>    image_format <span class="op">=</span> inargs.output_file.split(<span class="st">"."</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a>    <span class="cf">if</span> image_format <span class="op">!=</span> <span class="st">"png"</span>:</span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Output file must have the PNG image file extension .png"</span>)</span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a>    new_log <span class="op">=</span> cmdprov.new_log(infile_logs<span class="op">=</span>{inargs.pr_file: ds.attrs[<span class="st">"history"</span>]})</span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a>    plt.savefig(</span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a>        inargs.output_file,</span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a>        metadata<span class="op">=</span>{<span class="st">"History"</span>: new_log},</span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a>        dpi<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a>        bbox_inches<span class="op">=</span><span class="st">"tight"</span>,</span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a>        facecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a>    )</span></code></pre>
</div>
<div id="handling-different-image-formats" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="handling-different-image-formats" class="callout-inner">
<h3 class="callout-title">Handling different image formats<a class="anchor" aria-label="anchor" href="#handling-different-image-formats"></a>
</h3>
<div class="callout-content">
<p>The <a href="https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.pyplot.savefig.html" class="external-link"><code>plt.savefig</code>
documentation</a> provides information on the metadata keys accepted by
PNG, PDF, EPS and PS image formats.</p>
<p>Using that information as a guide, add a new function called
<code>get_log_and_key</code> to the
<code>plot_precipitation_climatology.py</code> script. It should take
the precipitation file name, history attribute, and plot type as
arguments and return the updated command log and the appropriate
metadata key for PNG, PDF, EPS or PS image formats.</p>
<p>When you’re done, the final lines of the <code>main</code> function
should read as follows:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>log_key, new_log <span class="op">=</span> get_log_and_key(</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>    inargs.pr_file,</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    ds.attrs[<span class="st">"history"</span>],</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    inargs.output_file.split(<span class="st">"."</span>)[<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>)</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>plt.savefig(</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>    inargs.output_file,</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    metadata<span class="op">=</span>{log_key: new_log},</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>    dpi<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>    bbox_inches<span class="op">=</span><span class="st">"tight"</span>,</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>)</span></code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>The new function could read as follows:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="kw">def</span> get_log_and_key(pr_file, history_attr, plot_type):</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>    <span class="co">"""Get key and command line log for image metadata.</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co">    Different image formats allow different metadata keys.</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="co">      pr_file (str): Input precipitation file</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="co">      history_attr (str): History attribute from pr_file</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="co">      plot_type (str): File format for output image</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>    </span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>    valid_keys <span class="op">=</span> {<span class="st">"png"</span>: <span class="st">"History"</span>,</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>                  <span class="st">"pdf"</span>: <span class="st">"Title"</span>,</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>                  <span class="st">"eps"</span>: <span class="st">"Creator"</span>,</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>                  <span class="st">"ps"</span> : <span class="st">"Creator"</span>,</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>    }</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>    <span class="cf">if</span> plot_type <span class="kw">in</span> valid_keys.keys():</span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>        log_key <span class="op">=</span> valid_keys[plot_type]</span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Image format not one of: </span><span class="sc">{</span><span class="op">*</span>[<span class="op">*</span>valid_keys]<span class="sc">,}</span><span class="ss">"</span>)</span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>    new_log <span class="op">=</span> cmdprov.new_log(infile_logs<span class="op">=</span>{pr_file: history_attr})</span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>   </span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>    <span class="cf">return</span> log_key, new_log</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="writing-the-command-log-to-netcdf-files" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="writing-the-command-log-to-netcdf-files" class="callout-inner">
<h3 class="callout-title">Writing the command log to netCDF files<a class="anchor" aria-label="anchor" href="#writing-the-command-log-to-netcdf-files"></a>
</h3>
<div class="callout-content">
<p>Instead of calculating the seasonal climatology and creating a plot
all in the one script, we could have decided to make it a two step
process. The first script in the process could take the original
precipitation data file and output a new netCDF file containing the
seasonal climatology, and the second script could take the seasonal
climatology file and create a plot from that.</p>
<p>If the first script reads as follows, how would you edit it so that
an updated command log is included in the history attribute of the
output netCDF file?</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="kw">def</span> convert_pr_units(darray):</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="co">"""Convert kg m-2 s-1 to mm day-1.</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Precipitation data</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>    da.data <span class="op">=</span> da.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>    da.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>    <span class="cf">assert</span> da.data.<span class="bu">min</span>() <span class="op">&gt;=</span> <span class="fl">0.0</span>, <span class="st">"There is at least one negative precipitation value"</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>    <span class="cf">assert</span> da.data.<span class="bu">max</span>() <span class="op">&lt;</span> <span class="dv">2000</span>, <span class="st">"There is a precipitation value/s &gt; 2000 mm/day"</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>    <span class="cf">return</span> da</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>    log_lev <span class="op">=</span> logging.DEBUG <span class="cf">if</span> inargs.verbose <span class="cf">else</span> logging.WARNING</span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a>    logging.basicConfig(level<span class="op">=</span>log_lev, filename<span class="op">=</span>inargs.logfile)</span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a>    in_dset <span class="op">=</span> xr.open_dataset(inargs.pr_file)</span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a>    clim <span class="op">=</span> in_ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a>        input_units <span class="op">=</span> clim.attrs[<span class="st">"units"</span>]</span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyError</span>:</span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="ss">f"Precipitation variable in </span><span class="sc">{</span>inargs<span class="sc">.</span>pr_file<span class="sc">}</span><span class="ss"> does not have a units attribute"</span>)</span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" tabindex="-1"></a>    <span class="cf">if</span> input_units <span class="op">==</span> <span class="st">"kg m-2 s-1"</span>:</span>
<span id="cb13-38"><a href="#cb13-38" tabindex="-1"></a>        clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb13-39"><a href="#cb13-39" tabindex="-1"></a>        logging.info(<span class="st">"Units converted from kg m-2 s-1 to mm/day"</span>)</span>
<span id="cb13-40"><a href="#cb13-40" tabindex="-1"></a>    <span class="cf">elif</span> input_units <span class="op">==</span> <span class="st">"mm/day"</span>:</span>
<span id="cb13-41"><a href="#cb13-41" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb13-42"><a href="#cb13-42" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-43"><a href="#cb13-43" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"""Input units are not 'kg m-2 s-1' or 'mm/day'"""</span>)</span>
<span id="cb13-44"><a href="#cb13-44" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" tabindex="-1"></a>    out_ds <span class="op">=</span> clim.to_dataset()</span>
<span id="cb13-46"><a href="#cb13-46" tabindex="-1"></a>    out_ds.attrs <span class="op">=</span> in_ds.attrs</span>
<span id="cb13-47"><a href="#cb13-47" tabindex="-1"></a>    out_ds.to_netcdf(inargs.output_file)</span>
<span id="cb13-48"><a href="#cb13-48" tabindex="-1"></a>   </span>
<span id="cb13-49"><a href="#cb13-49" tabindex="-1"></a></span>
<span id="cb13-50"><a href="#cb13-50" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb13-51"><a href="#cb13-51" tabindex="-1"></a>    description <span class="op">=</span> <span class="st">"Calculate the seasonal precipitation climatology."</span></span>
<span id="cb13-52"><a href="#cb13-52" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span>description)</span>
<span id="cb13-53"><a href="#cb13-53" tabindex="-1"></a>    parser.add_argument(<span class="st">"pr_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Precipitation data file"</span>)</span>
<span id="cb13-54"><a href="#cb13-54" tabindex="-1"></a>    parser.add_argument(<span class="st">"output_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Output file name"</span>)</span>
<span id="cb13-55"><a href="#cb13-55" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb13-56"><a href="#cb13-56" tabindex="-1"></a>        <span class="st">"-v"</span>,</span>
<span id="cb13-57"><a href="#cb13-57" tabindex="-1"></a>        <span class="st">"--verbose"</span>,</span>
<span id="cb13-58"><a href="#cb13-58" tabindex="-1"></a>        action<span class="op">=</span><span class="st">"store_true"</span>,</span>
<span id="cb13-59"><a href="#cb13-59" tabindex="-1"></a>        default<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb13-60"><a href="#cb13-60" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Change the minimum logging reporting level from WARNING (default) to DEBUG"</span>,</span>
<span id="cb13-61"><a href="#cb13-61" tabindex="-1"></a>    )</span>
<span id="cb13-62"><a href="#cb13-62" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb13-63"><a href="#cb13-63" tabindex="-1"></a>        <span class="st">"--logfile"</span>,</span>
<span id="cb13-64"><a href="#cb13-64" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb13-65"><a href="#cb13-65" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb13-66"><a href="#cb13-66" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Name of log file (by default logging information is printed to the screen)"</span>,</span>
<span id="cb13-67"><a href="#cb13-67" tabindex="-1"></a>    )</span>
<span id="cb13-68"><a href="#cb13-68" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()  </span>
<span id="cb13-69"><a href="#cb13-69" tabindex="-1"></a>    main(args)</span></code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>The beginning of the script would need to be updated to import the
<code>cmdline_provenance</code> library:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="im">import</span> cmdline_provenance <span class="im">as</span> cmdprov</span></code></pre>
</div>
<p>The body of the <code>main</code> function would then need to be
updated to write the new command log to the history attribute of the
output dataset:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>out_ds.attrs <span class="op">=</span> in_ds.attrs</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>new_log <span class="op">=</span> cmdprov.new_log(infile_logs<span class="op">=</span>{inargs.pr_file: in_ds.attrs[<span class="st">"history"</span>]})</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>out_ds.attrs[<span class="st">"history"</span>] <span class="op">=</span> new_log</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>out_ds.to_netcdf(inargs.output_file)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="plot_precipitation_climatology.py" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="plot_precipitation_climatology.py" class="callout-inner">
<h3 class="callout-title">plot_precipitation_climatology.py<a class="anchor" aria-label="anchor" href="#plot_precipitation_climatology.py"></a>
</h3>
<div class="callout-content">
<p>At the conclusion of this lesson your
<code>plot_precipitation_climatology.py</code> script should look
something like the following:</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="im">import</span> cmocean</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="im">import</span> cmdline_provenance <span class="im">as</span> cmdprov</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a><span class="kw">def</span> convert_pr_units(da):</span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>    <span class="co">"""Convert kg m-2 s-1 to mm day-1.</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Precipitation data</span></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>    </span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>    da.data <span class="op">=</span> da.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>    da.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>    </span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>    <span class="cf">assert</span> da.data.<span class="bu">min</span>() <span class="op">&gt;=</span> <span class="fl">0.0</span>, <span class="st">"There is at least one negative precipitation value"</span></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>    <span class="cf">assert</span> da.data.<span class="bu">max</span>() <span class="op">&lt;</span> <span class="dv">2000</span>, <span class="st">"There is a precipitation value/s &gt; 2000 mm/day"</span></span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>    </span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>    <span class="cf">return</span> da</span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a><span class="kw">def</span> apply_mask(darray, sftlf_file, realm):</span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a>    <span class="co">"""Mask ocean or land using a sftlf (land surface fraction) file.</span></span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a><span class="co">      da (xarray.DataArray): Data to mask</span></span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a><span class="co">      sftlf_file (str): Land surface fraction file</span></span>
<span id="cb16-35"><a href="#cb16-35" tabindex="-1"></a><span class="co">      realm (str): Realm to mask</span></span>
<span id="cb16-36"><a href="#cb16-36" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb16-37"><a href="#cb16-37" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-38"><a href="#cb16-38" tabindex="-1"></a>  </span>
<span id="cb16-39"><a href="#cb16-39" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(sftlf_file)</span>
<span id="cb16-40"><a href="#cb16-40" tabindex="-1"></a>    <span class="cf">if</span> realm.lower() <span class="op">==</span> <span class="st">'land'</span>:</span>
<span id="cb16-41"><a href="#cb16-41" tabindex="-1"></a>        masked_da <span class="op">=</span> da.where(ds[<span class="st">"sftlf"</span>].data <span class="op">&lt;</span> <span class="dv">50</span>)</span>
<span id="cb16-42"><a href="#cb16-42" tabindex="-1"></a>    <span class="cf">elif</span> realm.lower() <span class="op">==</span> <span class="st">'ocean'</span>:</span>
<span id="cb16-43"><a href="#cb16-43" tabindex="-1"></a>        masked_da <span class="op">=</span> da.where(ds[<span class="st">"sftlf"</span>].data <span class="op">&gt;</span> <span class="dv">50</span>)   </span>
<span id="cb16-44"><a href="#cb16-44" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb16-45"><a href="#cb16-45" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"""Mask realm is not 'ocean' or 'land'"""</span>)</span>
<span id="cb16-46"><a href="#cb16-46" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" tabindex="-1"></a>    <span class="cf">return</span> masked_da</span>
<span id="cb16-48"><a href="#cb16-48" tabindex="-1"></a></span>
<span id="cb16-49"><a href="#cb16-49" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" tabindex="-1"></a><span class="kw">def</span> create_plot(clim, model, season, gridlines<span class="op">=</span><span class="va">False</span>, levels<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb16-51"><a href="#cb16-51" tabindex="-1"></a>    <span class="co">"""Plot the precipitation climatology.</span></span>
<span id="cb16-52"><a href="#cb16-52" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-53"><a href="#cb16-53" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb16-54"><a href="#cb16-54" tabindex="-1"></a><span class="co">      clim (xarray.DataArray): Precipitation climatology data</span></span>
<span id="cb16-55"><a href="#cb16-55" tabindex="-1"></a><span class="co">      model (str): Name of the climate model</span></span>
<span id="cb16-56"><a href="#cb16-56" tabindex="-1"></a><span class="co">      season (str): Season</span></span>
<span id="cb16-57"><a href="#cb16-57" tabindex="-1"></a><span class="co">      </span></span>
<span id="cb16-58"><a href="#cb16-58" tabindex="-1"></a><span class="co">    Kwargs:</span></span>
<span id="cb16-59"><a href="#cb16-59" tabindex="-1"></a><span class="co">      gridlines (bool): Select whether to plot gridlines</span></span>
<span id="cb16-60"><a href="#cb16-60" tabindex="-1"></a><span class="co">      levels (list): Tick marks on the colorbar    </span></span>
<span id="cb16-61"><a href="#cb16-61" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-62"><a href="#cb16-62" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-63"><a href="#cb16-63" tabindex="-1"></a></span>
<span id="cb16-64"><a href="#cb16-64" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> levels:</span>
<span id="cb16-65"><a href="#cb16-65" tabindex="-1"></a>        levels <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="fl">13.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb16-66"><a href="#cb16-66" tabindex="-1"></a>        </span>
<span id="cb16-67"><a href="#cb16-67" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb16-68"><a href="#cb16-68" tabindex="-1"></a>    ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb16-69"><a href="#cb16-69" tabindex="-1"></a>    clim.sel(season<span class="op">=</span>season).plot.contourf(</span>
<span id="cb16-70"><a href="#cb16-70" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb16-71"><a href="#cb16-71" tabindex="-1"></a>        levels<span class="op">=</span>levels,</span>
<span id="cb16-72"><a href="#cb16-72" tabindex="-1"></a>        extend<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb16-73"><a href="#cb16-73" tabindex="-1"></a>        transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb16-74"><a href="#cb16-74" tabindex="-1"></a>        cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: clim.units},</span>
<span id="cb16-75"><a href="#cb16-75" tabindex="-1"></a>        cmap<span class="op">=</span>cmocean.cm.haline_r</span>
<span id="cb16-76"><a href="#cb16-76" tabindex="-1"></a>    )</span>
<span id="cb16-77"><a href="#cb16-77" tabindex="-1"></a>    ax.coastlines()</span>
<span id="cb16-78"><a href="#cb16-78" tabindex="-1"></a>    <span class="cf">if</span> gridlines:</span>
<span id="cb16-79"><a href="#cb16-79" tabindex="-1"></a>        plt.gca().gridlines()</span>
<span id="cb16-80"><a href="#cb16-80" tabindex="-1"></a>    </span>
<span id="cb16-81"><a href="#cb16-81" tabindex="-1"></a>    title <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss"> precipitation climatology (</span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb16-82"><a href="#cb16-82" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb16-83"><a href="#cb16-83" tabindex="-1"></a></span>
<span id="cb16-84"><a href="#cb16-84" tabindex="-1"></a></span>
<span id="cb16-85"><a href="#cb16-85" tabindex="-1"></a><span class="kw">def</span> get_log_and_key(pr_file, history_attr, plot_type):</span>
<span id="cb16-86"><a href="#cb16-86" tabindex="-1"></a>    <span class="co">"""Get key and command line log for image metadata.</span></span>
<span id="cb16-87"><a href="#cb16-87" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb16-88"><a href="#cb16-88" tabindex="-1"></a><span class="co">    Different image formats allow different metadata keys.</span></span>
<span id="cb16-89"><a href="#cb16-89" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb16-90"><a href="#cb16-90" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb16-91"><a href="#cb16-91" tabindex="-1"></a><span class="co">      pr_file (str): Input precipitation file</span></span>
<span id="cb16-92"><a href="#cb16-92" tabindex="-1"></a><span class="co">      history_attr (str): History attribute from pr_file</span></span>
<span id="cb16-93"><a href="#cb16-93" tabindex="-1"></a><span class="co">      plot_type (str): File format for output image</span></span>
<span id="cb16-94"><a href="#cb16-94" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb16-95"><a href="#cb16-95" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-96"><a href="#cb16-96" tabindex="-1"></a>    </span>
<span id="cb16-97"><a href="#cb16-97" tabindex="-1"></a>    valid_keys <span class="op">=</span> {<span class="st">"png"</span>: <span class="st">"History"</span>,</span>
<span id="cb16-98"><a href="#cb16-98" tabindex="-1"></a>                  <span class="st">"pdf"</span>: <span class="st">"Title"</span>,</span>
<span id="cb16-99"><a href="#cb16-99" tabindex="-1"></a>                  <span class="st">"svg"</span>: <span class="st">"Title"</span>,</span>
<span id="cb16-100"><a href="#cb16-100" tabindex="-1"></a>                  <span class="st">"eps"</span>: <span class="st">"Creator"</span>,</span>
<span id="cb16-101"><a href="#cb16-101" tabindex="-1"></a>                  <span class="st">"ps"</span> : <span class="st">"Creator"</span>,</span>
<span id="cb16-102"><a href="#cb16-102" tabindex="-1"></a>    }    </span>
<span id="cb16-103"><a href="#cb16-103" tabindex="-1"></a></span>
<span id="cb16-104"><a href="#cb16-104" tabindex="-1"></a>    <span class="cf">assert</span> plot_type <span class="kw">in</span> valid_keys.keys(), <span class="ss">f"Image format not one of: </span><span class="sc">{</span><span class="op">*</span>[<span class="op">*</span>valid_keys]<span class="sc">,}</span><span class="ss">"</span></span>
<span id="cb16-105"><a href="#cb16-105" tabindex="-1"></a>    log_key <span class="op">=</span> valid_keys[plot_type]</span>
<span id="cb16-106"><a href="#cb16-106" tabindex="-1"></a>    new_log <span class="op">=</span> cmdprov.new_log(infile_logs<span class="op">=</span>{pr_file: history_attr})</span>
<span id="cb16-107"><a href="#cb16-107" tabindex="-1"></a>    </span>
<span id="cb16-108"><a href="#cb16-108" tabindex="-1"></a>    <span class="cf">return</span> log_key, new_log</span>
<span id="cb16-109"><a href="#cb16-109" tabindex="-1"></a>   </span>
<span id="cb16-110"><a href="#cb16-110" tabindex="-1"></a></span>
<span id="cb16-111"><a href="#cb16-111" tabindex="-1"></a><span class="kw">def</span> main(inargs):</span>
<span id="cb16-112"><a href="#cb16-112" tabindex="-1"></a>    <span class="co">"""Run the program."""</span></span>
<span id="cb16-113"><a href="#cb16-113" tabindex="-1"></a></span>
<span id="cb16-114"><a href="#cb16-114" tabindex="-1"></a>    log_lev <span class="op">=</span> logging.INFO <span class="cf">if</span> inargs.verbose <span class="cf">else</span> logging.WARNING</span>
<span id="cb16-115"><a href="#cb16-115" tabindex="-1"></a>    logging.basicConfig(level<span class="op">=</span>log_lev, filename<span class="op">=</span>inargs.logfile)</span>
<span id="cb16-116"><a href="#cb16-116" tabindex="-1"></a></span>
<span id="cb16-117"><a href="#cb16-117" tabindex="-1"></a>    ds <span class="op">=</span> xr.open_dataset(inargs.pr_file)</span>
<span id="cb16-118"><a href="#cb16-118" tabindex="-1"></a>    </span>
<span id="cb16-119"><a href="#cb16-119" tabindex="-1"></a>    clim <span class="op">=</span> ds[<span class="st">"pr"</span>].groupby(<span class="st">"time.season"</span>).mean(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-120"><a href="#cb16-120" tabindex="-1"></a></span>
<span id="cb16-121"><a href="#cb16-121" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb16-122"><a href="#cb16-122" tabindex="-1"></a>        input_units <span class="op">=</span> clim.attrs[<span class="st">"units"</span>]</span>
<span id="cb16-123"><a href="#cb16-123" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyError</span>:</span>
<span id="cb16-124"><a href="#cb16-124" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="st">"Precipitation variable in </span><span class="sc">{inargs.pr_file}</span><span class="st"> must have a units attribute"</span>)</span>
<span id="cb16-125"><a href="#cb16-125" tabindex="-1"></a></span>
<span id="cb16-126"><a href="#cb16-126" tabindex="-1"></a>    <span class="cf">if</span> input_units <span class="op">==</span> <span class="st">"kg m-2 s-1"</span>:</span>
<span id="cb16-127"><a href="#cb16-127" tabindex="-1"></a>        clim <span class="op">=</span> convert_pr_units(clim)</span>
<span id="cb16-128"><a href="#cb16-128" tabindex="-1"></a>        logging.info(<span class="st">"Units converted from kg m-2 s-1 to mm/day"</span>)</span>
<span id="cb16-129"><a href="#cb16-129" tabindex="-1"></a>    <span class="cf">elif</span> input_units <span class="op">==</span> <span class="st">"mm/day"</span>:</span>
<span id="cb16-130"><a href="#cb16-130" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb16-131"><a href="#cb16-131" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb16-132"><a href="#cb16-132" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"""Input units are not 'kg m-2 s-1' or 'mm/day'"""</span>)</span>
<span id="cb16-133"><a href="#cb16-133" tabindex="-1"></a></span>
<span id="cb16-134"><a href="#cb16-134" tabindex="-1"></a>    <span class="cf">if</span> inargs.mask:</span>
<span id="cb16-135"><a href="#cb16-135" tabindex="-1"></a>        sftlf_file, realm <span class="op">=</span> inargs.mask</span>
<span id="cb16-136"><a href="#cb16-136" tabindex="-1"></a>        clim <span class="op">=</span> apply_mask(clim, sftlf_file, realm)</span>
<span id="cb16-137"><a href="#cb16-137" tabindex="-1"></a></span>
<span id="cb16-138"><a href="#cb16-138" tabindex="-1"></a>    create_plot(</span>
<span id="cb16-139"><a href="#cb16-139" tabindex="-1"></a>        clim,</span>
<span id="cb16-140"><a href="#cb16-140" tabindex="-1"></a>        ds.attrs[<span class="st">"source_id"</span>],</span>
<span id="cb16-141"><a href="#cb16-141" tabindex="-1"></a>        inargs.season,</span>
<span id="cb16-142"><a href="#cb16-142" tabindex="-1"></a>        gridlines<span class="op">=</span>inargs.gridlines,</span>
<span id="cb16-143"><a href="#cb16-143" tabindex="-1"></a>        levels<span class="op">=</span>inargs.cbar_levels,</span>
<span id="cb16-144"><a href="#cb16-144" tabindex="-1"></a>    )</span>
<span id="cb16-145"><a href="#cb16-145" tabindex="-1"></a>                </span>
<span id="cb16-146"><a href="#cb16-146" tabindex="-1"></a>    log_key, new_log <span class="op">=</span> get_log_and_key(</span>
<span id="cb16-147"><a href="#cb16-147" tabindex="-1"></a>        inargs.pr_file,</span>
<span id="cb16-148"><a href="#cb16-148" tabindex="-1"></a>        ds.attrs[<span class="st">"history"</span>],</span>
<span id="cb16-149"><a href="#cb16-149" tabindex="-1"></a>        inargs.output_file.split(<span class="st">'.'</span>)[<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb16-150"><a href="#cb16-150" tabindex="-1"></a>    )</span>
<span id="cb16-151"><a href="#cb16-151" tabindex="-1"></a>    plt.savefig(</span>
<span id="cb16-152"><a href="#cb16-152" tabindex="-1"></a>        inargs.output_file,</span>
<span id="cb16-153"><a href="#cb16-153" tabindex="-1"></a>        metadata<span class="op">=</span>{log_key: new_log},</span>
<span id="cb16-154"><a href="#cb16-154" tabindex="-1"></a>        dpi<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb16-155"><a href="#cb16-155" tabindex="-1"></a>        bbox_inches<span class="op">=</span><span class="st">"tight"</span>,</span>
<span id="cb16-156"><a href="#cb16-156" tabindex="-1"></a>        facecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb16-157"><a href="#cb16-157" tabindex="-1"></a>    )</span>
<span id="cb16-158"><a href="#cb16-158" tabindex="-1"></a></span>
<span id="cb16-159"><a href="#cb16-159" tabindex="-1"></a></span>
<span id="cb16-160"><a href="#cb16-160" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb16-161"><a href="#cb16-161" tabindex="-1"></a>    description <span class="op">=</span> <span class="st">"Plot the precipitation climatology for a given season."</span></span>
<span id="cb16-162"><a href="#cb16-162" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span>description)</span>
<span id="cb16-163"><a href="#cb16-163" tabindex="-1"></a>    </span>
<span id="cb16-164"><a href="#cb16-164" tabindex="-1"></a>    parser.add_argument(<span class="st">"pr_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Precipitation data file"</span>)</span>
<span id="cb16-165"><a href="#cb16-165" tabindex="-1"></a>    parser.add_argument(<span class="st">"season"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Season to plot"</span>)</span>
<span id="cb16-166"><a href="#cb16-166" tabindex="-1"></a>    parser.add_argument(<span class="st">"output_file"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Output file name"</span>)</span>
<span id="cb16-167"><a href="#cb16-167" tabindex="-1"></a></span>
<span id="cb16-168"><a href="#cb16-168" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb16-169"><a href="#cb16-169" tabindex="-1"></a>        <span class="st">"--gridlines"</span>,</span>
<span id="cb16-170"><a href="#cb16-170" tabindex="-1"></a>        action<span class="op">=</span><span class="st">"store_true"</span>,</span>
<span id="cb16-171"><a href="#cb16-171" tabindex="-1"></a>        default<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb16-172"><a href="#cb16-172" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Include gridlines on the plot"</span>,</span>
<span id="cb16-173"><a href="#cb16-173" tabindex="-1"></a>    )</span>
<span id="cb16-174"><a href="#cb16-174" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb16-175"><a href="#cb16-175" tabindex="-1"></a>        <span class="st">"--cbar_levels"</span>,</span>
<span id="cb16-176"><a href="#cb16-176" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>,</span>
<span id="cb16-177"><a href="#cb16-177" tabindex="-1"></a>        nargs<span class="op">=</span><span class="st">"*"</span>,</span>
<span id="cb16-178"><a href="#cb16-178" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb16-179"><a href="#cb16-179" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"list of levels / tick marks to appear on the colorbar"</span>,</span>
<span id="cb16-180"><a href="#cb16-180" tabindex="-1"></a>    )</span>
<span id="cb16-181"><a href="#cb16-181" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb16-182"><a href="#cb16-182" tabindex="-1"></a>        <span class="st">"--mask"</span>,</span>
<span id="cb16-183"><a href="#cb16-183" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb16-184"><a href="#cb16-184" tabindex="-1"></a>        nargs<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb16-185"><a href="#cb16-185" tabindex="-1"></a>        metavar<span class="op">=</span>(<span class="st">"SFTLF_FILE"</span>, <span class="st">"REALM"</span>),</span>
<span id="cb16-186"><a href="#cb16-186" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb16-187"><a href="#cb16-187" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"""Provide sftlf file and realm to mask ('land' or 'ocean')"""</span>,</span>
<span id="cb16-188"><a href="#cb16-188" tabindex="-1"></a>    )</span>
<span id="cb16-189"><a href="#cb16-189" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb16-190"><a href="#cb16-190" tabindex="-1"></a>        <span class="st">"-v"</span>,</span>
<span id="cb16-191"><a href="#cb16-191" tabindex="-1"></a>        <span class="st">"--verbose"</span>,</span>
<span id="cb16-192"><a href="#cb16-192" tabindex="-1"></a>        action<span class="op">=</span><span class="st">"store_true"</span>,</span>
<span id="cb16-193"><a href="#cb16-193" tabindex="-1"></a>        default<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb16-194"><a href="#cb16-194" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Change the minimum logging reporting level from WARNING (default) to DEBUG"</span>,</span>
<span id="cb16-195"><a href="#cb16-195" tabindex="-1"></a>    )</span>
<span id="cb16-196"><a href="#cb16-196" tabindex="-1"></a>    parser.add_argument(</span>
<span id="cb16-197"><a href="#cb16-197" tabindex="-1"></a>        <span class="st">"--logfile"</span>,</span>
<span id="cb16-198"><a href="#cb16-198" tabindex="-1"></a>        <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb16-199"><a href="#cb16-199" tabindex="-1"></a>        default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb16-200"><a href="#cb16-200" tabindex="-1"></a>        <span class="bu">help</span><span class="op">=</span><span class="st">"Name of log file (by default logging information is printed to the screen)"</span>,</span>
<span id="cb16-201"><a href="#cb16-201" tabindex="-1"></a>    )</span>
<span id="cb16-202"><a href="#cb16-202" tabindex="-1"></a></span>
<span id="cb16-203"><a href="#cb16-203" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb16-204"><a href="#cb16-204" tabindex="-1"></a>    main(args)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>It is possible (in only a few lines of code) to record the
provenance of a data file or image.</li>
</ul>
</div>
</div>
</div></section><section id="aio-10-large-data"><p>Content from <a href="10-large-data.html">Large data</a></p>
<hr>
<p>Last updated on 2024-07-25 |

        <a href="https://github.com/fishtree-attempt/python-aos-lesson/edit/main/episodes/10-large-data.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I work with multiple CMIP files that won’t fit in
memory?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Inspect netCDF chunking.</li>
<li>Import the dask library and start a client with parallel
workers.</li>
<li>Calculate and plot the maximum daily precipitation for a high
resolution model.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<p>So far we’ve been working with small, individual data files that can
be comfortably read into memory on a modern laptop. What if we wanted to
process a larger dataset that consists of many files and/or much larger
file sizes? For instance, let’s say the next step in our global
precipitation analysis is to plot the daily maximum precipitation over
the 1850-2014 period for the high resolution CNRM-CM6-1-HR model.</p>
<div id="data-download" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="data-download" class="callout-inner">
<h3 class="callout-title">Data download<a class="anchor" aria-label="anchor" href="#data-download"></a>
</h3>
<div class="callout-content">
<p>Instructors teaching this lesson can download the CNRM-CM6-1-HR daily
precipitation data from the Earth System Grid Federation (ESGF). See the
<a href="https://carpentries-lab.github.io/python-aos-lesson/guide/index.html" class="external-link">instructor
notes</a> for details. Since it is a very large download (45 GB),
learners are not expected to download the data. (None of the exercises
at the end of the lesson require downloading the data.)</p>
</div>
</div>
</div>
<p>At the Unix shell, we can inspect the dataset and see that the daily
maximum precipitation data for the 1850-2014 period has been broken up
into 25-year chunks and spread across seven netCDF files, most of which
are 6.7 GB in size.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">$</span> ls <span class="at">-lh</span> data/pr_day<span class="pp">*</span>.nc</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>-rw-r-----  1 irving  staff   6.7G 26 Jan 12:09 pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_18500101-18741231.nc
-rw-r-----  1 irving  staff   6.7G 26 Jan 13:14 pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_18750101-18991231.nc
-rw-r-----  1 irving  staff   6.7G 26 Jan 14:17 pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_19000101-19241231.nc
-rw-r-----  1 irving  staff   6.7G 26 Jan 15:20 pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_19250101-19491231.nc
-rw-r-----  1 irving  staff   6.7G 26 Jan 16:24 pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_19500101-19741231.nc
-rw-r-----  1 irving  staff   6.7G 26 Jan 17:27 pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_19750101-19991231.nc
-rw-r-----  1 irving  staff   4.0G 26 Jan 18:05 pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_20000101-20141231.nc</code></pre>
</div>
<p>In order to work with these files, we can use <code>xarray</code> to
open a “multifile” dataset as though it were a single file. Our first
step is to open a new Jupyter notebook and import a library with a
rather unfortunate name.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">import</span> glob</span></code></pre>
</div>
<p>The <code>glob</code> library contains a single function, also called
<code>glob</code>, that finds files whose names match a pattern. We
provide those patterns as strings: the character <code>*</code> matches
zero or more characters, while <code>?</code> matches any one character,
just like at the Unix shell.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>pr_files <span class="op">=</span> glob.glob(<span class="st">"data/pr_day*.nc"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>pr_files.sort()</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="bu">print</span>(pr_files)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>['/Users/irving/Desktop/data-carpentry/data/pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_18500101-18741231.nc',
 '/Users/irving/Desktop/data-carpentry/data/pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_18750101-18991231.nc',
 '/Users/irving/Desktop/data-carpentry/data/pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_19000101-19241231.nc',
 '/Users/irving/Desktop/data-carpentry/data/pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_19250101-19491231.nc',
 '/Users/irving/Desktop/data-carpentry/data/pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_19500101-19741231.nc',
 '/Users/irving/Desktop/data-carpentry/data/pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_19750101-19991231.nc',
 '/Users/irving/Desktop/data-carpentry/data/pr_day_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_20000101-20141231.nc']</code></pre>
</div>
<p>Recall that when we first open data in <code>xarray</code> it simply
(“lazily”) loads the metadata associated with the data and shows summary
information about the contents of the dataset (i.e. it doesn’t read the
actual data into memory). This may take a little time for a large
multifile dataset.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>ds <span class="op">=</span> xr.open_mfdataset(pr_files, chunks<span class="op">=</span>{<span class="st">"time"</span>: <span class="st">"500MB"</span>})</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="bu">print</span>(ds)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;xarray.Dataset&gt;
Dimensions:      (axis_nbounds: 2, lat: 360, lon: 720, time: 60265)
Coordinates:
  * lat          (lat) float64 -89.62 -89.12 -88.62 -88.13 ... 88.62 89.12 89.62
  * lon          (lon) float64 0.0 0.5 1.0 1.5 2.0 ... 358.0 358.5 359.0 359.5
  * time         (time) datetime64[ns] 1850-01-01T12:00:00 ... 2014-12-31T12:...
Dimensions without coordinates: axis_nbounds
Data variables:
    time_bounds  (time, axis_nbounds) datetime64[ns] dask.array&lt;chunksize=(9131, 2), meta=np.ndarray&gt;
    pr           (time, lat, lon) float32 dask.array&lt;chunksize=(397, 360, 720), meta=np.ndarray&gt;
Attributes:
    Conventions:            CF-1.7 CMIP-6.2
    creation_date:          2019-05-23T12:33:53Z
    description:            CMIP6 historical
    title:                  CNRM-CM6-1-HR model output prepared for CMIP6 and...
    activity_id:            CMIP
    contact:                contact.cmip@meteo.fr
    data_specs_version:     01.00.21
    dr2xml_version:         1.16
    experiment_id:          historical
    experiment:             all-forcing simulation of the recent past
    external_variables:     areacella
    forcing_index:          2
    frequency:              day
    further_info_url:       https://furtherinfo.es-doc.org/CMIP6.CNRM-CERFACS...
    grid:                   data regridded to a 359 gaussian grid (360x720 la...
    grid_label:             gr
    nominal_resolution:     50 km
    initialization_index:   1
    institution_id:         CNRM-CERFACS
    institution:            CNRM (Centre National de Recherches Meteorologiqu...
    license:                CMIP6 model data produced by CNRM-CERFACS is lice...
    mip_era:                CMIP6
    parent_experiment_id:   p i C o n t r o l
    parent_mip_era:         CMIP6
    parent_activity_id:     C M I P
    parent_source_id:       CNRM-CM6-1-HR
    parent_time_units:      days since 1850-01-01 00:00:00
    parent_variant_label:   r1i1p1f2
    branch_method:          standard
    branch_time_in_parent:  0.0
    branch_time_in_child:   0.0
    physics_index:          1
    product:                model-output
    realization_index:      1
    realm:                  atmos
    references:             http://www.umr-cnrm.fr/cmip6/references
    source:                 CNRM-CM6-1-HR (2017):  aerosol: prescribed monthl...
    source_id:              CNRM-CM6-1-HR
    source_type:            AOGCM
    sub_experiment_id:      none
    sub_experiment:         none
    table_id:               day
    variable_id:            pr
    variant_label:          r1i1p1f2
    EXPID:                  CNRM-CM6-1-HR_historical_r1i1p1f2
    CMIP6_CV_version:       cv=6.2.3.0-7-g2019642
    dr2xml_md5sum:          45d4369d889ddfb8149d771d8625e9ec
    xios_commit:            1442-shuffle
    nemo_gelato_commit:     84a9e3f161dade7_8250e198106a168
    arpege_minor_version:   6.3.3
    history:                none
    tracking_id:            hdl:21.14100/223fa794-73fe-4bb5-9209-8ff910f7dc40</code></pre>
</div>
<p>We can see that our <code>ds</code> object is an
<code>xarray.Dataset</code>, but notice now that each variable has type
<code>dask.array</code> with a <code>chunksize</code> attribute. Dask
will access the data chunk-by-chunk (rather than all at once), which is
fortunate because at 45GB the full size of our dataset is much larger
than the available RAM on our laptop (17GB in this example). Dask can
also distribute chunks across multiple cores if we ask it to
(i.e. parallel processing).</p>
<p>So how big should our chunks be? As a general rule they need to be
small enough to fit comfortably in memory (because multiple chunks can
be in memory at once), but large enough to avoid the time cost
associated with asking Dask to manage/schedule lots of little chunks.
The <a href="https://docs.dask.org/en/latest/array-chunks.html" class="external-link">Dask
documentation</a> suggests that chunk sizes between 10MB-1GB are common,
so we’ve set the chunk size to 500MB in this example. Since our netCDF
files are chunked by time, we’ve specified that the 500MB Dask chunks
should also be along that axis. Performance would suffer dramatically if
our Dask chunks weren’t aligned with our netCDF chunks.</p>
<p>We can have the Jupyter notebook display the size and shape of our
chunks, just to make sure they are indeed 500MB.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>ds[<span class="st">'pr'</span>].data</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>          Array                 Chunk
Bytes     62.48 GB              499.74 MB
Shape     (60265, 360, 720)     (482, 360, 720)
Count     307 Tasks             150 Chunks
Type      float32               numpy.ndarray</code></pre>
</div>
<p>Now that we understand the chunking information contained in the
metadata, let’s go ahead and calculate the daily maximum
precipitation.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>pr_max <span class="op">=</span> ds[<span class="st">"pr"</span>].<span class="bu">max</span>(<span class="st">"time"</span>, keep_attrs<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="bu">print</span>(pr_max)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>&lt;xarray.DataArray 'pr' (lat: 360, lon: 720)&gt;
dask.array&lt;nanmax-aggregate, shape=(360, 720), dtype=float32, chunksize=(360, 720), chunktype=numpy.ndarray&gt;
Coordinates:
  * lat      (lat) float64 -89.62 -89.12 -88.62 -88.13 ... 88.62 89.12 89.62
  * lon      (lon) float64 0.0 0.5 1.0 1.5 2.0 ... 357.5 358.0 358.5 359.0 359.5
Attributes:
    long_name:           Precipitation
    units:               kg m-2 s-1
    online_operation:    average
    cell_methods:        area: time: mean
    interval_operation:  900 s
    interval_write:      1 d
    standard_name:       precipitation_flux
    description:         at surface; includes both liquid and solid phases fr...
    history:             none
    cell_measures:       area: areacella</code></pre>
</div>
<p>It seems like the calculation happened instataneously, but it’s
actually just another “lazy” feature of <code>xarray</code>. It’s
showing us what the output of the calculation would look like (i.e. a
360 by 720 array), but <code>xarray</code> won’t actually do the
computation until the data is needed (e.g. to create a plot or write to
a netCDF file).</p>
<p>To force <code>xarray</code> to do the computation we can use
<code>.compute()</code> with the <code>%%time</code> Jupyter notebook
command to record how long it takes:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>pr_max_done <span class="op">=</span> pr_max.compute()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>CPU times: user 4min 1s, sys: 54.2 s, total: 4min 55s
Wall time: 3min 44s</code></pre>
</div>
<p>By processing the data chunk-by-chunk, we’ve avoided the memory error
we would have generated had we tried to handle the whole dataset at
once. A completion time of 3 minutes and 44 seconds isn’t too bad, but
that was only using one core. We can try and speed things up by using a
<code>dask</code> “client” to run the calculation in parallel across
multiple cores:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>client <span class="op">=</span> Client()</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>client</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Client                                    Cluster
Scheduler: tcp://127.0.0.1:59152          Workers: 4
Dashboard: http://127.0.0.1:8787/status   Cores: 4
                                          Memory: 17.18 GB</code></pre>
</div>
<p>(Click on the dashboard link to watch what’s happening on each
core.)</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>pr_max_done <span class="op">=</span> pr_max.compute()</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>CPU times: user 10.2 s, sys: 1.12 s, total: 11.3 s
Wall time: 2min 33s</code></pre>
</div>
<p>By distributing the calculation across all four cores the processing
time has dropped to 2 minutes and 33 seconds. It’s faster than, but not
a quarter of, the original 3 minutes and 44 seconds because there’s a
time cost associated with setting up and coordinating jobs across all
the cores.</p>
<div id="parallel-isnt-always-best" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="parallel-isnt-always-best" class="callout-inner">
<h3 class="callout-title">Parallel isn’t always best<a class="anchor" aria-label="anchor" href="#parallel-isnt-always-best"></a>
</h3>
<div class="callout-content">
<p>For smaller or very complex data processing tasks, the time
associated with setting up and coordinating jobs across multiple cores
can mean it takes longer to run in parallel than on just one core.</p>
</div>
</div>
</div>
<p>Now that we’ve computed the daily maximum precipitation, we can go
ahead and plot it:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="im">import</span> cmocean</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>pr_max_done.data <span class="op">=</span> pr_max_done.data <span class="op">*</span> <span class="dv">86400</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>pr_max_done.attrs[<span class="st">"units"</span>] <span class="op">=</span> <span class="st">"mm/day"</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>[<span class="dv">12</span>,<span class="dv">5</span>])</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span>ccrs.PlateCarree(central_longitude<span class="op">=</span><span class="dv">180</span>))</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>pr_max_done.plot.contourf(</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>    levels<span class="op">=</span>np.arange(<span class="dv">0</span>, <span class="dv">450</span>, <span class="dv">50</span>),</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>    extend<span class="op">=</span><span class="st">"max"</span>,</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>    transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>    cbar_kwargs<span class="op">=</span>{<span class="st">"label"</span>: pr_max.units},</span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>    cmap<span class="op">=</span>cmocean.cm.haline_r,</span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a>)</span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a>ax.coastlines()</span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a>model <span class="op">=</span> ds.attrs[<span class="st">"source_id"</span>]</span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a>title <span class="op">=</span> <span class="ss">f"Daily maximum precipitation, 1850-2014 (</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a>plt.title(title)</span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a>plt.show()</span></code></pre>
</div>
<figure><img src="fig/10-pr-max.png" alt="Daily maximum precipitation" class="figure mx-auto d-block"></figure><div id="writing-your-own-dask-aware-functions" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="writing-your-own-dask-aware-functions" class="callout-inner">
<h3 class="callout-title">Writing your own Dask-aware functions<a class="anchor" aria-label="anchor" href="#writing-your-own-dask-aware-functions"></a>
</h3>
<div class="callout-content">
<p>So far leveraging Dask for our large data computations has been
relatively simple, because almost all of <code>xarray</code>’s built-in
operations (like <code>max</code>) work on Dask arrays.</p>
<p>If we wanted to chunk and parallelise code involving operations that
aren’t built into <code>xarray</code> (e.g. an interpolation routine
from the SciPy library) we’d first need to use the
<code>apply_ufunc</code> or <code>map_blocks</code> function to make
those operations “Dask-aware”. The <a href="https://xarray-contrib.github.io/xarray-tutorial/scipy-tutorial/06_xarray_and_dask.html#Automatic-parallelization-with-apply_ufunc-and-map_blocks" class="external-link">xarray
tutorial</a> from SciPy 2020 explains how to do this.</p>
</div>
</div>
</div>
<div id="alternatives-to-dask" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="alternatives-to-dask" class="callout-inner">
<h3 class="callout-title">Alternatives to Dask<a class="anchor" aria-label="anchor" href="#alternatives-to-dask"></a>
</h3>
<div class="callout-content">
<p>While <code>dask</code> can be a good option for working with large
data, it’s not always the best choice. For instance, in this lesson
we’ve talked about the time cost associated with setting up and
coordinating jobs across multiple cores, and the fact that it can take a
bit of time and effort to make a function Dask-aware.</p>
<p>What other options/tactics do you have when working with a large,
multi-file dataset? What are the pros and cons of these options?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>Other options include writing a loop to process each netCDF file one
at a time or a series of sub-regions one at a time.</p>
<p>By breaking the data processing down like this you might avoid the
need to make your function/s Dask-aware. If the loop only involves tens
(as opposed to hundreds) files/regions, the loop might also not be too
slow. However, using Dask is neater and more scalable, because the code
you write looks essentially the same regardless of whether you’re
running the code on a powerful supercomputer or a personal laptop.</p>
</div>
</div>
</div>
</div>
<div id="find-out-what-youre-working-with" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="find-out-what-youre-working-with" class="callout-inner">
<h3 class="callout-title">Find out what you’re working with<a class="anchor" aria-label="anchor" href="#find-out-what-youre-working-with"></a>
</h3>
<div class="callout-content">
<p>Setup a Dask client in your Jupyter notebook. How many cores do you
have available and how much memory?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>Run the following two commands in your notebook to setup the client
and then type <code>client</code> to view the display of
information:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>client <span class="op">=</span> Client()</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>client</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="applying-this-to-your-own-work" class="callout discussion">
<div class="callout-square">
<i class="callout-icon" data-feather="message-circle"></i>
</div>
<div id="applying-this-to-your-own-work" class="callout-inner">
<h3 class="callout-title">Applying this to your own work<a class="anchor" aria-label="anchor" href="#applying-this-to-your-own-work"></a>
</h3>
<div class="callout-content">
<p>In your own research, are there any data processing tasks that could
benefit from chunking and/or parallelisation? If so, how would you
implement it? What size would your chunks be and along what axis? Are
all the operations involved already Dask-aware?</p>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Libraries such as dask and xarray can make loading, processing and
visualising netCDF data much easier.</li>
<li>Dask can speed up processing through parallelism but care may be
needed particularly with data chunking.</li>
</ul>
</div>
</div>
</div></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/fishtree-attempt/python-aos-lesson/edit/main/README.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/fishtree-attempt/python-aos-lesson/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/fishtree-attempt/python-aos-lesson/" class="external-link">Source</a></p>
				<p><a href="https://github.com/fishtree-attempt/python-aos-lesson/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:irving.damien@gmail.com">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.5" class="external-link">sandpaper (0.16.5)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.6" class="external-link">pegboard (0.7.6)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.3" class="external-link">varnish (1.0.3)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://fishtree-attempt.github.io/python-aos-lesson/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://fishtree-attempt.github.io/python-aos-lesson/aio.html",
  "identifier": "https://fishtree-attempt.github.io/python-aos-lesson/aio.html",
  "dateCreated": "2018-01-15",
  "dateModified": "2024-07-25",
  "datePublished": "2024-07-25"
}

  </script><script>
		feather.replace();
	</script>
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

